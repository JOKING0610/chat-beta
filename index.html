<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>JokingChat</title>
    <link rel="icon" href="https://img.cdn1.vip/i/692d86ce365ce_1764591310.webp" type="image/webp">
    <link rel="shortcut icon" href="https://img.cdn1.vip/i/692d86ce365ce_1764591310.webp" type="image/webp">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.5"></script>

    <style>
        :root {
            --text-primary: #333333;
            --text-secondary: #555555;
            --text-muted: #888888;
            --line-height-normal: 1.6;
            --line-height-tight: 1.4;
            --line-height-relaxed: 1.8;
            --btn-padding-vertical: 0.75em;
            --btn-padding-horizontal: 1.5em;
            --btn-icon-size: 1.5em;
            --btn-border-radius: 0.5em;
            --btn-min-width: 4em;
            --btn-height: 2.5em;
            --body-font-size: 14px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-primary);
        }
        
        button, a, .btn, .header-btn, .send-btn {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        input, textarea, select {
            min-height: 44px;
            font-size: 16px; 
        }
        html {
            font-size: var(--body-font-size);
            line-height: var(--line-height-normal);
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            -ms-text-size-adjust: none;
            text-size-adjust: none;
            font-weight: var(--font-weight-normal);
        }
        body, p, h1, h2, h3, h4, h5, h6, 
        div, span, a, button, input, textarea, 
        label, select, option {
            font-family: inherit;
            line-height: inherit;
            font-size: inherit;
            color: inherit;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-tight);
            margin-bottom: 0.5em;
        }
        p {
            margin-bottom: 1em;
            line-height: var(--line-height-relaxed);
        }
        @media (max-width: 320px) {
            :root {
                --max-font-size: 14px;
                --max-heading-size: 18px;
                --max-large-text: 16px;
                --max-small-text: 12px;
            }
            
            html{font-size:var(--body-font-size)}
            .auth-container{padding:15px !important}
            .form-input, .auth-btn{min-height:44px !important}
            .message{padding:10px !important;max-width:95% !important}
            .chat-messages{padding:10px !important;gap:10px !important}
            .chat-input-container{padding:10px !important;gap:6px !important}
            
            :root {
                --max-small-text: 12px;
                --line-height-normal: 1.5;
                --line-height-tight: 1.3;
                --line-height-relaxed: 1.7;
                --font-weight-normal: 400;
                --font-weight-medium: 500;
                --font-weight-semibold: 600;
            }
            .auth-container {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            .loading-spinner {
                border: 3px solid #f3f3f3;
                border-top: 3px solid #4a6ee0;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            @media (max-width: 768px) {
                .auth-container {
                    padding: 20px;
                    margin: 10px;
                }
            }
            .form-group {
                margin-bottom: 1rem;
            }

            .form-input {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 16px;
            }
            .auth-btn {
                background: #4a6ee0;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                transition: background 0.3s;
            }

            .auth-btn:hover {
                background: #3a5ed0;
            }

            .auth-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            * {
                text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.05);
                letter-spacing: -0.01em;
            }
            
            html {
                font-size: var(--body-font-size);
            }
        }

        @media (min-width: 321px) and (max-width: 767px) {
            :root {
                --max-font-size: 16px;
                --max-heading-size: 20px;
                --max-large-text: 18px;
                --max-small-text: 14px;
                --line-height-normal: 1.55;
                --line-height-tight: 1.35;
                --line-height-relaxed: 1.75;
            }
            
            * {
                text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.03);
                letter-spacing: 0;
            }
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            :root {
                --max-font-size: 18px;
                --max-heading-size: 22px;
                --max-large-text: 19px;
                --max-small-text: 15px;
                --line-height-normal: 1.6;
                --line-height-tight: 1.4;
                --line-height-relaxed: 1.8;
                --font-weight-normal: 400;
                --font-weight-medium: 500;
                --font-weight-semibold: 600;
            }
        }
        
        @media (min-width: 1024px) {
            :root {
                --max-font-size: 16px;
                --max-heading-size: 24px;
                --max-large-text: 20px;
                --max-small-text: 14px;
                --line-height-normal: 1.65;
                --line-height-tight: 1.45;
                --line-height-relaxed: 1.85;
                --font-weight-normal: 300;
                --font-weight-medium: 500;
                --font-weight-semibold: 600;
                --font-weight-bold: 700;
            }
            @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
                * {
                    -webkit-font-smoothing: antialiased;
                    text-shadow: 0 0 1px rgba(0, 0, 0, 0.1);
                    letter-spacing: 0.01em;
                }
            }
        }
        @media (max-width: 1024px) {
            .auth-container {
                width: clamp(300px, 95vw, 100%);
                padding: clamp(25px, 6vw, 35px);
            }
        }
        
        @media (max-width: 768px) {
            .auth-container {
                width: 100%;
                height: 100vh;
                max-width: 100vw;
                border-radius: 0;
                padding: clamp(20px, 5vw, 30px);
                box-shadow: none;
            }
            
            body {
                background: white;
                overflow: hidden;
            }
            
            .container {
                height: 100vh;
                width: 100%;
            }
        }
        @media (max-width: 480px) {
            .auth-container {
                padding: clamp(16px, 4vw, 24px);
            }
        
            .auth-container .form-input {
                padding: 14px 44px;
            }
            
            .auth-btn {
                height: 48px;
                padding: 14px;
            }
        }
        
        @media (prefers-contrast: high) {
            .auth-container {
                border: 1px solid currentColor;
                box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
            }
            
            .auth-container .form-input:focus {
                border-width: 3px;
                box-shadow: 0 0 0 3px rgba(74, 110, 224, 0.3);
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        .brand-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 1rem;
        }
        
        .logo-icon {
            font-size: 3rem;
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .brand-tagline {
            font-size: 1.1rem;
            color: #718096;
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        
        .loading-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .pulse-loader {
            display: flex;
            gap: 8px;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: pulse 1.4s ease-in-out infinite both;
        }
        
        .pulse-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .pulse-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .modern-progress-container {
            width: 100%;
            margin-bottom: 1.5rem;
        }
        
        .progress-track {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 3px;
            position: relative;
            transition: width 0.3s ease;
        }
        
        .progress-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: progressGlow 2s ease-in-out infinite;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-steps {
            display: flex;
            gap: 8px;
        }
        
        .step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e0;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: #667eea;
            transform: scale(1.2);
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes progressGlow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .modern-auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .modern-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 1rem;
        }
        
        .modern-logo-icon {
            font-size: 2.5rem;
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        .modern-logo-text {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .modern-auth-title {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .auth-greeting {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .auth-subtitle {
            font-size: 1rem;
            color: #718096;
            font-weight: 400;
        }
        
        .modern-auth-tabs {
            display: flex;
            background: #f7fafc;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 2rem;
        }
        
        .modern-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #718096;
        }
        
        .modern-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        
        .tab-icon {
            font-size: 1.1rem;
        }
        
        .modern-auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .modern-form-group {
            position: relative;
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .input-icon {
            position: absolute;
            left: 16px;
            font-size: 1.2rem;
            z-index: 2;
            color: #a0aec0;
        }
        
        .modern-form-input {
            width: 100%;
            height: 56px;
            padding: 0 52px 0 48px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .modern-form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modern-form-input::placeholder {
            color: #a0aec0;
        }
        
        .input-underline {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: #667eea;
            transition: width 0.3s ease;
        }
        
        .modern-form-input:focus ~ .input-underline {
            width: 100%;
        }
        
        .modern-password-toggle {
            position: absolute;
            right: 16px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        
        .modern-password-toggle:hover {
            background: #f7fafc;
        }
        
        .toggle-icon {
            font-size: 1.2rem;
            color: #a0aec0;
        }
        
        .modern-form-error {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 4px;
            min-height: 20px;
        }
        
        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -0.5rem 0;
        }
        

        
        .modern-auth-btn {
            width: 100%;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .modern-auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .modern-auth-btn:active {
            transform: translateY(0);
        }
        
        .btn-text {
            transition: opacity 0.3s ease;
        }
        
        .btn-loader {
            display: flex;
            gap: 4px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .loader-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: loaderPulse 1.4s ease-in-out infinite both;
        }
        
        .loader-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loader-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .social-login {
            margin-top: 1.5rem;
        }
        
        .divider {
            position: relative;
            text-align: center;
            margin: 1.5rem 0;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e2e8f0;
        }
        
        .divider-text {
            background: white;
            padding: 0 1rem;
            color: #718096;
            font-size: 0.875rem;
        }
        
        .social-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .social-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .social-btn:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .login-prompt {
            text-align: center;
            font-size: 0.875rem;
            color: #718096;
            margin-top: 1rem;
        }
        
        .login-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .login-link:hover {
            text-decoration: underline;
        }
        
        .modern-auth-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.875rem;
            text-align: center;
        }
        
        .modern-auth-message.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .modern-auth-message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
        
        @keyframes loaderPulse {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        body{background:#ffffff;height:100vh;overflow:hidden}
        .container{display:flex;width:100%;height:100vh}
        :root {
            --auth-container-width: clamp(300px, 90vw, 400px);
            --auth-container-padding: clamp(30px, 8vw, 40px);
            --auth-container-radius: clamp(12px, 3vw, 20px);
            --border-color: #e0e5ec;
            --border-hover: #cbd5e0;
            --background-secondary: #ffffff;
            --background-hover: #f7fafc;
            --background-disabled: #edf2f7;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-disabled: #a0aec0;
            --error-color: #e53e3e;
        }
        
        .auth-container{background:white;box-shadow:none;overflow:hidden;transition:all 0.3s ease;animation: containerFadeIn 0.6s ease-out;user-select:none;}        
        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .chat-container{background:white;box-shadow:none;border:none;overflow:auto}
        .auth-container{width:100%;max-width:100%;margin:auto;border-radius:0;border:none;padding:0 var(--auth-container-padding);min-height:480px;height:100vh;display:flex;flex-direction:column;justify-content:space-between;box-sizing:border-box}
        .chat-container{flex:1;display:flex;flex-direction:column;width:100%}
        .chat-header{background:#f8f9fa;color:#333333;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;box-shadow:none;border:none;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:12px}
.header-right{display:flex;align-items:center}
        .chat-header h1{font-size:clamp(1.2rem, 2vw, var(--max-large-text));font-weight:600;display:flex;align-items:center;gap:10px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
        .user-info{display:flex;align-items:center;gap:12px}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.1rem;background-size:cover;background-position:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer;transition:transform 0.2s ease;}
.user-avatar:hover{transform:scale(1.05);}

/* 头像查看器样式 */
.avatar-viewer{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;display:flex;align-items:center;justify-content:center;}
        .avatar-viewer-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:transparent;}
        .avatar-viewer-content{position:relative;z-index:1001;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;}
        .avatar-viewer-controls{position:absolute;top:20px;right:20px;display:flex;gap:10px;background:rgba(0,0,0,0.5);padding:10px;border-radius:25px;z-index:1002;}

.avatar-control-btn{width:44px;height:44px;border-radius:50%;border:none;background:rgba(255,255,255,0.2);color:white;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;user-select:none;}

.avatar-control-btn:hover{background:rgba(255,255,255,0.3);transform:scale(1.1);}

.avatar-close-btn{background:rgba(255,0,0,0.6);}

.avatar-close-btn:hover{background:rgba(255,0,0,0.8);}

.avatar-viewer-image-container{width:80%;height:auto;max-width:90vw;max-height:90vh;display:flex;align-items:center;justify-content:center;position:relative;}

.avatar-viewer-image{width:auto;height:auto;max-width:100%;max-height:100%;border-radius:10px;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:10rem;background-size:contain;background-position:center;background-repeat:no-repeat;transform-origin:center center;transition:transform 0.3s ease;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%) scale(1);user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-user-drag:none;cursor:grab;}

.avatar-viewer-image.scaled{transform:translate(-50%, -50%) scale(var(--current-zoom, 1));}

@media (max-width:768px){
    .avatar-viewer-image-container{width:95%;height:70%;}
    .avatar-viewer-image{font-size:8rem;}
    .avatar-viewer-controls{gap:5px;padding:8px;}
    .avatar-control-btn{width:40px;height:40px;font-size:1rem;user-select:none;}
}
        .header-buttons{display:flex;gap:10px}
        .header-btn{padding:var(--btn-padding-vertical);background:#e0e0e0;color:#333333;border:none;border-radius:var(--btn-border-radius);cursor:pointer;font-size:clamp(0.85rem, 0.9vw, var(--max-small-text));transition:background 0.3s, transform 0.2s, width 0.3s, height 0.3s;position:relative;width:calc(var(--btn-icon-size) * 2.5);height:calc(var(--btn-icon-size) * 2.5);display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .header-btn:hover{background:#d0d0d0;transform:scale(1.05)}
        .auth-tabs{display:flex;margin-bottom:clamp(20px, 5vw, 30px);background:#f8f9fa;border-radius:12px;overflow:hidden}
        .auth-tab{flex:1;padding:clamp(12px, 3vw, 14px) clamp(10px, 2vw, 12px);text-align:center;cursor:pointer;border-bottom:none;transition:all 0.3s ease;background:transparent;position:relative;overflow:hidden}
        .auth-tab.active{background:#4a6ee0;color:white;font-weight:600;transform:scale(1.02)}
        .auth-form{display:flex;flex-direction:column;gap:clamp(16px, 4vw, 20px)}        
        
        .form-input{min-height:52px}        
        @media (max-width:768px){.auth-form{gap:clamp(14px, 3vw, 18px)}}
        @media (max-width:480px){.auth-form{gap:clamp(12px, 2vw, 16px)}}
        .form-group{display:flex;flex-direction:column;gap:8px;position:relative}
        
        .auth-container .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
            transition: color 0.2s ease;
        }
        
        .auth-container .form-input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
            z-index: 1;
        }
        
        .auth-container .form-input {
            width: 100%;
            padding: 16px 48px;
            font-size: 1rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background-color: var(--background-secondary);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            min-height: 52px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }
        
        .auth-container .form-input:focus {
            border-color: #4a6ee0;
            box-shadow: 0 0 0 3px rgba(74, 110, 224, 0.2);
            transform: translateY(-1px);
        }
        
        .auth-container .form-input:hover {
            border-color: var(--border-hover);
            transform: translateY(-0.5px);
        }
        
        .auth-container .form-input.error {
            border-color: var(--error-color);
            animation: inputShake 0.3s ease-in-out;
        }
        
        @keyframes inputShake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-4px); }
            40%, 80% { transform: translateX(4px); }
        }
        
        .auth-container .form-error {
            color: var(--error-color, #e53e3e);
            font-size: 0.85rem;
            margin-top: 6px;
            display: block;
            height: 20px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-5px);
        }
        
        .auth-container .form-error.visible {
            opacity: 1;
            transform: translateY(0);
        }
        

        
        .auth-container .form-error {
            color: var(--error-color, #e53e3e);
            font-size: 0.85rem;
            margin-top: 6px;
            display: block;
            height: 20px;
            transition: opacity 0.2s ease;
        }
        .form-label{font-size:clamp(0.85rem, 0.9vw, var(--max-small-text));color:#555;font-weight:500}
        .form-input{padding:16px 20px;border:2px solid #e0e5ec;border-radius:12px;outline:none;font-size:clamp(0.9rem, 1vw, var(--max-font-size));transition:all 0.3s ease;background:white}
        .form-input:focus{border-color:#4a6ee0;box-shadow:0 0 0 3px rgba(74,110,224,0.15);background:#ffffff}
        .auth-btn{padding:16px var(--btn-padding-horizontal);background:#4a6ee0;color:white;border:none;border-radius:12px;cursor:pointer;font-weight:var(--font-weight-semibold);margin-top:20px;font-size:clamp(0.95rem, 1vw, var(--max-font-size));transition:all 0.3s ease;min-width:var(--btn-min-width);height:52px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(74,110,224,0.3);position:relative;overflow:hidden}
        
        .auth-btn:disabled {
            background-color: var(--background-disabled);
            color: var(--text-disabled);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .auth-btn.loading {
            opacity: 0.8;
            pointer-events: none;
        }
        
        .auth-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .auth-btn:hover{background:#3a5ed0;transform:translateY(-2px);box-shadow:0 6px 16px rgba(74,110,224,0.4);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);}
        
        .auth-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .auth-btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .auth-tab {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .auth-tab.active {
            animation: tabSlideIn 0.3s ease-out;
        }
        
        @keyframes tabSlideIn {
            from {
                transform: translateX(10px);
                opacity: 0.8;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .auth-message{margin-top:15px;padding:12px;border-radius:8px;text-align:center;font-size:clamp(0.85rem, 0.9vw, var(--max-small-text))}
        .auth-message.success{background:#e7f7ed;color:#2d7730}
        .auth-message.error{background:#fde8e8;color:#c53030}
        .chat-content{display:flex;flex:1;overflow:hidden;position:relative}
        .friends-sidebar{width:280px;background:#f8f9fa;border-right:none;display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:transform 0.3s ease}
        .friends-sidebar.hidden{transform:translateX(-100%);position:absolute;height:100%;z-index:10}
        .toggle-sidebar{position:absolute;top:15px;left:15px;z-index:20;background:#4a6ee0;color:white;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;font-size:clamp(0.85rem, 0.9vw, var(--max-small-text));display:flex;align-items:center;gap:5px}
        .friends-header{padding:15px 20px;background:#f0f8ff;border-bottom:none;font-weight:600;color:#4a6ee0;display:flex;justify-content:space-between;align-items:center}
        .close-sidebar{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#4a6ee0}
.friend-code-section{padding:15px 20px;border-bottom:none;background:white}
        .friend-code{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .friend-code-text {
            font-family: monospace;
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 6px;
flex: 1;
            font-size: clamp(0.85rem, 0.9vw, var(--max-small-text));
            letter-spacing: 1px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        .auth-container * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .auth-container .form-input, .auth-container .modern-form-input {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        .copy-btn{background:#4a6ee0;color:white;border:none;border-radius:4px;padding:6px 10px;cursor:pointer;font-size:clamp(0.75rem, 0.8vw, 0.85rem)}
        .add-friend-section{padding:15px 20px;border-bottom:none;background:white}
        .add-friend-input{display:flex;gap:8px;margin-bottom:10px}
        .friend-input{flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:clamp(0.85rem, 0.9vw, var(--max-small-text))}
        .add-friend-section .form-label {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .add-btn {
            background: #333333;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: clamp(0.85rem, 0.9vw, var(--max-small-text));
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .friends-list{flex:1;overflow-y:auto;padding:10px 0}
        .friend-item{padding:12px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:background 0.2s;position:relative}
.friend-item:hover{background:#f0f8ff}
        .friend-item.active{background:#e6f0ff;border-left:none}
        .friend-avatar{width:36px;height:36px;border-radius:50%;background:#4a6ee0;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:0.9rem;position:relative;background-size:cover;background-position:center}
.friend-name{flex:1;font-weight:500;display:flex;align-items:center;overflow:hidden}
        .friend-actions{display:flex;gap:5px;opacity:0;transition:opacity 0.3s}
        .friend-item:hover .friend-actions{opacity:1}
        .friend-action-btn{background:none;border:none;color:#666;cursor:pointer;padding:5px;border-radius:4px;transition:background 0.3s;display:flex;align-items:center;justify-content:center}
        .friend-action-btn:hover{background:rgba(0,0,0,0.1)}
        .delete-friend-btn{color:#e74c3c}
        .delete-friend-btn:hover{background:rgba(231,76,60,0.1)}
        .chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .chat-messages{flex:1;padding:25px;overflow-y:auto;display:flex;flex-direction:column;gap:18px;background:#f8f9fa}
        .message{max-width:70%;padding:14px 18px;border-radius:18px;position:relative;line-height:var(--line-height-relaxed);box-shadow:none;font-size:clamp(0.9rem, 1vw, var(--max-font-size));font-weight:var(--font-weight-normal);word-wrap:break-word;hyphens:auto;}
        .message.sent{align-self:flex-end;background:#4a6ee0;color:white;border-bottom-right-radius:6px}
        .message.sent a{color:#333333;background:#f5f5f5;padding:1px 3px;border-radius:3px;font-weight:bold}
        .message.sent a:hover{color:#333333;background:#e0e0e0}
        .message.received{align-self:flex-start;background:white;color:#333;border-bottom-left-radius:6px;border:none}
        .message.received a{color:#333333;background:#f5f5f5;padding:1px 3px;border-radius:3px;text-decoration:none}
        .message.received a:hover{color:#333333;background:#e0e0e0}
        .message-info{display:flex;justify-content:flex-end;margin-top:8px;font-size:clamp(0.7rem, 0.7vw, 0.8rem);opacity:0.8}
        .message-time{margin-top:4px}
        
        .recalled-message{font-style:italic;opacity:0.7}
        .chat-input-container{padding:15px;border-top:none;display:flex;gap:10px;background:white;flex-shrink:0;align-items:center}
        .chat-input{flex:1;padding:12px 15px;border:1px solid #ddd;border-radius:24px;outline:none;font-size:clamp(0.9rem, 1vw, var(--max-font-size));transition:border 0.3s;min-height:50px}
        .chat-input:focus{border-color:#4a6ee0}
        .send-btn{padding:var(--btn-padding-vertical) var(--btn-padding-horizontal);background:#4a6ee0;color:white;border:none;border-radius:calc(var(--btn-border-radius) * 3);cursor:pointer;font-weight:var(--font-weight-semibold);font-size:clamp(0.9rem, 1vw, var(--max-font-size));transition:background 0.3s, transform 0.2s, padding 0.3s, min-width 0.3s;min-width:calc(var(--btn-min-width) + 1em);height:var(--btn-height);display:flex;align-items:center;justify-content:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
        .send-btn:active{transform:none}
        .send-btn:hover{background:#3a5ed0;transform:scale(1.02)}
        .send-btn:disabled{background:#ccc;cursor:not-allowed}
        .status{text-align:center;padding:15px;color:#666;font-size:clamp(0.9rem, 1vw, var(--max-font-size))}
        .status-dot{width:10px;height:10px;border-radius:50%;background:#4CAF50}
        .status-dot.offline{background:#f44336}
        #initLoadingContainer,
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, var(--background-color, #ffffff) 0%, var(--secondary-color, #f5f5f5) 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
            padding: 40px;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6ee0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            -webkit-animation: spin 1s linear infinite; 
            -moz-animation: spin 1s linear infinite; 
            -o-animation: spin 1s linear infinite; 
            margin-bottom: 20px;
            will-change: transform; 
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @-moz-keyframes spin {
            0% { -moz-transform: rotate(0deg); }
            100% { -moz-transform: rotate(360deg); }
        }
        @-o-keyframes spin {
            0% { -o-transform: rotate(0deg); }
            100% { -o-transform: rotate(360deg); }
        }
        .emoji-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;padding:8px;border-radius:8px;transition:background 0.3s;display:flex;align-items:center;justify-content:center;width:40px;height:40px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
.emoji-btn:disabled{cursor:default;opacity:0.6;}
        .emoji-btn:active{transform:none}
        .sticker-search-btn{background-color: var(--primary-color);
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        }
        .send-btn{padding:12px 20px;
        background: #333333;
        color: white;
        border: none;
        border-radius: 24px;
        cursor: pointer;
        font-weight: 600;
        font-size: clamp(0.9rem, 1vw, var(--max-font-size));
        transition: background 0.3s;
        min-width: 70px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        }
        .emoji-btn:not(:disabled):hover{background:#f0f0f0}
        .emoji-picker{position:absolute;bottom:70px;left:15px;background:var(--background-color);border:1px solid var(--border-color);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);width:320px;max-height:350px;overflow:hidden;z-index:100;display:none;flex-direction:column;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none} .emoji-category-tabs {height:auto;flex-shrink:0;display:flex;align-items:center;overflow-x:auto;overflow-y:hidden;white-space:nowrap;border-bottom:1px solid var(--border-color);background:var(--background-color);-webkit-overflow-scrolling:touch;-ms-overflow-style:none;scrollbar-width:none} .emoji-category-tabs::-webkit-scrollbar {display:none} .emoji-category-tab {padding:10px 20px;cursor:pointer;transition:all 0.2s;font-size:clamp(12px, 2vw, 15px);color:var(--primary-color);border-bottom:2px solid transparent;flex-shrink:0;min-width:80px;transform:translateY(0);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;justify-content:center} .emoji-category-tab:hover {background:var(--border-color)} .emoji-category-tab.active {color:var(--primary-color);border-bottom-color:var(--primary-color);font-weight:500;padding:8px 15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;justify-content:center} .emoji-content-container {flex:1;overflow-y:auto;padding:15px;display:flex;flex-wrap:wrap;gap:0px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;min-height:0} .emoji-pagination {display:flex;justify-content:center;align-items:center;padding:10px 0;border-top:1px solid #e0e0e0;background:#fff;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none} .emoji-pagination-btn {padding:5px 15px;margin:0 10px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer;border-radius:4px;font-size:14px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:flex;align-items:center;justify-content:center;min-width:60px;transform:translateY(-5px)} .emoji-pagination-btn:hover:not(:disabled) {background:#e0e0e0} .emoji-pagination-btn:disabled {opacity:0.5;cursor:not-allowed} .emoji-pagination-info {font-size:14px;color:#666;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .emoji-picker.show{display:flex}
        .emoji-item{font-size:1.5rem;cursor:pointer;padding:5px;border-radius:12px;transition:background 0.2s;width:40px;height:40px;display:flex;align-items:center;justify-content:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background:var(--background-color);color:var(--text-color)}
        .emoji-item:hover{background:var(--border-color)}
        .emoji-category{width:100%;font-weight:600;color:var(--primary-color);margin-top:0px;margin-bottom:0px;font-size:0.9rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.sticker-picker{position:absolute;bottom:70px;left:15px;background:var(--background-color);border:1px solid var(--border-color);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);padding:15px;width:320px;max-height:300px;overflow-y:auto;z-index:100;display:none;flex-direction:column;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .sticker-picker.show{display:flex}
        .sticker-search{display:flex;gap:8px;margin-bottom:10px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .sticker-input{flex:1;padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:0.9rem}
        .sticker-search-btn{background:var(--primary-color);color:white;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;font-size:0.9rem}
.sticker-search-btn:disabled{background:var(--border-color);color:#666;cursor:default;opacity:0.6;}
.sticker-search-btn:active{transform:none}
        .sticker-results{display:flex;gap:8px;max-height:200px;overflow-x:auto;overflow-y:hidden;padding:5px 0;flex-wrap:nowrap}
        .sticker-item{width:80px;height:80px;cursor:pointer;border-radius:6px;transition:transform 0.2s;flex-shrink:0;object-fit:contain;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .sticker-item:hover{transform:scale(1.05)}
        .sticker-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;padding:8px;border-radius:8px;transition:background 0.3s;display:flex;align-items:center;justify-content:center;width:40px;height:40px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
.sticker-btn:disabled{cursor:default;opacity:0.6;}
.sticker-btn:active{transform:none}
.sticker-btn:not(:disabled):hover{background:#f0f0f0}
        .chat-image{border-radius:8px}
        .sticker-error{color:#c53030;font-size:0.9rem;text-align:center;padding:10px}
        .sticker-loading{text-align:center;padding:10px;color:#666}
        .sticker-prompt{text-align:center;padding:10px;color:#666;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:5px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal-overlay.show{opacity:1;visibility:visible}
        .modal{background:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);width:90%;max-width:400px;transform:translateY(-20px);transition:transform 0.3s}
        .modal-overlay.show .modal{transform:translateY(0)}
        .modal-header{padding:20px 25px 10px;font-weight:600;font-size:clamp(1.1rem, 1.5vw, var(--max-large-text));color:#333}
        .modal-body{padding:10px 25px 20px;color:#666;line-height:1.5;font-size:clamp(0.9rem, 1vw, var(--max-font-size))}
        .modal-footer{padding:15px 25px 20px;display:flex;justify-content:flex-end;gap:10px}
        .modal-btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:500;font-size:clamp(0.9rem, 1vw, var(--max-font-size));transition:background 0.3s}
        .modal-btn.cancel{background:#f0f0f0;color:#333}
        .modal-btn.cancel:hover{background:#e0e0e0}
        .modal-btn.confirm{background:#e74c3c;color:white}
        .modal-btn.confirm:hover{background:#c0392b}
        .modal-btn.success{background:#4a6ee0;color:white}
        .modal-btn.success:hover{background:#3a5ed0}
        .success-modal .modal-header{color:#2d7730;display:flex;align-items:center;gap:10px}
        .success-icon{width:24px;height:24px;background:#2d7730;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold}
        .recall-modal .modal-header{color:#e74c3c}
        .chat-messages::-webkit-scrollbar,.friends-list::-webkit-scrollbar{width:8px}
.chat-messages::-webkit-scrollbar-track,.friends-list::-webkit-scrollbar-track{background:var(--scrollbar-track);border-radius:4px}
.chat-messages::-webkit-scrollbar-thumb,.friends-list::-webkit-scrollbar-thumb{background:var(--scrollbar-thumb);border-radius:4px}
.chat-messages::-webkit-scrollbar-thumb:hover,.friends-list::-webkit-scrollbar-thumb:hover{background:var(--scrollbar-thumb-hover)}
        .unread-badge{position:absolute;top:-5px;right:-5px;background:#ff4757;color:white;border-radius:50%;width:18px;height:18px;font-size:0.7rem;display:flex;align-items:center;justify-content:center;font-weight:bold;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        .unread-count{background:#ff4757;color:white;border-radius:10px;padding:2px 8px;font-size:0.8rem;margin-left:8px;font-weight:bold}
        .notification-badge{position:absolute;top:-5px;right:-5px;background:#ff4757;color:white;border-radius:50%;width:18px;height:18px;font-size:0.7rem;display:flex;align-items:center;justify-content:center;font-weight:bold;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        .notification-container {
            position: relative;
            display: inline-block;
        }
        
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .notification-dropdown.show{display:block}
        .notification-header{padding:12px 15px;border-bottom:1px solid #eee;font-weight:600;color:#333}
        .notification-list{max-height:300px;overflow-y:auto}
        .notification-item{padding:12px 15px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
        .notification-item:hover{background:#f8f9fa}
        .notification-item:last-child{border-bottom:none}
        .notification-friend-name{font-weight:500;color:black}
        .notification-message-preview{font-size:0.85rem;color:#666;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
        .notification-count{background:#4a6ee0;color:white;border-radius:10px;padding:2px 8px;font-size:0.8rem}
        .notification-container{position:relative;display:inline-block}
        .no-notifications{color:black !important;text-align:center;padding:15px}
        .friends-header{
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        }
        .friend-name{
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        }
        .sticker-results{scrollbar-width:thin;scrollbar-color:var(--scrollbar-thumb) var(--scrollbar-track)}
.sticker-results::-webkit-scrollbar{height:8px}
.sticker-results::-webkit-scrollbar-track{background:var(--scrollbar-track);border-radius:4px}
.sticker-results::-webkit-scrollbar-thumb{background:var(--scrollbar-thumb);border-radius:4px}
.sticker-results::-webkit-scrollbar-thumb:hover{background:var(--scrollbar-thumb-hover)}
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }
        
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }
        .message.pending{opacity:0.7}
        .message.failed{opacity:0.5;background-color:#ffcccc}
        .retry-btn{background:rgba(255,255,255,0.2);color:white;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:0.6rem}
        .connection-status{font-size:0.8rem;opacity:0.8;display:flex;align-items:center;gap:5px}
        .no-friend-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .no-friend-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .no-friend-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .no-friend-hint {
            font-size: 0.9rem;
            opacity: 0.7;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .official-friend {
            background-color: #f0f8ff !important;
        }

        .official-avatar {
            background: linear-gradient(135deg, #4a6ee0, #764ba2) !important;
        }

        .official-badge {
            background: #4a6ee0;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .friend-item.official-friend .friend-actions {
            opacity: 0.3 !important;
            cursor: not-allowed;
        }
        .friend-item.official-friend .friend-actions button {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .settings-modal .modal{max-width:500px}
        .settings-modal .modal-header, .settings-tab, .settings-section-title, .form-label, #saveAppearanceToCloudBtn, #themeSelect, .font-control-btn, .font-icon {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .settings-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid #eee}
        .settings-tab{flex:1;padding:12px;text-align:center;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.3s}
        .settings-tab.active{border-bottom:2px solid #4a6ee0;color:#4a6ee0;font-weight:600}
        .settings-content{padding:10px 0;
    overflow-y: auto;
    padding-right: 8px;}

.settings-content::-webkit-scrollbar {
    width: 6px;
}

.settings-content::-webkit-scrollbar-track {
    background: var(--scrollbar-track);
    border-radius: 3px;
}

.settings-content::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 3px;
}

.settings-content::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover);
}

.settings-content {
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
}
        .settings-section{margin-bottom:20px}
        .settings-section-title{font-weight:600;margin-bottom:10px;color:#333}
        
        .font-size-controls {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            align-items: center;
        }
        
        .font-control-btn {
            padding: 10px 16px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .font-control-btn:hover {
            background-color: #e0e0e0;
            border-color: #4a6ee0;
        }
        
        .font-control-btn.active {
            background-color: #4a6ee0;
            color: white;
            border-color: #4a6ee0;
        }
        
        .font-icon {
            font-weight: 600;
        }
        
        .font-size-display {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #4a6ee0;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        body.theme-default {
            --primary-color: #4a6ee0;
            --primary-hover: #3a5ed0;
            --background-color: white;
            --text-color: #333;
            --sidebar-bg: #f8f9fa;
            --sidebar-header-bg: #f0f8ff;
            --border-color: #e1e8ed;
            --hover-bg: #f0f8ff;
            --active-bg: #e6f0ff;
            --card-bg: white;
            --input-bg: white;
            --message-sent-bg: #4a6ee0;
            --message-received-bg: white;
            --success-color: #2d7730;
            --error-color: #c53030;
            --header-bg: #4a6ee0;
            --header-text: white;
            --scrollbar-track: #f1f1f1;
            --scrollbar-thumb: #c1c1c1;
            --scrollbar-thumb-hover: #a8a8a8;
        }
        
        body.theme-green {
            --primary-color: #2ecc71;
            --primary-hover: #27ae60;
            --background-color: white;
            --text-color: #333;
            --sidebar-bg: #f8f9fa;
            --sidebar-header-bg: #e7f7ed;
            --border-color: #e1e8ed;
            --hover-bg: #e7f7ed;
            --active-bg: #d4f1d8;
            --card-bg: white;
            --input-bg: white;
            --message-sent-bg: #2ecc71;
            --message-received-bg: white;
            --success-color: #2d7730;
            --error-color: #c53030;
            --header-bg: #2ecc71;
            --header-text: white;
            --scrollbar-track: #f1f1f1;
            --scrollbar-thumb: #a5d6a7;
            --scrollbar-thumb-hover: #81c784;
        }
        
        body.theme-purple {
            --primary-color: #9b59b6;
            --primary-hover: #8e44ad;
            --background-color: white;
            --text-color: #333;
            --sidebar-bg: #f8f9fa;
            --sidebar-header-bg: #f3e5f5;
            --border-color: #e1e8ed;
            --hover-bg: #f3e5f5;
            --active-bg: #e1bee7;
            --card-bg: white;
            --input-bg: white;
            --message-sent-bg: #9b59b6;
            --message-received-bg: white;
            --success-color: #2d7730;
            --error-color: #c53030;
            --header-bg: #9b59b6;
            --header-text: white;
            --scrollbar-track: #f1f1f1;
            --scrollbar-thumb: #ce93d8;
            --scrollbar-thumb-hover: #ba68c8;
        }
        
        body.theme-red {
            --primary-color: #e74c3c;
            --primary-hover: #c0392b;
            --background-color: white;
            --text-color: #333;
            --sidebar-bg: #f8f9fa;
            --sidebar-header-bg: #fde8e8;
            --border-color: #e1e8ed;
            --hover-bg: #fde8e8;
            --active-bg: #fab1a0;
            --card-bg: white;
            --input-bg: white;
            --message-sent-bg: #e74c3c;
            --message-received-bg: white;
            --success-color: #2d7730;
            --error-color: #c53030;
            --header-bg: #e74c3c;
            --header-text: white;
            --scrollbar-track: #f1f1f1;
            --scrollbar-thumb: #ef9a9a;
            --scrollbar-thumb-hover: #e57373;
        }
        
        body.theme-dark {
            --primary-color: #5dade2;
            --primary-hover: #3498db;
            --background-color: #121212;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --sidebar-bg: #1e1e1e;
            --sidebar-header-bg: #253f7f;
            --border-color: #333333;
            --hover-bg: #2a2a2a;
            --active-bg: #37474f;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --message-sent-bg: #5dade2;
            --message-received-bg: #2d2d2d;
            --success-color: #4ade80;
            --error-color: #f87171;
            --warning-color: #facc15;
            --info-color: #60a5fa;
            --header-bg: #1e293b;
            --header-text: #ffffff;
            --scrollbar-track: #121212;
            --scrollbar-thumb: #4a4a4a;
            --scrollbar-thumb-hover: #666;
            
            --modal-bg: #1e1e1e;
            --tooltip-bg: #2d2d2d;
            --notification-bg: #2a2a2a;
            --highlight-bg: #37474f;
        }
        
        body.theme-dark #friendCodeDisplay {
            color: var(--text-color);
            background-color: var(--input-bg);
            font-weight: 600;
        }
        
        body.theme-dark .friend-code-text, 
        body.theme-dark #friendCodeText {
            color: #000000;
            font-weight: 100;
        }
        
        body.theme-default .official-friend {
            background-color: rgba(74, 110, 224, 0.1) !important;
        }
        
        body.theme-green .official-friend {
            background-color: rgba(46, 204, 113, 0.1) !important;
        }
        
        body.theme-purple .official-friend {
            background-color: rgba(155, 89, 182, 0.1) !important;
        }
        
        body.theme-red .official-friend {
            background-color: rgba(231, 76, 60, 0.1) !important;
        }
        
        body.theme-dark .official-friend {
            background-color: rgba(93, 173, 226, 0.15) !important;
        }
        
        body.theme-dark .modal {
            background-color: var(--modal-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        body.theme-dark .modal-header {
            background-color: var(--header-bg);
            color: var(--header-text);
        }
        
        body.theme-dark .chat-input-container {
            background-color: var(--header-bg);
            border-top-color: var(--border-color);
        }
        
        body.theme-dark .form-input{background:#1e1e1e;border-color:#333}
        body.theme-dark .chat-input,
        body.theme-dark .friend-input,
        body.theme-dark .sticker-input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        body.theme-dark .form-input:focus{border-color:#6a8eef;box-shadow:0 0 0 3px rgba(106,142,239,0.2)}
        body.theme-dark .chat-input:focus,
        body.theme-dark .friend-input:focus,
        body.theme-dark .sticker-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(93, 173, 226, 0.2);
        }
        
        body.theme-dark .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        body.theme-dark .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        body.theme-dark .btn-secondary {
            background-color: var(--hover-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        body.theme-dark .card,
        body.theme-dark .settings-section {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        
        body.theme-dark ::-webkit-scrollbar-track {
            background-color: var(--scrollbar-track);
        }
        
        body.theme-dark ::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: 4px;
        }
        
        body.theme-dark ::-webkit-scrollbar-thumb:hover {
            background-color: var(--scrollbar-thumb-hover);
        }
        
        body.theme-dark .form-label,
        body.theme-dark .notification-header,
        body.theme-dark .no-notifications,
        body.theme-dark #usernameInput,
        body.theme-dark #friendCodeDisplay {
            color: white !important;
        }
        
        body.theme-dark a {
            color: var(--primary-color);
        }
        
        body.theme-dark a:hover {
            color: var(--primary-hover);
        }
        
        body.theme-dark .error-message {
            color: var(--error-color);
            background-color: rgba(248, 113, 113, 0.1);
            border-color: var(--error-color);
        }
        
        body.theme-dark .success-message {
            color: var(--success-color);
            background-color: rgba(74, 222, 128, 0.1);
            border-color: var(--success-color);
        }
        
        body.theme-dark .tooltip {
            background-color: var(--tooltip-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        body.theme-dark .settings-tab {
            background-color: transparent;
            color: var(--text-secondary);
        }
        
        body.theme-dark .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        body.theme-dark select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        body.theme-dark .message-sent {
            background-color: var(--message-sent-bg);
            color: white;
        }
        
        body.theme-dark .message-received {
            background-color: var(--message-received-bg);
            color: var(--text-color);
        }
        
        body.theme-dark .text-muted {
            color: var(--text-secondary) !important;
        }
        
        body.theme-dark hr {
            border-color: var(--border-color);
        }
        
        .theme-preview.active {
            border: 3px solid #4a6ee0;
            box-shadow: 0 0 0 2px rgba(74, 110, 224, 0.3);
            transform: scale(1.1);
            z-index: 1;
        }
        
        .auth-btn, .send-btn, .add-btn, .copy-btn, .sticker-search-btn, .modal-btn.success, .modal-btn.confirm {
            background-color: var(--primary-color);
        }
        
        .auth-btn:hover, .send-btn:hover, .add-btn:hover, .copy-btn:hover, .sticker-search-btn:not(:disabled):hover, 
        .modal-btn.success:hover, .modal-btn.confirm:hover {
            background-color: var(--primary-hover);
        }
        
        .auth-tab.active, .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .form-input:focus, .chat-input:focus {
            border-color: var(--primary-color);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        .auth-container, .chat-container {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .friends-sidebar {
            background-color: var(--sidebar-bg);
            border-color: var(--border-color);
        }
        
        .friends-header {
            background-color: var(--sidebar-header-bg);
            color: var(--primary-color);
        }
        
        .friend-item:hover {
            background-color: var(--hover-bg);
        }
        
        .friend-item.active {
            background-color: var(--active-bg);
            border-left-color: var(--primary-color);
        }
        
        .chat-header {
            background-color: var(--header-bg);
            color: var(--header-text);
        }
        
        .chat-messages {
            background-color: var(--background-color);
        }
        
        .message.sent {
            background-color: var(--message-sent-bg);
        }
        
        .message.received {
            background-color: var(--message-received-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        .form-input, .chat-input, .friend-input, .sticker-input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        .form-input:focus, .chat-input:focus, .friend-input:focus, .sticker-input:focus {
            border-color: var(--primary-color);
        }
        
        .friend-code-section, .add-friend-section, .emoji-picker, .sticker-picker, .modal {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        
        .auth-message.success {
            background-color: rgba(45, 119, 48, 0.1);
            color: var(--success-color);
        }
        
        .auth-message.error {
            background-color: rgba(197, 48, 48, 0.1);
            color: var(--error-color);
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .notification-dropdown {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        .notification-item:hover {
            background-color: var(--hover-bg);
        }
        
        body {
            font-size: var(--body-font-size, 16px);
        }
        
        button, 
        .btn, 
        .emoji-btn, 
        .header-btn, 
        .send-btn, 
        .auth-btn, 
        .zoomInButton, 
        .zoomOutButton, 
        .resetButton {
            --font-scale: 1.0;
        }
        
        .emoji-btn span, 
        .emoji-btn i, 
        .message span[role="img"], 
        .message i {
            font-size: inherit !important;
        }
        
        [style*="font-size"][style*="calc"] {
            font-size: inherit !important;
        }
        
        .theme-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding-left: 10px;
        }
        
        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .theme-preview:hover {
            transform: scale(1.1);
        }
        
        .theme-preview.active {
            border-color: #333;
            transform: scale(1.1);
        }
        
        .theme-preview.default { background: #4a6ee0; }
        .theme-preview.green { background: linear-gradient(135deg, #66BB6A, #2E7D32); }
        .theme-preview.purple { background: linear-gradient(135deg, #AB47BC, #7B1FA2); }
        .theme-preview.red { background: linear-gradient(135deg, #EF5350, #D32F2F); }
        .theme-preview.dark { background: #000000; }
        
        .theme-name {
             position: absolute;
             bottom: -25px;
             left: 50%;
             transform: translateX(-50%);
             font-size: 0.7rem;
             white-space: nowrap;
             color: var(--text-color);
         }
        
        .header-btn {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: pointer;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 8px;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            -webkit-backdrop-filter: blur(15px);
        backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .header-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        @media (max-width:1024px) and (min-width:769px){.container{flex-direction:column;justify-content:center;align-items:center;height:100vh;padding:20px;width:100%}.auth-container{width:90%;padding:40px;min-height:450px;margin:0 auto;border-radius:0;border:none;box-shadow:none}}        
        @media (max-width:768px){
            .container{flex-direction:column}
            .auth-container{width:100%;max-width:100%;margin:0;border-radius:0;height:100vh;justify-content:center;display:flex;flex-direction:column;padding:clamp(20px, 5vw, 30px)}
            .chat-container{height:100vh;width:100%}
            .chat-header{padding:12px 15px;display:flex;align-items:center;justify-content:space-between}
            .chat-header h1{font-size:clamp(1.1rem, 3vw, var(--max-large-text));font-weight:var(--font-weight-semibold);display:flex;align-items:center;gap:8px;margin:0}
            .connection-status{flex-shrink:0;min-width:60px}
            .status-dot{width:8px;height:8px}
            .header-buttons{gap:6px;display:flex;align-items:center}
            .header-btn{padding:calc(var(--btn-padding-vertical) * 0.8);font-size:clamp(0.8rem, 2vw, 1rem);width:44px;height:44px;border-radius:calc(var(--btn-border-radius) * 0.8);flex-shrink:0}
            .user-info{gap:8px;display:flex;align-items:center}
            .user-avatar{width:35px;height:35px;font-size:1rem;flex-shrink:0}
            .userName{font-size:clamp(0.9rem, 2vw, 1rem);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100px}
            .friends-sidebar{width:100%;position:absolute;z-index:10;height:100%}
            .friends-sidebar.hidden{transform:translateX(-100%)}
            .toggle-sidebar{display:flex}
            .chat-area{width:100%}
            .chat-messages{padding:15px;gap:15px}
            .message{max-width:85%;padding:12px 15px;line-height:var(--line-height-relaxed);font-weight:var(--font-weight-normal)}
            .chat-input-container{padding:12px;gap:8px}
            .chat-input{padding:12px 15px;font-size:clamp(0.9rem, 2vw, var(--max-font-size));min-height:48px}
            .send-btn{padding:calc(var(--btn-padding-vertical) * 0.9) calc(var(--btn-padding-horizontal) * 0.9);min-width:44px;height:48px;font-size:clamp(0.85rem, 2vw, var(--max-font-size));font-weight:var(--font-weight-medium)}
            .emoji-picker{width:min(280px, 90vw);left:10px;bottom:65px;max-height:320px}
            .emoji-category-tabs{height:auto;align-items:center}
            .emoji-category-tab{padding:2px 18px;font-size:clamp(12px, 2vw, 14px);min-width:70px;transform:translateY(0)}
            .sticker-picker{width:min(280px, 90vw);left:10px;bottom:65px}
            .sticker-item{width:70px;height:70px}
            .notification-dropdown{width:250px}
            .form-input{padding:15px 18px;min-height:48px}
            .auth-btn{min-height:48px}
            button, a[role="button"]{min-width:44px;min-height:44px}
        }
        @media (max-width:600px) and (min-width:481px){.auth-container{padding:25px}.form-input{padding:15px 19px}}        
        @media (max-width:480px){
            .auth-container{padding:clamp(15px, 4vw, 20px)}
            .auth-tabs{margin-bottom:25px}
            .form-input{padding:14px 18px;height:48px}
            .auth-btn{height:48px;padding:14px}
            .chat-header h1{font-size:clamp(1rem, 3.5vw, var(--max-large-text));font-weight:var(--font-weight-semibold)}
            .message{max-width:90%;line-height:var(--line-height-relaxed);font-weight:var(--font-weight-normal);padding:10px 12px}
            .chat-input{min-height:44px;padding:10px 14px;font-size:clamp(0.85rem, 2.5vw, var(--max-font-size))}
            .send-btn{min-width:44px;height:44px;padding:calc(var(--btn-padding-vertical) * 0.8) calc(var(--btn-padding-horizontal) * 0.8);font-size:clamp(0.8rem, 2.5vw, var(--max-small-text));font-weight:var(--font-weight-medium)}
            .emoji-picker{width:min(260px, 95vw);left:5px;bottom:60px;max-height:300px}
            .emoji-category-tabs{height:auto;align-items:center}
            .emoji-category-tab{padding:2px 16px;font-size:clamp(11px, 2vw, 13px);min-width:65px;transform:translateY(0)}
            .emoji-pagination-btn{padding:4px 10px;margin:0 5px;font-size:13px;display:flex;align-items:center;justify-content:center;min-width:50px;transform:translateY(-5px)}
            .sticker-picker{width:min(260px, 95vw);left:5px;bottom:60px}
            .sticker-item{width:60px;height:60px}
            .notification-dropdown{width:220px}
            .header-btn, .send-btn{width:44px;height:44px}
            .auth-form > *{margin-bottom:clamp(12px, 4vw, 16px)}
        }
        @media screen and (-webkit-min-device-pixel-ratio:0){select,textarea,input{font-size:16px!important}}
        
        @media (max-width: 1024px) {
            .auth-container {
                width: clamp(300px, 95vw, 100%);
                padding: clamp(25px, 6vw, 35px);
            }
            
            .brand-section {
                margin-bottom: 25px;
            }
            
            .app-logo {
                width: 70px;
                height: 70px;
                margin-bottom: 15px;
            }
            
            .app-name {
                font-size: 24px;
                margin-bottom: 5px;
            }
            
            .app-slogan {
                font-size: 14px;
            }
            
            .auth-tabs {
                margin-bottom: 20px;
            }
            
            .auth-tab {
                padding: 12px 24px;
                font-size: 15px;
            }
            
            .form-group {
                margin-bottom: 18px;
            }
            
            .form-input {
                padding: 14px 16px;
                font-size: 15px;
            }
            
            .auth-btn {
                padding: 14px 24px;
                font-size: 15px;
            }
            
            .social-login {
                margin-top: 20px;
            }
            
            .social-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
        
        /* 添加额外的修复，确保在769-1024像素范围内登录界面正确显示 */
        @media (min-width: 769px) and (max-width: 1024px) {
            html, body {
                height: 100%;
                overflow: auto;
            }
            
            .container {
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .auth-container {
                flex: 0 0 auto;
                width: 90%;
                height: 100vh;
                overflow-y: auto;
            }
        }
        
        @media (max-width: 768px) {
            .auth-container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                height: 100vh;
                justify-content: center;
                display: flex;
                flex-direction: column;
                padding: clamp(20px, 5vw, 30px);
                min-height: auto;
            }
            
            .brand-section {
                margin-bottom: 20px;
            }
            
            .app-logo {
                width: 60px;
                height: 60px;
                margin-bottom: 12px;
            }
            
            .app-name {
                font-size: 22px;
                margin-bottom: 4px;
            }
            
            .app-slogan {
                font-size: 13px;
            }
            
            .auth-tabs {
                margin-bottom: 18px;
            }
            
            .auth-tab {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            .form-input {
                padding: 12px 14px;
                font-size: 14px;
                height: 46px;
            }
            
            .auth-btn {
                padding: 12px 20px;
                font-size: 14px;
                height: 46px;
            }
            
            .social-login {
                margin-top: 18px;
            }
            
            .social-btn {
                padding: 10px 18px;
                font-size: 13px;
            }
            
            .loading-animation {
                margin: 20px 0;
            }
            
            .pulse-dot {
                width: 8px;
                height: 8px;
                margin: 0 4px;
            }
            
            .modern-progress-container {
                margin: 15px 0;
            }
            
            .progress-bar {
                height: 6px;
            }
            
            .progress-steps {
                margin-top: 8px;
            }
            
            .progress-step {
                font-size: 10px;
                padding: 2px 6px;
            }
        }
        
        @media (max-width: 480px) {
            .auth-container {
                padding: clamp(15px, 4vw, 20px);
            }
            
            .brand-section {
                margin-bottom: 15px;
            }
            
            .app-logo {
                width: 50px;
                height: 50px;
                margin-bottom: 10px;
            }
            
            .app-name {
                font-size: 20px;
                margin-bottom: 3px;
            }
            
            .app-slogan {
                font-size: 12px;
            }
            
            .auth-tabs {
                margin-bottom: 15px;
            }
            
            .auth-tab {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .form-group {
                margin-bottom: 14px;
            }
            
            .form-input {
                padding: 10px 12px;
                font-size: 13px;
                height: 44px;
            }
            
            .auth-btn {
                padding: 10px 16px;
                font-size: 13px;
                height: 44px;
            }
            
            .social-login {
                margin-top: 15px;
            }
            
            .social-btn {
                padding: 8px 14px;
                font-size: 12px;
            }
            
            .loading-animation {
                margin: 15px 0;
            }
            
            .pulse-dot {
                width: 6px;
                height: 6px;
                margin: 0 3px;
            }
            
            .modern-progress-container {
                margin: 10px 0;
            }
            
            .progress-bar {
                height: 4px;
            }
            
            .progress-steps {
                margin-top: 6px;
            }
            
            .progress-step {
                font-size: 9px;
                padding: 1px 4px;
            }
            
            .form-input, .auth-btn, .social-btn {
                min-height: 44px;
            }
            
            .auth-form > * {
                margin-bottom: clamp(12px, 4vw, 16px);
            }
            
            .error-message {
                font-size: 11px;
                padding: 6px 8px;
            }
            
            .message-container {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 320px) {
            .auth-container {
                padding: 12px;
            }
            
            .app-logo {
                width: 45px;
                height: 45px;
            }
            
            .app-name {
                font-size: 18px;
            }
            
            .app-slogan {
                font-size: 11px;
            }
            
            .auth-tab {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .form-input {
                padding: 8px 10px;
                font-size: 12px;
                height: 40px;
            }
            
            .auth-btn {
                padding: 8px 12px;
                font-size: 12px;
                height: 40px;
            }
            
            .social-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }
        @media (max-height: 500px) and (orientation: landscape) {
            .auth-container {
                padding: 15px;
                min-height: auto;
                justify-content: flex-start;
                overflow-y: auto;
            }
            
            .brand-section {
                margin-bottom: 15px;
            }
            
            .app-logo {
                width: 40px;
                height: 40px;
                margin-bottom: 8px;
            }
            
            .app-name {
                font-size: 18px;
            }
            
            .auth-tabs {
                margin-bottom: 12px;
            }
            
            .form-group {
                margin-bottom: 10px;
            }
            
            .form-input {
                padding: 8px 12px;
                height: 38px;
            }
            
            .auth-btn {
                padding: 8px 16px;
                height: 38px;
            }
            
            .social-login {
                margin-top: 12px;
            }
        }
        
        @media (min-resolution: 192dpi) {
            .app-logo {
                background-size: contain;
                background-repeat: no-repeat;
            }
            
            .form-input {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
        .auth-container, .loading-container, .auth-forms {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform;
        }
        
        .app-logo {
            background-image: none;
            background-color: #3b82f6;
        }
        
        .form-input, .auth-btn, .social-btn {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .pulse-dot, .progress-bar {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform, opacity;
        }
        
        .auth-container * {
            box-sizing: border-box;
        }
        
        .app-name, .app-slogan, .form-input, .auth-btn {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        .auth-container {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
        
        .form-input:focus, .auth-btn:hover {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .auth-btn, .social-btn, .password-toggle {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .app-logo {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .pulse-dot {
                animation: none !important;
            }
            
            .progress-bar {
                animation: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .auth-container {
                -webkit-overflow-scrolling: touch;
            }
            
            .pulse-dot {
                animation-duration: 1.5s;
            }
            
            .progress-bar {
                animation-duration: 2s;
            }
        }
        
        .night {
            position: fixed;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        #meteorContainer {
            position: fixed;
            width: 80vw;
            height: 80vh;
            transform: rotateZ(30deg);
            left: 10vw;
            top: 10vh;
            pointer-events: none;
            z-index: 1;
        }
        
        .shooting_star {
            position: absolute;
            height: 2px;
            background: linear-gradient(
                -45deg,
                rgba(95, 145, 255, 1),
                rgba(0, 0, 255, 0)
            );
            border-radius: 999px;
            filter: drop-shadow(0 0 6px rgba(105, 155, 255, 1));
            animation: tail 6000ms ease-in-out infinite,
                shooting 6000ms ease-in-out infinite;
        }
        
        .shooting_star::before {
            content: "";
            position: absolute;
            top: calc(50% - 1px);
            right: 0;
            height: 2px;
            background: linear-gradient(
                -45deg,
                rgba(0, 0, 255, 0),
                rgba(95, 145, 255, 1),
                rgba(0, 0, 255, 0)
            );
            transform: translateX(50%) rotateZ(45deg);
            border-radius: 100%;
            animation: shining 6000ms ease-in-out infinite;
        }
        
        .shooting_star::after {
            content: "";
            position: absolute;
            top: calc(50% - 1px);
            right: 0;
            height: 2px;
            background: linear-gradient(
                -45deg,
                rgba(0, 0, 255, 0),
                rgba(95, 145, 255, 1),
                rgba(0, 0, 255, 0)
            );
            transform: translateX(50%) rotateZ(-45deg);
            border-radius: 100%;
            animation: shining 6000ms ease-in-out infinite;
        }
        
        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite alternate;
        }
        
        @keyframes tail {
            0% { width: 0; }
            30% { width: 100px; }
            100% { width: 0; }
        }
        
        @keyframes shining {
            0% { width: 0; }
            50% { width: 30px; }
            100% { width: 0; }
        }
        
        @keyframes shooting {
            0% { transform: translateX(0); }
            100% { transform: translateX(70vw); }
        }
        
        @keyframes twinkle {    0% { opacity: 0.3; }    100% { opacity: 1; }    }
    
    .init-loading-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #334155;
        z-index: 100;
        overflow: hidden;
        transition: opacity 0.6s ease-in, transform 0.5s ease-out, box-shadow 0.3s ease;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.3);
    }
    
    .init-loading-container.loading-active {
        box-shadow: 0 0 40px rgba(79, 172, 254, 0.3);
    }
    
    .app-logo-new {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 40px;
    }
    
    .logo-container {
        position: relative;
        margin-bottom: 20px;
    }
    
    .logo-outer {
        width: 100px;
        height: 100px;
        border-radius: 24px;
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(96, 165, 250, 0.2);
        transition: transform 0.3s ease;
    }
    
    .logo-outer:hover {
        transform: translateY(-2px);
    }
    
    .logo-inner {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .message-icon {
        width: 40px;
        height: 40px;
        fill: #3b82f6;
    }
    
    .app-name-new {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #1e293b;
        letter-spacing: -0.5px;
    }
    
    .app-slogan {
        font-size: 16px;
        color: #64748b;
        font-weight: 400;
        margin: 0;
    }
    
    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .app-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #4a6ee0 0%, #3b82f6 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        animation: pulse 2s ease-in-out infinite;
    }
    
    .app-icon-text {
        font-size: 36px;
        font-weight: bold;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .loading-spinner-new {
        width: 60px;
        height: 60px;
        margin-bottom: 20px;
    }
    
    .spinner-ring {
        width: 100%;
        height: 100%;
        border: 3px solid #e2e8f0;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        -webkit-animation: spin 1.5s linear infinite;  
        -moz-animation: spin 1.5s linear infinite; 
        -o-animation: spin 1.5s linear infinite; 
        will-change: transform; 
    }

    .loading-text {
        font-size: 20px;
        font-weight: 500;
        color: var(--text-color, #334155);
        text-align: center;
        margin-bottom: 30px;
        max-width: 80%;
        line-height: 1.4;
    }
    
    .error-text {
        color: #ff6b6b;
        animation: pulse 1.5s ease-in-out infinite alternate;
        font-weight: 600;
        white-space: pre-line;
        word-break: break-word;
    }
    
    .progress-container {
        width: 280px;
        height: 8px;
        background-color: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 15px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4a6ee0 0%, #3b82f6 100%);
        border-radius: 4px;
        transition: width 0.6s ease-in-out;
        position: relative;
    }
    
    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shine 2s infinite;
    }
    
    .progress-percentage {
        font-size: 16px;
        font-weight: 600;
        color: #4a6ee0;
    }
    
    .version-info {
        position: absolute;
        bottom: 30px;
        font-size: 14px;
        color: var(--text-secondary, #666666);
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    @keyframes shine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }
    
    .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .progress-percentage {
        font-size: 14px;
        color: #64748b;
        display: block;
        text-align: center;
    }
    
    .init-footer-new {
        position: absolute;
        bottom: 20px;
        text-align: center;
        color: #94a3b8;
    }
    
    .app-version {
        font-size: 14px;
    }
    </style>
</head>
<body>
    <div class="night" id="nightSky" style="display: none;"></div>
    <div id="meteorContainer" style="display: none;"></div>
    
    <div class="container">
        <div class="init-loading-container" id="initLoadingContainer" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">
            <div class="app-logo-new">
                <div class="logo-container">
                    <div class="logo-outer">
                        <div class="logo-inner">
                            <svg class="message-icon" viewBox="0 0 24 24">
                                <path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4C22,2.89 21.1,2 20,2Z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <h1 class="app-name-new">Joking Chat</h1>
                <p class="app-slogan">连接无限可能</p>
            </div>
            <div class="loading-content">
                <div class="loading-spinner-new">
                    <div class="spinner-ring"></div>
                </div>
                <div id="initLoadingStatus" class="loading-text">正在初始化聊天界面...</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <span class="progress-percentage">0%</span>
            </div>
            
            <div class="init-footer-new">
                <div class="app-version">版本 1.0.0</div>
            </div>
        </div>
        
    <div class="auth-container" id="authContainer" style="display: none; user-select: none;">
        <div class="loading-container" id="loadingContainer" style="user-select: none;">
            <div class="brand-section">
                <div class="app-logo">
                    <div class="logo-icon">💬</div>
                    <div class="logo-text">Joking Chat</div>
                </div>
                <div class="brand-tagline">智能聊天，连接你我</div>
            </div>
            
            <div class="loading-animation">
                <div class="pulse-loader">
                    <div class="pulse-dot"></div>
                    <div class="pulse-dot"></div>
                    <div class="pulse-dot"></div>
                </div>
                <div class="loading-text" id="loadingStatus" style="user-select: none;">正在初始化聊天室...</div>
            </div>
            
            <div class="modern-progress-container">
                <div class="progress-track">
                    <div class="progress-fill" id="progressBar" style="width: 0%;">
                        <div class="progress-glow"></div>
                    </div>
                </div>
                <div class="progress-info">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-steps">
                        <span class="step active">1</span>
                        <span class="step">2</span>
                        <span class="step">3</span>
                        <span class="step">4</span>
                    </div>
                </div>
            </div>
            
            <div class="version-info">版本 1.0.0</div>
        </div>
        
        <div id="authForms" style="display: none; overflow-y: auto; padding: 10px 0; width: 100%; box-sizing: border-box;">
            <div class="modern-auth-header">
                <div class="modern-logo">
                    <div class="modern-logo-icon">💬</div>
                    <div class="modern-logo-text">Joking Chat</div>
                </div>
                <div class="modern-auth-title">
                    <span class="auth-greeting">欢迎回来</span>
                    <span class="auth-subtitle">请登录您的账户</span>
                </div>
            </div>
            
            <div class="modern-auth-tabs">
                <div class="modern-tab active" id="loginTab" data-tab="login">
                    <span class="tab-icon">🔑</span>
                    <span class="tab-text">登录</span>
                </div>
                <div class="modern-tab" id="registerTab" data-tab="register">
                    <span class="tab-icon">📝</span>
                    <span class="tab-text">注册</span>
                </div>
            </div>
            
            <div class="modern-auth-form" id="loginForm">
                <div class="modern-form-group">
                    <div class="input-wrapper">
                        <span class="input-icon">👤</span>
                        <input type="text" class="modern-form-input" id="loginUsername" placeholder="用户名" oninput="validateField('loginUsername')">
                        <div class="input-underline"></div>
                    </div>
                    <div class="modern-form-error" id="loginUsernameError"></div>
                </div>
                
                <div class="modern-form-group">
                    <div class="input-wrapper">
                        <span class="input-icon">🔒</span>
                        <input type="password" class="modern-form-input" id="loginPassword" placeholder="密码" oninput="validateField('loginPassword')">
                        <button type="button" class="modern-password-toggle" id="toggleLoginPassword">
                            <span class="toggle-icon">👁️</span>
                        </button>
                        <div class="input-underline"></div>
                    </div>
                    <div class="modern-form-error" id="loginPasswordError"></div>
                </div>
                

                
                <button class="modern-auth-btn" id="loginBtn">
                    <span class="btn-text" id="loginBtnText">登录</span>
                    <div class="btn-loader" id="loginBtnLoader" style="display: none;">
                        <div class="loader-dot"></div>
                        <div class="loader-dot"></div>
                        <div class="loader-dot"></div>
                    </div>
                </button>
                

            </div>
            
            <div class="modern-auth-form" id="registerForm" style="display: none;">
                <div class="modern-form-group">
                    <div class="input-wrapper">
                        <span class="input-icon">👤</span>
                        <input type="text" class="modern-form-input" id="registerUsername" placeholder="用户名（最多15个字符，不能含有空格）" maxlength="15" oninput="validateField('registerUsername')">
                        <div class="input-underline"></div>
                    </div>
                    <div class="modern-form-error" id="registerUsernameError"></div>
                </div>
                
                <div class="modern-form-group">
                    <div class="input-wrapper">
                        <span class="input-icon">🔒</span>
                        <input type="password" class="modern-form-input" id="registerPassword" placeholder="密码（至少6位）" oninput="validateField('registerPassword')">
                        <button type="button" class="modern-password-toggle" id="toggleRegisterPassword">
                            <span class="toggle-icon">👁️</span>
                        </button>
                        <div class="input-underline"></div>
                    </div>
                    <div class="modern-form-error" id="registerPasswordError"></div>
                </div>
                
                <div class="modern-form-group">
                    <div class="input-wrapper">
                        <span class="input-icon">🔒</span>
                        <input type="password" class="modern-form-input" id="confirmPassword" placeholder="确认密码" oninput="validateField('confirmPassword')">
                        <button type="button" class="modern-password-toggle" id="toggleConfirmPassword">
                            <span class="toggle-icon">👁️</span>
                        </button>
                        <div class="input-underline"></div>
                    </div>
                    <div class="modern-form-error" id="confirmPasswordError"></div>
                </div>
                

                
                <button class="modern-auth-btn register-btn" id="registerBtn">
                    <span class="btn-text" id="registerBtnText">注册账户</span>
                    <div class="btn-loader" id="registerBtnLoader" style="display: none;">
                        <div class="loader-dot"></div>
                        <div class="loader-dot"></div>
                        <div class="loader-dot"></div>
                    </div>
                </button>
                
                <div class="login-prompt">
                    <span>已有账户？</span>
                    <a href="#" class="login-link" onclick="switchAuthTab('login')">立即登录</a>
                </div>
            </div>
            
            <div id="authMessage" class="modern-auth-message"></div>
        </div>
    </div>
        
    <div id="avatarViewer" class="avatar-viewer" style="display: none;">
        <div class="avatar-viewer-overlay" id="avatarViewerOverlay"></div>
        <div class="avatar-viewer-content">
            <div class="avatar-viewer-controls">
                <button class="avatar-control-btn" id="avatarZoomInBtn" title="放大">+</button>
                <button class="avatar-control-btn" id="avatarZoomOutBtn" title="缩小">-</button>
                <button class="avatar-control-btn" id="avatarResetBtn" title="复原">↺</button>
                <button class="avatar-control-btn avatar-close-btn" id="avatarCloseBtn" title="关闭">×</button>
            </div>
            <div class="avatar-viewer-image-container">
                <div id="avatarViewerImage" class="avatar-viewer-image" draggable="false">U</div>
            </div>
        </div>
    </div>

    <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-header">
                <div class="header-left">
                    <div class="user-avatar" id="userAvatar" onclick="openAvatarViewer()">U</div>
                    <span id="userName">用户</span>
                </div>
                <div class="header-right">
                    <div class="header-buttons">
                        <div class="notification-container">
                            <button class="header-btn" id="notificationBtn">
                                💬
                                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                            </button>
                            <div class="notification-dropdown" id="notificationDropdown">
                                <div class="notification-header">未读消息</div>
                                <div class="notification-list" id="notificationList">
                                </div>
                            </div>
                        </div>
                        <button class="header-btn" id="settingsBtn">⚙️</button>
                        <button class="header-btn" id="friendsBtn">👥</button>
                        <button class="header-btn" id="logoutBtn">🚪</button>
                    </div>
                </div>
            </div>
            
            <div class="chat-content">
                <div class="friends-sidebar hidden" id="friendsSidebar">
                    <div class="friends-header">
                        <span>好友列表</span>
                        <button class="close-sidebar" id="closeSidebar">×</button>
                    </div>
                    
                    <div class="friend-code-section">
                        <div class="form-label">我的好友码</div>
                        <div class="friend-code">
                            <div class="friend-code-text" id="friendCodeText">加载中...</div>
                            <button class="copy-btn" id="copyFriendCodeBtn">复制</button>
                        </div>
                    </div>
                    
                    <div class="add-friend-section">
                        <div class="form-label">添加好友</div>
                        <div class="add-friend-input">
                            <input type="text" class="friend-input" id="friendCodeInput" placeholder="输入好友码">
                            <button class="add-btn" id="addFriendBtn">添加</button>
                        </div>
                        <div id="addFriendMessage"></div>
                    </div>
                    
                    <div class="friends-list" id="friendsList">
                        <div class="friend-item official-friend" data-id="official">
                            <div class="friend-avatar official-avatar">
                                <span>客服</span>
                                <span class="official-badge">官方</span>
                            </div>
                            <div class="friend-name">在线客服</div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-area">
                    <div class="chat-messages" id="chatMessages">
                        <div class="no-friend-selected">
                            <div class="no-friend-icon">👤</div>
                            <div class="no-friend-text">请先选择好友开始聊天</div>
                            <div class="no-friend-hint">点击左侧好友列表选择一个好友，或添加新好友</div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <button class="emoji-btn" id="emojiBtn" disabled>😊</button>
                        <button class="sticker-btn" id="stickerBtn" disabled>😺</button>
                        <input type="text" class="chat-input" id="messageInput" placeholder="请先选择好友..." disabled>
                        <button class="send-btn" id="sendBtn" disabled>发送</button>
                    </div>
                    
<div class="emoji-picker" id="emojiPicker">
                    </div>
                    
                    <div class="sticker-picker" id="stickerPicker">
                        <div class="sticker-search">
                            <input type="text" class="sticker-input" id="stickerInput" placeholder="搜索表情包..." disabled>
                            <button class="sticker-search-btn" id="stickerSearchBtn" disabled>搜索</button>
                        </div>
                        <div class="sticker-results" id="stickerResults">
                            <div class="sticker-prompt">🔍 输入关键词搜索表情包</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteFriendModal">
        <div class="modal">
            <div class="modal-header">删除好友</div>
            <div class="modal-body" id="deleteFriendMessage">确定要删除好友吗？删除后将无法恢复。</div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelDeleteFriend">取消</button>
                <button class="modal-btn confirm" id="confirmDeleteFriend">删除</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay recall-modal" id="recallMessageModal">
        <div class="modal">
            <div class="modal-header">撤回消息</div>
            <div class="modal-body" id="recallMessageText">确定要撤回这条消息吗？撤回后对方将无法看到此消息。</div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelRecallMessage">取消</button>
                <button class="modal-btn confirm" id="confirmRecallMessage">撤回</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay success-modal" id="successModal">
        <div class="modal">
            <div class="modal-header">
                <div class="success-icon">✓</div>
                <span>注册成功</span>
            </div>
            <div class="modal-body">您的账号已成功创建！请使用您的用户名和密码登录。</div>
            <div class="modal-footer">
                <button class="modal-btn success" id="closeSuccessModal">确定</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay logout-modal" id="logoutConfirmModal">
        <div class="modal">
            <div class="modal-header">确认退出登录</div>
            <div class="modal-body">您确定要退出当前账户吗？</div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelLogout">取消</button>
                <button class="modal-btn confirm" id="confirmLogout">确认退出</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay settings-modal" id="settingsModal">
        <div class="modal">
            <div class="modal-header">设置</div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <div class="settings-tab active" id="profileTab">个人资料</div>
                    <div class="settings-tab" id="appearanceTab">外观</div>
                </div>
                
                <div class="settings-content">
                    <div class="settings-section" id="profileSettings">
                        <div class="form-group">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-input" id="usernameInput" placeholder="用户名" readonly>
</div>
                        <div class="form-group">
                            <label class="form-label">好友码</label>
                            <input type="text" class="form-input" id="friendCodeDisplay" placeholder="好友码" readonly>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="appearanceSettings" style="display: none;">
                        
                        <div class="form-group">
                            <label class="form-label">主题颜色预览</label>
                            <div class="theme-preview-container" id="themePreviewContainer">
                                <div class="theme-preview default" data-theme="default" title="默认蓝色">
                                    <span class="theme-name" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">默认</span>
                                </div>
                                <div class="theme-preview green" data-theme="green" title="绿色">
                                    <span class="theme-name" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">绿色</span>
                                </div>
                                <div class="theme-preview purple" data-theme="purple" title="紫色">
                                    <span class="theme-name" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">紫色</span>
                                </div>
                                <div class="theme-preview red" data-theme="red" title="红色">
                                    <span class="theme-name" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">红色</span>
                                </div>
                                <div class="theme-preview dark" data-theme="dark" title="深色模式">
                                    <span class="theme-name" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">深色</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label class="form-label">主题颜色</label>
                            <select class="form-input" id="themeSelect" title="选择主题颜色">
                                <option value="default">默认蓝色</option>
                                <option value="green">绿色</option>
                                <option value="purple">紫色</option>
                                <option value="red">红色</option>
                                <option value="dark">深色模式</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">字号更改</label>
                            <div class="font-size-controls">
                                <button id="decreaseFontBtn" class="font-control-btn" title="减小字号">
                                    <span class="font-icon">A-</span>
                                </button>
                                <div class="font-size-display" id="fontSizeDisplay">14px</div>
                                <button id="increaseFontBtn" class="font-control-btn" title="增大字号">
                                    <span class="font-icon">A+</span>
                                </button>
                                <button id="resetFontBtn" class="font-control-btn" title="重置字号">
                                    <span class="font-icon">A</span>
                                </button>
                                <input type="hidden" id="fontSizeValue" value="normal">
                            </div>
                        </div>
                        

                        
                        <div class="form-group" style="display: none;">
                            <label class="form-label">实时预览</label>
                            <label for="livePreviewCheckbox" style="display: flex; align-items: center;">
                <input type="checkbox" id="livePreviewCheckbox" checked style="margin-right: 8px;">
                实时预览
            </label>
                            <span>立即应用设置更改</span>
                        </div>
                        
                        <button class="auth-btn" id="saveAppearanceToCloudBtn" style="margin-top: 15px;">保存外观设置到云端</button>
                        <div id="appearanceMessage" class="modern-auth-message"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="closeSettingsModal">关闭</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rudtcwlggkaxykrhhdsn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZHRjd2xnZ2theHlrcmhoZHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzkyNjEsImV4cCI6MjA3NDkxNTI2MX0.Tb1zZvaRS2rppM1_7ka4WgpIh_PFxc4bLVHPG9T0AKg';
        
        const OFFICIAL_ACCOUNT_ID = 'official_account_id';
        
        const authContainer = document.getElementById('authContainer');
        const chatContainer = document.getElementById('chatContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingStatus = document.getElementById('loadingStatus');
        const authForms = document.getElementById('authForms');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const registerUsername = document.getElementById('registerUsername');
        const registerPassword = document.getElementById('registerPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const authMessage = document.getElementById('authMessage');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const settingsBtn = document.getElementById('settingsBtn');
        const friendsBtn = document.getElementById('friendsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const friendsSidebar = document.getElementById('friendsSidebar');
        const closeSidebar = document.getElementById('closeSidebar');
        const friendCodeText = document.getElementById('friendCodeText');
        const copyFriendCodeBtn = document.getElementById('copyFriendCodeBtn');
        const friendCodeInput = document.getElementById('friendCodeInput');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const addFriendMessage = document.getElementById('addFriendMessage');
        const friendsList = document.getElementById('friendsList');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const stickerBtn = document.getElementById('stickerBtn');
        const stickerPicker = document.getElementById('stickerPicker');
        const stickerInput = document.getElementById('stickerInput');
        const stickerSearchBtn = document.getElementById('stickerSearchBtn');
        const stickerResults = document.getElementById('stickerResults');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const notificationList = document.getElementById('notificationList');
        const deleteFriendModal = document.getElementById('deleteFriendModal');
        const deleteFriendMessage = document.getElementById('deleteFriendMessage');
        const cancelDeleteFriend = document.getElementById('cancelDeleteFriend');
        const confirmDeleteFriend = document.getElementById('confirmDeleteFriend');

        const contextMenu = document.createElement('div');
        contextMenu.id = 'customContextMenu';
        contextMenu.style.position = 'fixed';
        contextMenu.style.background = 'var(--background-color)';
        contextMenu.style.border = '1px solid var(--border-color, #ddd)';
        contextMenu.style.borderRadius = '8px';
        contextMenu.style.padding = '8px 0';
        contextMenu.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
        contextMenu.style.zIndex = '9999';
        contextMenu.style.display = 'none';
        contextMenu.style.minWidth = '120px';
        contextMenu.style.color = 'var(--text-color, #333)';
        
        const menuItems = [
            { id: 'paste', text: '粘贴', action: 'paste' },
            { id: 'copy', text: '复制', action: 'copy' },
            { id: 'selectAll', text: '全选', action: 'selectAll' },
            { id: 'clear', text: '清空', action: 'clear' },
            { id: 'refresh', text: '刷新页面', action: 'refresh' }
        ];
        
        menuItems.forEach(item => {
            const menuItem = document.createElement('div');
            menuItem.id = item.id;
            menuItem.className = 'context-menu-item';
            menuItem.textContent = item.text;
            menuItem.style.padding = '8px 16px';
            menuItem.style.cursor = 'pointer';
            menuItem.style.userSelect = 'none';
            menuItem.style.transition = 'background 0.2s';
            menuItem.style.fontSize = '0.9rem';
            menuItem.style.color = 'var(--text-color, #333)';
            menuItem.dataset.action = item.action;
            
            
            contextMenu.appendChild(menuItem);
        });
        
        document.body.appendChild(contextMenu);
        
        const inputElements = [
            messageInput,
            friendCodeInput,
            loginUsername,
            loginPassword,
            registerUsername,
            registerPassword,
            confirmPassword,
            stickerInput
        ];
        
        let activeInput = null;
        
        inputElements.forEach(input => {
            if (input) {
                input.addEventListener('focus', function() {
                    activeInput = this;
                
                });
                input.addEventListener('click', function() {
                    activeInput = this;
                });
                
                input.addEventListener('contextmenu', function(e) {
                    if (this.disabled) {
                        if (this === messageInput && !currentFriend) {
                            e.preventDefault()
                            document.querySelectorAll('.context-menu-item').forEach(item => {
                                item.style.display = 'none';
                        });
                            document.getElementById('refresh').style.display = 'block';
                        } else {
                            return; 
                        }
                    } else {
                        e.preventDefault();
                    
                        const hasSelection = window.getSelection().toString().length > 0;
                        
                        document.getElementById('copy').style.display = hasSelection ? 'block' : 'none';
                        
                        document.getElementById('paste').style.display = 'block';
                        
                        const isFriendCodeInput = this === friendCodeInput;
                        document.getElementById('selectAll').style.display = isFriendCodeInput ? 'none' : 'block';
                        document.getElementById('clear').style.display = isFriendCodeInput ? 'block' : 'none';
                        
                        if (this === messageInput && !currentFriend) {
                            document.getElementById('refresh').style.display = 'block';
                        } else {
                            document.getElementById('refresh').style.display = 'none';
                        }
                        const recallItem = document.getElementById('recall');
                        if (recallItem) {
                            recallItem.style.display = 'none';
                        }
                    }
                    
                    const rect = this.getBoundingClientRect();
                    const menu = document.getElementById('customContextMenu');
                
                    let left = e.clientX;
                    let top = e.clientY;
                    
                    const isMessageInput = this === messageInput;
                    if (isMessageInput) {
                        const menuHeight = menu.offsetHeight || 100; 
                        if (top > window.innerHeight * 0.7) { 
                            top = e.clientY - menuHeight - 10; 
                        }
                    }
                    
                    if (left + menu.offsetWidth > window.innerWidth) {
                        left = window.innerWidth - menu.offsetWidth;
                    }
                    if (top + menu.offsetHeight > window.innerHeight) {
                        top = window.innerHeight - menu.offsetHeight;
                    }
                    if (top < 0) {
                        top = 0;
                    }
                    
                    menu.style.left = left + 'px';
                    menu.style.top = top + 'px';
                    menu.style.display = 'block';
                    
                    return false;
                });
            }
        });
        
        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const action = this.dataset.action;
                const elementType = this.dataset.elementType;
                const messageId = this.dataset.messageId;
                const menu = document.getElementById('customContextMenu');
                
                if (elementType === 'message') {
                    if (this.id === 'copy' || action === 'copy') {
                        const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                        if (messageElement) {
                            const messageTextElement = messageElement.querySelector('.message-text');
                            let messageText = '';
                            
                            const imgElement = messageTextElement.querySelector('img');
                            if (imgElement && messageTextElement.children.length === 1) {
                                messageText = imgElement.src;
                            } else {
                                messageText = messageTextElement.textContent;
                            }
                            
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(messageText)
                                    .then(() => {
                                        console.log('消息已复制到剪贴板');
                                    })
                                    .catch(err => {
                                        console.error('复制消息失败: ', err);
                                        const tempInput = document.createElement('textarea');
                                        tempInput.style.position = 'fixed';
                                        tempInput.style.left = '-9999px';
                                        tempInput.value = messageText;
                                        document.body.appendChild(tempInput);
                                        tempInput.select();
                                        tempInput.setSelectionRange(0, 99999); 
                                        try {
                                            const successful = document.execCommand('copy');
                                            if (successful) {
                                                console.log('备用复制方法成功');
                                            }
                                        } catch (fallbackErr) {
                                            console.error('备用复制方法也失败: ', fallbackErr);
                                        } finally {
                                            document.body.removeChild(tempInput);
                                        }
                                    });
                            } else {
                                const tempInput = document.createElement('textarea');
                                tempInput.style.position = 'fixed';
                                tempInput.style.left = '-9999px';
                                tempInput.value = messageText;
                                document.body.appendChild(tempInput);
                                tempInput.select();
                                tempInput.setSelectionRange(0, 99999); 
                                try {
                                    const successful = document.execCommand('copy');
                                    if (successful) {
                                        console.log('回退复制方法成功');
                                    }
                                } catch (fallbackErr) {
                                    console.error('复制消息失败: ', fallbackErr);
                                } finally {
                                    document.body.removeChild(tempInput);
                                }
                            }
                        }
                    }
                }
                else if (activeInput && activeInput.focus) {
                    activeInput.focus();
                    
                    switch(action) {
                        case 'paste':
                            async function smartPaste() {
                                const isEdge = /Edge\//i.test(navigator.userAgent) || /Edg\//i.test(navigator.userAgent);
                                const isFirefox = /Firefox\//i.test(navigator.userAgent);
                                const isChrome = /Chrome\//i.test(navigator.userAgent) && !isEdge;
                                
                                console.log('执行智能粘贴，浏览器检测:', { isEdge, isFirefox, isChrome });
                                
                                try {
                                    
                                    if (navigator.clipboard && window.isSecureContext) {
                                        try {
                                            const text = await navigator.clipboard.readText();
                                            if (text) {
                                                const start = activeInput.selectionStart;
                                                const end = activeInput.selectionEnd;
                                                const value = activeInput.value;
                                                 
                                                activeInput.value = value.slice(0, start) + text + value.slice(end);
                                                activeInput.selectionStart = activeInput.selectionEnd = start + text.length;
                                                return true;
                                            }
                                        } catch (clipboardErr) {
                                            console.warn('现代剪贴板API失败，尝试备用方法: ', clipboardErr);
                                        }
                                    }
                                    
                                    try {
                                        activeInput.focus();
                                        activeInput.setSelectionRange(activeInput.selectionStart, activeInput.selectionStart);
                                        const successful = document.execCommand('paste');
                                        if (successful) {
                                            console.log('使用execCommand粘贴成功');
                                            return true;
                                        }
                                    } catch (execErr) {
                                        console.warn('execCommand粘贴失败: ', execErr);
                                    }
                                    
                                    try {
                                        const tempInput = document.createElement('textarea');
                                        tempInput.style.position = 'fixed';
                                        tempInput.style.left = '-9999px';
                                        tempInput.style.top = '-9999px';
                                        tempInput.style.opacity = '0';
                                        tempInput.style.pointerEvents = 'none';
                                        tempInput.style.zIndex = '-1';
                                        tempInput.style.width = '1px';
                                        tempInput.style.height = '1px';
                                        tempInput.style.border = 'none';
                                        tempInput.style.outline = 'none';
                                        tempInput.style.resize = 'none';
                                        tempInput.style.background = 'transparent';
                                        tempInput.style.color = 'transparent';
                                        
                                        document.body.appendChild(tempInput);
                                        
                                        tempInput.autofocus = true;
                                        
                                        tempInput.focus();
                                        tempInput.select();
                                        
                                        await new Promise(resolve => setTimeout(resolve, 100));
                                        
                                        if (isFirefox) {
                                            tempInput.setSelectionRange(0, 999999);
                                        }
                                        
                                        const pasteSuccessful = document.execCommand('paste');
                                        
                                        if (pasteSuccessful && tempInput.value) {
                                            const pastedText = tempInput.value;
                                            if (pastedText) {
                                                const start = activeInput.selectionStart;
                                                const end = activeInput.selectionEnd;
                                                const value = activeInput.value;
                                                  
                                                activeInput.value = value.slice(0, start) + pastedText + value.slice(end);
                                                activeInput.selectionStart = activeInput.selectionEnd = start + pastedText.length;
                                                
                                                activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                                                console.log('使用临时元素粘贴成功');
                                                return true;
                                            }
                                        }
                                    } catch (tempErr) {
                                        console.warn('临时元素粘贴失败: ', tempErr);
                                    } finally {
                                        const tempElements = document.querySelectorAll('textarea[style*="left: -9999px"]');
                                        tempElements.forEach(el => {
                                            if (el.parentNode) {
                                                el.parentNode.removeChild(el);
                                            }
                                        });
                                    }
                                    
                                    console.error('所有粘贴方法都失败，请手动使用快捷键Ctrl+V粘贴');
                                    showPasteNotification(activeInput, '粘贴操作被浏览器阻止，请尝试使用快捷键 Ctrl+V 或右键菜单粘贴');
                                    return false;
                                } finally {
                                    activeInput.focus();
                                }
                            }
                            
                            function showPasteNotification(targetElement, message) {
                                let notification = document.getElementById('paste-notification');
                                
                                if (!notification) {
                                    notification = document.createElement('div');
                                    notification.id = 'paste-notification';
                                    notification.style.cssText = `
                                        position: fixed;
                                        padding: 12px 20px;
                                        background-color: #333;
                                        color: white;
                                        border-radius: 4px;
                                        font-size: 14px;
                                        z-index: 9999;
                                        opacity: 0;
                                        transition: opacity 0.3s, transform 0.3s;
                                        transform: translateY(-10px);
                                        pointer-events: none;
                                        max-width: 300px;
                                        text-align: center;
                                    `;
                                    document.body.appendChild(notification);
                                }
                                
                                notification.textContent = message;
                                
                                if (targetElement) {
                                    const rect = targetElement.getBoundingClientRect();
                                    notification.style.left = `${rect.left + rect.width / 2 - 150}px`;
                                    notification.style.bottom = `${window.innerHeight - rect.top + 20}px`;
                                } else {
                                    notification.style.left = '50%';
                                    notification.style.transform = 'translate(-50%, -10px)';
                                }
                                notification.style.opacity = '1';
                                notification.style.transform = targetElement ? 'translateY(0)' : 'translate(-50%, 0)';
                                
                                setTimeout(() => {
                                    notification.style.opacity = '0';
                                    notification.style.transform = targetElement ? 'translateY(-10px)' : 'translate(-50%, -10px)';
                                    
                                    setTimeout(() => {
                                        if (notification.parentNode) {
                                            notification.parentNode.removeChild(notification);
                                        }
                                    }, 300);
                                }, 3000);
                            }
                            
                            smartPaste();
                            break;
                        case 'copy':
                            try {
                                if (navigator.clipboard && window.isSecureContext) {
                                    const selectedText = window.getSelection().toString();
                                    if (selectedText) {
                                        navigator.clipboard.writeText(selectedText)
                                            .then(() => {
                                                console.log('文本已复制到剪贴板');
                                            })
                                            .catch(err => {
                                                console.warn('现代剪贴板API失败，使用备用方法: ', err);
                                                fallbackCopy();
                                            });
                                    }
                                } else {
                                    fallbackCopy();
                                }
                            } catch (err) {
                                console.error('复制失败: ', err);
                                try {
                                    activeInput.focus();
                                    if (!document.execCommand('copy')) {
                                        const tempTextArea = document.createElement('textarea');
                                        tempTextArea.style.position = 'fixed';
                                        tempTextArea.style.left = '-9999px';
                                        tempTextArea.value = window.getSelection().toString();
                                        document.body.appendChild(tempTextArea);
                                        tempTextArea.select();
                                        tempTextArea.setSelectionRange(0, 99999);
                                        document.execCommand('copy');
                                        document.body.removeChild(tempTextArea);
                                    }
                                } catch (finalErr) {
                                    console.error('所有复制方法都失败: ', finalErr);
                                }
                            }
                            
                            function fallbackCopy() {
                                try {
                                    activeInput.focus();
                                    const successful = document.execCommand('copy');
                                    if (successful) {
                                        console.log('使用execCommand复制成功');
                                        return;
                                    }
                                    throw new Error('execCommand复制失败');
                                } catch (fallbackErr) {
                                    console.error('备用复制方法失败: ', fallbackErr);
                                    try {
                                        const tempTextArea = document.createElement('textarea');
                                        tempTextArea.style.position = 'fixed';
                                        tempTextArea.style.left = '-9999px';
                                        tempTextArea.style.top = '-9999px';
                                        tempTextArea.style.opacity = '0';
                                        tempTextArea.style.pointerEvents = 'none';
                                        tempTextArea.style.zIndex = '-1';
                                        tempTextArea.style.width = '1px';
                                        tempTextArea.style.height = '1px';
                                        tempTextArea.style.border = 'none';
                                        tempTextArea.style.outline = 'none';
                                        tempTextArea.style.resize = 'none';
                                        tempTextArea.style.background = 'transparent';
                                        tempTextArea.style.color = 'transparent';
                                        
                                        const selectedText = window.getSelection().toString() || activeInput.value.substring(
                                            activeInput.selectionStart,
                                            activeInput.selectionEnd
                                        );
                                        
                                        tempTextArea.value = selectedText;
                                        document.body.appendChild(tempTextArea);
                                        
                                        tempTextArea.select();
                                        
                                        if (isFirefox) {
                                            try {
                                                tempTextArea.setSelectionRange(0, selectedText.length);
                                            } catch (e) {
                                                tempTextArea.createTextRange().select();
                                            }
                                        }
                                        
                                        const copyResult = document.execCommand('copy');
                                        if (copyResult) {
                                            console.log('使用临时元素复制成功');
                                        }
                                    } catch (tempErr) {
                                        console.error('临时元素复制也失败: ', tempErr);
                                    } finally {
                                        const tempElements = document.querySelectorAll('textarea[style*="left: -9999px"]');
                                        tempElements.forEach(el => {
                                            if (el.parentNode) {
                                                el.parentNode.removeChild(el);
                                            }
                                        });
                                    }
                                }
                            }
                            break;
                        case 'selectAll':
                            activeInput.select();
                            break;
                        case 'clear':
                            activeInput.value = '';
                            break;
                        case 'refresh':
                            location.reload();
                            break;
                    }
                } else if (action === 'refresh') {
                    location.reload();
                }
                
                menu.style.display = 'none';
                document.querySelectorAll('.context-menu-item').forEach(item => {
                    delete item.dataset.messageId;
                    delete item.dataset.elementType;
                });
            });
        });
        
        document.addEventListener('click', function() {
            document.getElementById('customContextMenu').style.display = 'none';
        });
        
        document.addEventListener('contextmenu', function(e) {
            const isInputElement = inputElements.some(input => {
                return input && (input === e.target || input.contains(e.target));
            });
            
            if (!isInputElement) {
                e.preventDefault();
                
                const menu = document.getElementById('customContextMenu');
                menu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.style.display = 'none';
                });
                
                document.getElementById('refresh').style.display = 'block';
                
                let left = e.clientX;
                let top = e.clientY;
                
                if (left + menu.offsetWidth > window.innerWidth) {
                    left = window.innerWidth - menu.offsetWidth;
                }
                if (top + menu.offsetHeight > window.innerHeight) {
                    top = window.innerHeight - menu.offsetHeight;
                }
                if (top < 0) {
                    top = 0;
                }
                
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                menu.style.display = 'block';
                
                return false;
            }
        });
        const recallMessageModal = document.getElementById('recallMessageModal');
        const recallMessageText = document.getElementById('recallMessageText');
        const cancelRecallMessage = document.getElementById('cancelRecallMessage');
        const confirmRecallMessage = document.getElementById('confirmRecallMessage');
        const successModal = document.getElementById('successModal');
        const closeSuccessModal = document.getElementById('closeSuccessModal');
        const settingsModal = document.getElementById('settingsModal');
        const profileTab = document.getElementById('profileTab');
        const appearanceTab = document.getElementById('appearanceTab');
        const profileSettings = document.getElementById('profileSettings');
        const appearanceSettings = document.getElementById('appearanceSettings');
        const usernameInput = document.getElementById('usernameInput');
        const friendCodeDisplay = document.getElementById('friendCodeDisplay');
        const themeSelect = document.getElementById('themeSelect');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const decreaseFontBtn = document.getElementById('decreaseFontBtn');
        const resetFontBtn = document.getElementById('resetFontBtn');
        const increaseFontBtn = document.getElementById('increaseFontBtn');
        const saveAppearanceBtn = document.getElementById('saveAppearanceBtn');
        const appearanceMessage = document.getElementById('appearanceMessage');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        
        let supabase = null;
        let currentUser = null;
        let isConnected = false;
        let messageSubscription = null;
        let friendsSubscription = null;
        let currentFriend = null;
        let friends = [];
        let isSendingMessage = false;
        let pendingMessages = new Map();
        let isEmojiPickerOpen = false;
        let isStickerPickerOpen = false;
        let processedMessageIds = new Set();
        let friendToDelete = null;
        let messageToRecall = null;
        let unreadMessages = new Map();
        let notificationMessages = new Map();
        let currentStickerKeyword = '';
        let loadedStickerUrls = new Set();
        
        function setupPasswordToggles() {
            const toggleLoginPassword = document.getElementById('toggleLoginPassword');
            const loginPassword = document.getElementById('loginPassword');
            
            if (toggleLoginPassword && loginPassword) {
                toggleLoginPassword.addEventListener('click', function() {
                    const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                    loginPassword.setAttribute('type', type);
                    this.textContent = type === 'password' ? '👁️' : '👁️‍🗨️';
                });
            }
            
            const toggleRegisterPassword = document.getElementById('toggleRegisterPassword');
            const registerPassword = document.getElementById('registerPassword');
            
            if (toggleRegisterPassword && registerPassword) {
                toggleRegisterPassword.addEventListener('click', function() {
                    const type = registerPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                    registerPassword.setAttribute('type', type);
                    this.textContent = type === 'password' ? '👁️' : '👁️‍🗨️';
                });
            }
            
            const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            
            if (toggleConfirmPassword && confirmPassword) {
                toggleConfirmPassword.addEventListener('click', function() {
                    const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                    confirmPassword.setAttribute('type', type);
                    this.textContent = type === 'password' ? '👁️' : '👁️‍🗨️';
                });
            }
        }
        
        function setupFormValidation() {
            loginUsername.addEventListener('input', function() {
                const errorElement = document.getElementById('loginUsernameError');
                if (this.value.trim() === '') {
                    this.classList.add('error');
                    errorElement.textContent = '用户名不能为空';
                    errorElement.classList.add('visible');

                    setTimeout(() => {
                        this.classList.remove('error');
                    }, 300);
                } else {
                    this.classList.remove('error');
                    errorElement.textContent = '';
                    errorElement.classList.remove('visible');
                }
            });
            
            loginPassword.addEventListener('input', function() {
                const errorElement = document.getElementById('loginPasswordError');
                if (this.value === '') {
                    this.classList.add('error');
                    errorElement.textContent = '密码不能为空';
                    errorElement.classList.add('visible');
                    
                    setTimeout(() => {
                        this.classList.remove('error');
                    }, 300);
                } else {
                    this.classList.remove('error');
                    errorElement.textContent = '';
                    errorElement.classList.remove('visible');
                }
            });
            
            registerUsername.addEventListener('input', function() {
                const errorElement = document.getElementById('registerUsernameError');
                if (this.value.trim() === '') {
                    this.classList.add('error');
                    errorElement.textContent = '用户名不能为空';
                    errorElement.classList.add('visible');
                    
                    setTimeout(() => {
                        this.classList.remove('error');
                    }, 300);
                } else if (this.value.includes(' ')) {
                    this.classList.add('error');
                    errorElement.textContent = '用户名不能包含空格';
                    errorElement.classList.add('visible');
                    
                    setTimeout(() => {
                        this.classList.remove('error');
                    }, 300);
                } else {
                    this.classList.remove('error');
                    errorElement.textContent = '';
                    errorElement.classList.remove('visible');
                }
            });
            
            registerPassword.addEventListener('input', function() {
                const errorElement = document.getElementById('registerPasswordError');
                if (this.value === '') {
                    this.classList.add('error');
                    errorElement.textContent = '密码不能为空';
                    errorElement.classList.add('visible');
                    
                    setTimeout(() => {
                        this.classList.remove('error');
                    }, 300);
                } else if (this.value.length < 6) {
                    this.classList.add('error');
                    errorElement.textContent = '密码至少需要6个字符';
                    errorElement.classList.add('visible');
                    
                    setTimeout(() => {
                        this.classList.remove('error');
                    }, 300);
                } else {
                    this.classList.remove('error');
                    errorElement.textContent = '';
                    errorElement.classList.remove('visible');
                    validateConfirmPassword();
                }
            });
            
            confirmPassword.addEventListener('input', validateConfirmPassword);
            
            function validateConfirmPassword() {
                const errorElement = document.getElementById('confirmPasswordError');
                if (confirmPassword.value === '') {
                    confirmPassword.classList.add('error');
                    errorElement.textContent = '请确认密码';
                    errorElement.classList.add('visible');
                    
                    setTimeout(() => {
                        confirmPassword.classList.remove('error');
                    }, 300);
                } else if (confirmPassword.value !== registerPassword.value) {
                    confirmPassword.classList.add('error');
                    errorElement.textContent = '两次输入的密码不一致';
                    errorElement.classList.add('visible');
                    
                    setTimeout(() => {
                        confirmPassword.classList.remove('error');
                    }, 300);
                } else {
                    confirmPassword.classList.remove('error');
                    errorElement.textContent = '';
                    errorElement.classList.remove('visible');
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.official-friend .friend-actions').forEach(btn => {
        btn.style.display = 'none';
    });
    
    const loadingSpinner = document.querySelector('.loading-spinner');
    const spinnerRing = document.querySelector('.spinner-ring');
    
    if (loadingSpinner) {
        loadingSpinner.style.animationPlayState = 'running';
    }
    if (spinnerRing) {
        spinnerRing.style.animationPlayState = 'running';
    }
    
    applyTheme('default');
    
    authContainer.style.display = 'block';
    loadingContainer.style.display = 'flex';
    authForms.style.display = 'none';
            loginTab.addEventListener('click', () => switchAuthTab('login'));
            registerTab.addEventListener('click', () => switchAuthTab('register'));
            
            setupPasswordToggles();
            
            setupFormValidation();
            
            loginBtn.addEventListener('click', handleLogin);
            registerBtn.addEventListener('click', handleRegister);
            
            loginUsername.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            loginPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            registerUsername.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            registerPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            confirmPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            loginUsername.addEventListener('input', function() {
                validateField(this, 'username', loginForm);
            });
            
            loginPassword.addEventListener('input', function() {
                validateField(this, 'password', loginForm);
            });
            
            registerUsername.addEventListener('input', function() {
                validateField(this, 'username', registerForm);
            });
            
            registerPassword.addEventListener('input', function() {
                validateField(this, 'password', registerForm);
                if (confirmPassword.value) {
                    validateField(confirmPassword, 'confirmPassword', registerForm);
                }
            });
            
            confirmPassword.addEventListener('input', function() {
                validateField(this, 'confirmPassword', registerForm);
            });
            
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isSendingMessage) sendMessage();
            });
            
            logoutBtn.addEventListener('click', function() {
                document.getElementById('logoutConfirmModal').classList.add('show');
            });
            
            document.getElementById('confirmLogout').addEventListener('click', function() {
                document.getElementById('logoutConfirmModal').classList.remove('show');
                handleLogout();
            });
            
            document.getElementById('cancelLogout').addEventListener('click', function() {
                document.getElementById('logoutConfirmModal').classList.remove('show');
            });
            friendsBtn.addEventListener('click', toggleFriendsSidebar);
            settingsBtn.addEventListener('click', openSettings);
            closeSidebar.addEventListener('click', toggleFriendsSidebar);
            copyFriendCodeBtn.addEventListener('click', copyFriendCode);
            addFriendBtn.addEventListener('click', addFriend);
            emojiBtn.addEventListener('click', toggleEmojiPicker);
            stickerBtn.addEventListener('click', toggleStickerPicker);
            stickerSearchBtn.addEventListener('click', searchStickers);
            
            stickerInput.addEventListener('keypress', function(e) {
                if (!currentFriend) return;
                if (e.key === 'Enter') searchStickers();
            });
            
            stickerResults.addEventListener('wheel', function(e) {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    this.scrollLeft += e.deltaY;
                }
            }, { passive: false });
            
            notificationBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleNotificationDropdown(e);
            });
            
            profileTab.addEventListener('click', () => switchSettingsTab('profile'));
            appearanceTab.addEventListener('click', () => switchSettingsTab('appearance'));
            closeSettingsModal.addEventListener('click', closeSettings);
            
            document.addEventListener('click', function(e) {
                if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                    notificationDropdown.classList.remove('show');
                }
                
                if (isEmojiPickerOpen && !emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
                    closeEmojiPicker();
                }
                
                if (isStickerPickerOpen && !stickerPicker.contains(e.target) && !stickerBtn.contains(e.target)) {
                    closeStickerPicker();
                }
            });
            
            cancelDeleteFriend.addEventListener('click', () => {
                deleteFriendModal.classList.remove('show');
                friendToDelete = null;
});
            
            confirmDeleteFriend.addEventListener('click', deleteFriend);
            
            cancelRecallMessage.addEventListener('click', () => {
                recallMessageModal.classList.remove('show');
                messageToRecall = null;
            });
            
            confirmRecallMessage.addEventListener('click', () => {
                if (messageToRecall) recallMessage(messageToRecall);
                recallMessageModal.classList.remove('show');
                messageToRecall = null;
            });
            
            closeSuccessModal.addEventListener('click', () => {
                successModal.classList.remove('show');
            });
            
            initializeSupabase();
            initializeEmojiPicker();
            loadSettings();
        });
 
        function toggleNotificationDropdown(e) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            
            const isShowing = notificationDropdown.classList.contains('show');
            
            closeEmojiPicker();
            closeStickerPicker();
            
            if (isShowing) {
                notificationDropdown.classList.remove('show');
            } else {
                notificationDropdown.classList.add('show');
                updateNotificationDropdown(); 
            }
        }
        
        function updateNotificationBadge() {
            let totalUnread = 0;
            unreadMessages.forEach(count => totalUnread += count);
            
            if (totalUnread > 0) {
                notificationBadge.style.display = 'flex';
                notificationBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
            } else {
                notificationBadge.style.display = 'none';
            }
        }
        
        function updateNotificationDropdown() {
            notificationList.innerHTML = '';
            
            if (notificationMessages.size === 0) {
                notificationList.innerHTML = '<div class="no-notifications">暂无未读消息</div>';
                return;
            }
            
            Array.from(notificationMessages.entries()).forEach(([friendId, messages]) => {
                const friend = friends.find(f => f.friend_id === friendId);
                if (friend && messages.length > 0) {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'notification-item';
                    
                    const unreadCount = unreadMessages.get(friendId) || 0;
                    const latestMessage = messages[messages.length - 1];
                    
                    notificationItem.innerHTML = `
                        <div style="flex: 1;">
                            <div class="notification-friend-name">${friend.profiles.username}</div>
                            <div class="notification-message-preview">${escapeHtml(latestMessage.content)}</div>
                        </div>
                        <span class="notification-count">${unreadCount}</span>
                    `;
                    
                    notificationItem.addEventListener('click', () => {
                        selectFriend(friend.profiles);
                        unreadMessages.set(friendId, 0);
                        notificationMessages.delete(friendId);
                        updateNotificationBadge();
                        updateNotificationDropdown();
                        notificationDropdown.classList.remove('show');
                    });
                    
                    notificationList.appendChild(notificationItem);
                }
            });
        }
        
        function addNotificationMessage(message) {
            const friendId = message.sender_id;
            if (!notificationMessages.has(friendId)) {
                notificationMessages.set(friendId, []);
            }
            
            const messages = notificationMessages.get(friendId);
            messages.push(message);
            
            if (messages.length > 5) messages.shift();
            
            updateNotificationDropdown();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function toggleFriendsSidebar() {
            friendsSidebar.classList.toggle('hidden');
        }
        
        function openSettings() {
            loadUserProfile();
            settingsModal.classList.add('show');
        }
        
        function closeSettings() {
            settingsModal.classList.remove('show');
        }
        
        function switchSettingsTab(tab) {
            if (tab === 'profile') {
                profileTab.classList.add('active');
                appearanceTab.classList.remove('active');
                profileSettings.style.display = 'block';
                appearanceSettings.style.display = 'none';
            } else {
                profileTab.classList.remove('active');
                appearanceTab.classList.add('active');
                profileSettings.style.display = 'none';
                appearanceSettings.style.display = 'block';
            }
        }
        
        function loadUserProfile() {
            if (!currentUser) return;
            
            const username = currentUser.user_metadata?.username || '用户';
            usernameInput.value = username;
            friendCodeDisplay.value = friendCodeText.textContent;
        }
        
        function saveAppearance() {
        }
        
        const livePreviewCheckbox = document.getElementById('livePreviewCheckbox');
        const themePreviewContainer = document.getElementById('themePreviewContainer');
        
        function initThemePreviews() {
            const previews = themePreviewContainer.querySelectorAll('.theme-preview');
            previews.forEach(preview => {
                preview.addEventListener('click', () => {
                    const theme = preview.dataset.theme;
                    themeSelect.value = theme;
                    updateThemePreviews(theme);
                    
                    autoSaveAppearanceSettings();
                });
            });
        }
        
        function updateThemeSelectOptions() {
            const systemOption = Array.from(themeSelect.options).find(option => option.value === 'system');
            if (systemOption) {
                themeSelect.removeChild(systemOption);
            }
        }
        
        function updateThemePreviewOptions() {
            const systemPreview = document.querySelector('.theme-preview.system');
            if (systemPreview) {
                themePreviewContainer.removeChild(systemPreview);
            }
        }
        
        function updateThemePreviews(selectedTheme) {
            const previews = themePreviewContainer.querySelectorAll('.theme-preview');
            previews.forEach(preview => {
                if (preview.dataset.theme === selectedTheme) {
                    preview.classList.add('active');
                } else {
                    preview.classList.remove('active');
                }
            });
        }
        
        function previewAppearanceSettings() {
            const theme = themeSelect.value;
            const fontSize = fontSizeValue.value;
            
            document.body.classList.remove('theme-default', 'theme-green', 'theme-purple', 'theme-red', 'theme-dark');
            document.body.classList.remove('font-small', 'font-normal', 'font-large', 'font-xlarge');
            
            document.body.classList.add(`theme-${theme}`);
            document.body.classList.add(`font-${fontSize}`);
        }
        
        function detectSystemThemePreference() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default';
        }
        
        function setupSystemThemeListener() {
            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (e) => {
                });
            }
        }
        
        let meteorEffectInitialized = false;
        
        const randomRange = (min, max) => Math.random() * (max - min) + min;
        
        function initMeteorEffect() {
            const STAR_COUNT = 10; 
            const FIXED_STAR_COUNT = 300; 
            const MAX_DELAY = 10000; 

            const nightSky = document.getElementById("nightSky");
            const meteorContainer = document.getElementById("meteorContainer");
            
            nightSky.innerHTML = '';
            meteorContainer.innerHTML = '';
            
            for (let i = 0; i < FIXED_STAR_COUNT; i++) {
                const fixedStar = document.createElement("div");
                fixedStar.classList.add("star");
                fixedStar.style.left = `${randomRange(0, 100)}vw`;
                fixedStar.style.top = `${randomRange(0, 100)}vh`;
                fixedStar.style.width = `${randomRange(0.5, 2)}px`;
                fixedStar.style.height = fixedStar.style.width;
                fixedStar.style.animationDelay = `${randomRange(0, 3)}s`;
                nightSky.appendChild(fixedStar);
            }

            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            for (let i = 0; i < STAR_COUNT; i++) {
                const star = document.createElement("div");
                star.classList.add("shooting_star");
                const top = randomRange(0, windowWidth / 2);
                const left = randomRange(0, windowHeight / 2);
                const delay = randomRange(0, MAX_DELAY);

                star.style.top = `${top}px`;
                star.style.left = `${left}px`;
                star.style.animationDelay = `${delay}ms`;

                meteorContainer.appendChild(star);
            }
            
            nightSky.style.display = 'block';
            meteorContainer.style.display = 'block';
            
            meteorEffectInitialized = true;
        }
        
        function stopMeteorEffect() {
            const nightSky = document.getElementById("nightSky");
            const meteorContainer = document.getElementById("meteorContainer");
            
            nightSky.style.display = 'none';
            meteorContainer.style.display = 'none';
            
            nightSky.innerHTML = '';
            meteorContainer.innerHTML = '';
            
            meteorEffectInitialized = false;
        }
        
        let fontSizeDebounceTimer;
        let lastAppliedFontSize = 14;
        function applyTheme(theme) {
            document.body.classList.remove('theme-default', 'theme-green', 'theme-purple', 'theme-red', 'theme-dark');
            document.body.classList.add(`theme-${theme}`);
            document.documentElement.setAttribute('data-theme', theme);
            
            if (theme === 'dark') {
                if (!meteorEffectInitialized) {
                    initMeteorEffect();
                }
            } else {
                if (meteorEffectInitialized) {
                    stopMeteorEffect();
                }
            }
            
            if (window.contextMenu) {
                const computedStyle = window.getComputedStyle(document.body);
                window.contextMenu.style.background = computedStyle.getPropertyValue('--background-color');
                window.contextMenu.style.borderColor = computedStyle.getPropertyValue('--border-color');
                window.contextMenu.style.color = computedStyle.getPropertyValue('--text-color');
            }
        }
        
        function applyFontSizeOptimized(fontSize, theme = null) {
            if (fontSizeDebounceTimer) {
                clearTimeout(fontSizeDebounceTimer);
            }
            
            if (fontSize === lastAppliedFontSize) {
                return;
            }
            
            fontSizeDebounceTimer = setTimeout(() => {
                lastAppliedFontSize = fontSize;
                
                requestAnimationFrame(() => {
                    document.documentElement.style.setProperty('--body-font-size', `${fontSize}px`);
                    
                    if (fontSizeDisplay) {
                        fontSizeDisplay.textContent = `${fontSize}px`;
                    }
                    
                    updateFontButtonsState(fontSize);
                    
                    localStorage.setItem('userFontSize', fontSize.toString());
                    
                    if (theme) {
                        applyTheme(theme);
                    }
                    
                    const event = new CustomEvent('fontSizeChanged', { detail: { fontSize } });
                    document.dispatchEvent(event);
                    
                    console.log(`字体大小已优化更新为: ${fontSize}px`);
                });
            }, 100);
        }
        
        function applyAppearanceSettings(theme, fontSize) {
            applyTheme(theme);
            applyFontSizeOptimized(fontSize, theme);
        }
        
        function initAppearanceListeners() {
            themeSelect.addEventListener('change', () => {
                updateThemePreviews(themeSelect.value);
                autoSaveAppearanceSettings();
            });
            
            decreaseFontBtn.addEventListener('click', () => {
                let currentSize = parseInt(fontSizeValue.value);
                if (currentSize > 12) {
                    currentSize -= 1;
                    fontSizeValue.value = currentSize.toString();
                    applyFontSizeOptimized(currentSize);
                }
            });
            
            resetFontBtn.addEventListener('click', () => {
                const defaultSize = 14;
                fontSizeValue.value = defaultSize.toString();
                applyFontSizeOptimized(defaultSize);
            });
            
            increaseFontBtn.addEventListener('click', () => {
                let currentSize = parseInt(fontSizeValue.value);
                if (currentSize < 24) {
                    currentSize += 1;
                    fontSizeValue.value = currentSize.toString();
                    applyFontSizeOptimized(currentSize);
                }
            });
            
            const saveAppearanceToCloudBtn = document.getElementById('saveAppearanceToCloudBtn');
            if (saveAppearanceToCloudBtn) {
                saveAppearanceToCloudBtn.addEventListener('click', saveAppearanceSettingsToCloud);
            }
        }
        
        async function saveAppearanceSettingsToCloud() {
            if (!supabase || !currentUser) {
                showAppearanceMessage('请先登录', 'error');
                return;
            }
            
            const theme = themeSelect.value;
            const fontSize = parseInt(fontSizeValue.value); 
            
            if (isNaN(fontSize) || fontSize < 12 || fontSize > 24) {
                showAppearanceMessage('字体大小无效，请输入12-24之间的数字', 'error');
                return;
            }
            
            try {
                console.log('保存设置到云端 - 主题:', theme, '字体大小:', fontSize);
                
                const { data: existingSettings, error: selectError } = await supabase
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .limit(1);
                
                let result;
                
                if (selectError && selectError.code !== 'PGRST301') {
                    console.error('检查现有设置失败:', selectError);
                }
                
                if (selectError && selectError.code === 'PGRST301') {
                    console.log('user_settings表不存在，跳过云端保存');
                    showAppearanceMessage('设置表不存在，设置仅保存在本地', 'error');
                    localStorage.setItem('userTheme', theme);
                    localStorage.setItem('userFontSize', fontSize.toString());
                    return;
                }
                
                if (selectError || !existingSettings || existingSettings.length === 0) {
                    result = await supabase
                        .from('user_settings')
                        .insert([{
                            user_id: currentUser.id,
                            theme: theme,
                            font_size: fontSize, 
                            updated_at: new Date().toISOString()
                        }]);
                } else {
                    result = await supabase
                        .from('user_settings')
                        .update({
                            theme: theme,
                            font_size: fontSize, 
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', currentUser.id);
                }
                
                if (result.error) {
                    throw result.error;
                }
                
                localStorage.setItem('userTheme', theme);
                localStorage.setItem('userFontSize', fontSize.toString());
                
                showAppearanceMessage('外观设置已保存到云端', 'success');
                console.log('设置保存成功');
                
            } catch (error) {
                console.error('保存外观设置到云端失败:', error);
                if (error.code === 'PGRST301') {
                    showAppearanceMessage('设置表不存在，请联系管理员', 'error');
                } else {
                    showAppearanceMessage('保存失败: ' + error.message, 'error');
                }
            }
        }
        function loadLocalAppearanceSettings() {
            console.log('使用本地外观设置');
            
            const oldFields = ['chat_theme', 'chat_font_size', 'font_size', 'theme'];
            oldFields.forEach(field => {
                if (localStorage.getItem(field)) {
                    localStorage.removeItem(field);
                    console.log(`已清理旧的本地存储字段: ${field}`);
                }
            });
            
            const savedTheme = localStorage.getItem('userTheme') || 'default';
            const savedFontSize = parseInt(localStorage.getItem('userFontSize')) || 14;
            
            const fontSize = isNaN(savedFontSize) || savedFontSize < 12 || savedFontSize > 24 ? 14 : savedFontSize;
            
            requestAnimationFrame(() => {
                themeSelect.value = savedTheme;
                fontSizeValue.value = fontSize.toString();
                
                applyTheme(savedTheme);
                applyFontSizeOptimized(fontSize);
                
                updateThemePreviews(savedTheme);
            });
        }

        async function loadAppearanceSettingsFromCloud() {
            if (!supabase || !currentUser) {
                console.log('未登录或Supabase未初始化，跳过云端设置加载');
                loadLocalAppearanceSettings();
                return;
            }
            
            try {
                console.log('开始从云端加载外观设置...');
                const { data: settings, error } = await supabase
                    .from('user_settings')
                    .select('theme, font_size')
                    .eq('user_id', currentUser.id)
                    .limit(1);
                
                if (error) {
                    if (error.code === 'PGRST301') {
                        console.log('user_settings表不存在，跳过云端设置加载');
                    } else {
                        console.error('从云端加载设置失败:', error);
                    }
                    loadLocalAppearanceSettings();
                    return;
                }
                
                let theme, fontSize;
                
                if (settings && settings.length > 0) {
                    theme = settings[0].theme || 'default';
                    
                    fontSize = parseInt(settings[0].font_size);
                    console.log('从Supabase获取的原始字体大小:', settings[0].font_size, '解析后:', fontSize);
                    
                    if (isNaN(fontSize) || fontSize < 12 || fontSize > 24) {
                        console.warn('Supabase中的font_size无效，使用默认值14px');
                        fontSize = 14;
                    }
                    console.log('最终使用的字体大小:', fontSize);
                } 
                else {
                    console.log('未从Supabase获取到设置，使用默认值');
                    theme = 'default';
                    fontSize = 14;
                }
                
                if (!fontSize || isNaN(fontSize)) {
                    console.warn('字体大小无效，使用默认值14px');
                    fontSize = 14;
                }
                
                console.log('应用设置到UI - 主题:', theme, '字体大小:', fontSize);
                
                requestAnimationFrame(() => {
                    themeSelect.value = theme;
                    fontSizeValue.value = fontSize.toString();
                    
                    applyTheme(theme);
                    applyFontSizeOptimized(fontSize);
                    
                    updateThemePreviews(theme);
                });
                
                localStorage.setItem('userTheme', theme);
                localStorage.setItem('userFontSize', fontSize.toString());
                
                console.log('云端外观设置加载完成');
                console.log('字体大小设置已成功应用:', fontSize);
                
            } catch (error) {
                console.error('加载外观设置时出错:', error);
                
                try {
                    loadLocalAppearanceSettings();
                    console.log('出错时从本地存储恢复设置');
                } catch (fallbackError) {
                    console.error('从本地存储恢复设置失败:', fallbackError);
                }
            }
        }
        
        function autoSaveAppearanceSettings() {
            const theme = themeSelect.value;
            const fontSize = parseInt(fontSizeValue.value);
            
            applyAppearanceSettings(theme, fontSize);
        }
        
        function updateFontButtonsState(fontSize) {
            [decreaseFontBtn, resetFontBtn, increaseFontBtn].forEach(btn => {
                btn.classList.remove('active');
            });
            if (fontSize === 14) { 
                resetFontBtn.classList.add('active');
            }
            
            if (fontSizeDisplay) {
                fontSizeDisplay.textContent = `${fontSize}px`;
            }
            
            decreaseFontBtn.disabled = fontSize <= 12;
            increaseFontBtn.disabled = fontSize >= 24;
        }
        
        (function() {
            let resizeTimeout;
            window.addEventListener('resize', () => {
                if (resizeTimeout) {
                    clearTimeout(resizeTimeout);
                }
                resizeTimeout = setTimeout(() => {
                    console.log('窗口大小调整，重新计算字体布局...');
                    document.body.style.overflow = 'hidden';
                    
                    requestAnimationFrame(() => {
                        const currentFontSize = parseInt(fontSizeValue.value) || 14;
                        document.documentElement.style.setProperty('--body-font-size', `${currentFontSize}px`);
                        
                        document.body.style.overflow = '';
                        
                        console.log('字体布局已重新计算');
                    });
                }, 250);
            });
        })();
        
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                body.density-default .chat-header, 
                body.density-default .friends-header, 
                body.density-default .friend-code-section, 
                body.density-default .add-friend-section {
                    padding: 15px 20px;
                }
                
                body.density-default .message {
                    padding: 14px 18px;
                    margin-bottom: 10px;
                }
                
                body.density-compact .chat-header, 
                body.density-compact .friends-header {
                    padding: 10px 15px;
                }
                
                body.density-compact .friend-code-section, 
                body.density-compact .add-friend-section {
                    padding: 10px 15px;
                }
                
                body.density-compact .message {
                    padding: 10px 14px;
                    margin-bottom: 6px;
                }
                
                body.density-compact .chat-input-container {
                    padding: 10px;
                }
                
                body.density-spacious .chat-header, 
                body.density-spacious .friends-header {
                    padding: 20px 25px;
                }
                
                body.density-spacious .friend-code-section, 
                body.density-spacious .add-friend-section {
                    padding: 20px 25px;
                }
                
                body.density-spacious .message {
                    padding: 18px 22px;
                    margin-bottom: 14px;
                }
                
                body.density-spacious .chat-input-container {
                    padding: 20px;
                }

                body.density-compact .form-group, 
                body.density-compact .auth-form > * {
                    margin-bottom: 12px;
                    gap: 6px;
                }
                
                body.density-spacious .form-group, 
                body.density-spacious .auth-form > * {
                    margin-bottom: 24px;
                    gap: 12px;
                }
            </style>
        `);
        
         function loadSettings() {
            const savedTheme = localStorage.getItem('userTheme') || 'default';
            const savedFontSize = 14; 
            
            themeSelect.value = savedTheme;
            fontSizeValue.value = savedFontSize.toString();
            updateFontButtonsState(savedFontSize);
            
            updateThemePreviews(savedTheme);
            applyAppearanceSettings(savedTheme, savedFontSize);
            
            fontSizeDisplay.textContent = `${savedFontSize}px`;
            
            updateThemeSelectOptions();
            
            updateThemePreviewOptions();
              
             initAppearanceListeners();
             initThemePreviews();
         }
        
        function showAppearanceMessage(message, type) {
            let notification = document.getElementById('appearance-notification');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'appearance-notification';
                notification.style.cssText = `
                    position: fixed;
                    padding: 16px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 9999;
                    opacity: 0;
                    transition: opacity 0.3s, transform 0.3s;
                    transform: translateY(-20px);
                    pointer-events: none;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = message;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#4CAF50';
                notification.style.color = 'white';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#f44336';
                notification.style.color = 'white';
            } else {
                notification.style.backgroundColor = '#333';
                notification.style.color = 'white';
            }
            
            notification.style.left = '50%';
            notification.style.top = '20px';
            notification.style.transform = 'translate(-50%, -20px)';
            
            notification.style.opacity = '1';
            notification.style.transform = 'translate(-50%, 0)';
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -20px)';
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        function generateFriendCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }
        
        function copyFriendCode() {
            const code = friendCodeText.textContent;
            if (code && code !== '加载中...') {
                navigator.clipboard.writeText(code).then(() => {
                    showAddFriendMessage('好友码已复制到剪贴板', 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
showAddFriendMessage('复制失败，请手动复制', 'error');
                });
            }
        }
        
        function showAddFriendMessage(message, type) {
            addFriendMessage.textContent = message;
            addFriendMessage.className = `auth-message ${type}`;
            setTimeout(() => {
                addFriendMessage.textContent = '';
                addFriendMessage.className = '';
            }, 3000);
        }
        
        async function addFriend() {
            if (!supabase || !currentUser) {
                showAddFriendMessage('请先登录', 'error');
                return;
            }
            
            const friendCode = friendCodeInput.value.trim();
            
            if (!friendCode) {
                showAddFriendMessage('请输入好友码', 'error');
                return;
            }
            
            try {
                const { data: friendData, error: friendError } = await supabase
                    .from('profiles')
                    .select('id, username, avatar_url')
                    .eq('friend_code', friendCode);
                
                if (friendError || !friendData || friendData.length === 0) {
                    showAddFriendMessage('未找到该好友码对应的用户', 'error');
                    return;
                }
                
                const friend = friendData[0];
                
                if (friend.id === currentUser.id) {
                    showAddFriendMessage('不能添加自己为好友', 'error');
                    return;
                }
                
                const { data: existingFriend, error: checkError } = await supabase
                    .from('friends')
                    .select('id')
                    .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${friend.id}),and(user_id.eq.${friend.id},friend_id.eq.${currentUser.id})`);
                
                if (existingFriend && existingFriend.length > 0) {
showAddFriendMessage('该用户已经是您的好友', 'error');
                    return;
                }
                
                const isOfficial = friend.id === OFFICIAL_ACCOUNT_ID;
                
                const insertData = [
                    { 
                        user_id: currentUser.id, 
                        friend_id: friend.id, 
                        status: 'accepted',
                        is_official: isOfficial 
                    },
                    { 
                        user_id: friend.id, 
                        friend_id: currentUser.id, 
                        status: 'accepted',
                        is_official: isOfficial 
                    }
                ];
                
                let { data, error } = await supabase
                    .from('friends')
                    .insert(insertData);
                
                if (error && error.code === '42703') {
                    console.log('is_official 列不存在，使用备用插入');
                    const fallbackData = insertData.map(item => {
                        const { is_official, ...rest } = item;
                        return rest;
                    });
                    
                    const fallbackResult = await supabase
                        .from('friends')
                        .insert(fallbackData);
                    
                    data = fallbackResult.data;
                    error = fallbackResult.error;
                }
                
                if (error) throw error;
                
                showAddFriendMessage(`成功添加 ${friend.username} 为好友`, 'success');
                friendCodeInput.value = '';
                
                loadFriends();
                
            } catch (error) {
                console.error('添加好友错误:', error);
                showAddFriendMessage('添加好友失败: ' + error.message, 'error');
            }
        }
        
        function confirmDeleteFriendAction(friend) {
        const isOfficial = friend.id === OFFICIAL_ACCOUNT_ID;
    
        if (isOfficial) {
showAddFriendMessage('无法删除官方好友', 'error');
            return;
        }
    
        friendToDelete = friend;
        deleteFriendMessage.textContent = `确定要删除好友 ${friend.username} 吗？删除后将无法恢复。`;
        deleteFriendModal.classList.add('show');
        }
        
        async function deleteFriend() {
            if (!friendToDelete || !supabase || !currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('friends')
                    .delete()
                    .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${friendToDelete.id}),and(user_id.eq.${friendToDelete.id},friend_id.eq.${currentUser.id})`);
                
                if (error) throw error;
                
                if (currentFriend && currentFriend.id === friendToDelete.id) {
                    currentFriend = null;
                    showNoFriendSelected();
                    messageInput.placeholder = '请先选择好友...';
                    disableChatInput();
                }
                
                loadFriends();
                
                deleteFriendModal.classList.remove('show');
                friendToDelete = null;
                
                showAddFriendMessage('好友已删除', 'success');
                
            } catch (error) {
                console.error('删除好友错误:', error);
                showAddFriendMessage('删除好友失败: ' + error.message, 'error');
            }
        }
        
        function confirmRecallMessageAction(messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            if (messageElement && messageElement.classList.contains('recalled-message')) {
                return;
            }
            
            messageToRecall = messageId;
            recallMessageModal.classList.add('show');
        }
        

        
        function initializeSupabaseWithFallback() {
            try {
                if (window.isSecureContext) {
                    return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                    console.warn('非安全上下文，Supabase功能可能受限');
                    return {
                        auth: {
                            getSession: () => Promise.resolve({ data: { session: null }, error: null }),
                            onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => {} } } })
                        },
                        from: () => ({
                            select: () => ({
                                eq: () => Promise.resolve({ data: null, error: new Error('本地模式') })
                            }),
                            insert: () => Promise.resolve({ data: null, error: new Error('本地模式') }),
                            update: () => Promise.resolve({ data: null, error: new Error('本地模式') }),
                            delete: () => Promise.resolve({ data: null, error: new Error('本地模式') })
                        })
                    };
                }
            } catch (error) {
                console.error('Supabase初始化失败:', error);
                return null;
            }
        }

        function initializeSupabase() {
            try {
                const loadingText = document.querySelector('.loading-text');
                const progressFill = document.querySelector('.progress-fill');
                const progressPercentage = document.querySelector('.progress-percentage');
                
                if (loadingText) {
                    loadingText.textContent = '正在连接服务器...';
                }
                
                updateProgress(10, progressFill, progressPercentage);
                
                if (!window.supabase || typeof window.supabase.createClient !== 'function') {
                    throw new Error('Supabase库未正确加载');
                }
                
                updateProgress(30, progressFill, progressPercentage);
                
                supabase = initializeSupabaseWithFallback();
                
                if (!supabase) {
                    throw new Error('Supabase客户端创建失败');
                }
                
                updateProgress(40, progressFill, progressPercentage);
                
                if (supabase.auth && typeof supabase.auth.getSession === 'function') {
                    testConnection();
                } else {
                    console.log('运行在模拟模式下，跳过连接测试');
                    setTimeout(() => {
                        const initLoadingContainer = document.getElementById('initLoadingContainer');
                        const authForms = document.getElementById('authForms');
                        if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                        if (authForms) authForms.style.display = 'block';
                    }, 1000);
                }
            } catch (error) {
                console.error('初始化Supabase错误:', error);
                const loadingText = document.querySelector('.loading-text');
                if (loadingText) {
                    loadingText.textContent = '初始化失败: ' + error.message;
                }
                setTimeout(() => {
                    const initLoadingContainer = document.getElementById('initLoadingContainer');
                    const authForms = document.getElementById('authForms');
                    if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                    if (authForms) authForms.style.display = 'block';
                }, 2000);
            }
        }
        
        async function testConnection() {
            try {
                applyTheme('default');
                
                const loadingText = document.querySelector('.loading-text');
                const progressFill = document.querySelector('.progress-fill');
                const progressPercentage = document.querySelector('.progress-percentage');
                
                if (loadingText) {
                    loadingText.textContent = '正在测试数据库连接...';
                    loadingText.classList.remove('error-text');
                }
                
                const retryButton = document.querySelector('.retry-button');
                if (retryButton && retryButton.parentNode) {
                    retryButton.parentNode.removeChild(retryButton);
                }
                
                updateProgress(50, progressFill, progressPercentage);
                
                try {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .limit(1);
                    
                    updateProgress(60, progressFill, progressPercentage);
                    
                    if (error) {
                        handleDatabaseError(error, loadingText, progressFill);
                        return;
                    } else {
                        updateConnectionStatus(true);
                        await checkSavedSession();
                        
                        if (!currentUser) {
                            const initLoadingContainer = document.getElementById('initLoadingContainer');
                            const loadingContainer = document.getElementById('loadingContainer');
                            const authForms = document.getElementById('authForms');
                            
                            if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                            if (loadingContainer) loadingContainer.style.display = 'none';
                            if (authForms) authForms.style.display = 'block';
                        }
                    }
                } catch (networkError) {
                    handleConnectionError(networkError, loadingText, progressFill);
                    return;
                }
                
            } catch (error) {
                console.error('连接测试失败:', error);
                handleConnectionError(error, document.querySelector('.loading-text'), document.querySelector('.progress-fill'));
            }
        }
        
        function handleDatabaseError(error, loadingText, progressFill) {
            applyTheme('default');
            
            let errorMessage = '';
            let actionMessage = '';
            
            switch(error.code) {
                case 'PGRST301':
                    errorMessage = '数据库表不存在';
                    actionMessage = '请检查数据库表结构是否正确';
                    break;
                case '42501':
                    errorMessage = '权限验证失败';
                    actionMessage = '请检查数据库RLS策略配置';
                    break;
                case 'PGRST001':
                    errorMessage = '数据库查询错误';
                    actionMessage = '请检查请求参数是否正确';
                    break;
                case 'PGRST204':
                    errorMessage = '未找到数据';
                    actionMessage = '正在初始化数据库结构...';
                    break;
                default:
                    errorMessage = '数据库操作失败';
                    actionMessage = `错误代码: ${error.code}`;
            }
            
            if (loadingText) {
                loadingText.textContent = `${errorMessage}\n${actionMessage}`;
                loadingText.classList.add('error-text');
                loadingText.style.whiteSpace = 'pre-line';
                loadingText.style.textAlign = 'center';
            }
            
            if (progressFill) {
                progressFill.style.background = 'linear-gradient(90deg, #ff6b6b, #ee5253)';
            }
            
            addRetryButton();
            
            setTimeout(() => {
                const initLoadingContainer = document.getElementById('initLoadingContainer');
                const loadingContainer = document.getElementById('loadingContainer');
                const authForms = document.getElementById('authForms');
                
                if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                if (loadingContainer) loadingContainer.style.display = 'none';
                if (authForms) authForms.style.display = 'block';
            }, 3000);
        }
        
        function handleConnectionError(error, loadingText, progressFill) {
            applyTheme('default');
            
            let errorMessage = '网络连接失败';
            let actionMessage = '';
            
            if (error.message.includes('fetch failed')) {
                actionMessage = '请检查您的网络连接';
            } else if (error.message.includes('timeout')) {
                actionMessage = '连接超时，请稍后重试';
            } else if (error.message.includes('401')) {
                actionMessage = '认证失败，请重新登录';
            } else {
                actionMessage = `请稍后重试，错误信息: ${error.message.substring(0, 50)}...`;
            }
            
            if (loadingText) {
                loadingText.textContent = `${errorMessage}\n${actionMessage}`;
                loadingText.classList.add('error-text');
                loadingText.style.whiteSpace = 'pre-line';
                loadingText.style.textAlign = 'center';
            }
            
            if (progressFill) {
                progressFill.style.background = 'linear-gradient(90deg, #ff6b6b, #ee5253)';
            }
            
            updateConnectionStatus(false);
            
            addRetryButton();
        }
        
        function addRetryButton() {
            const loadingContainer = document.getElementById('loadingContainer');
            if (!loadingContainer) return;
            
            let retryButton = document.querySelector('.retry-button');
            if (retryButton) return;
            
            retryButton = document.createElement('button');
            retryButton.className = 'retry-button';
            retryButton.textContent = '重试连接';
            retryButton.style.cssText = `
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                border: none;
                border-radius: 25px;
                color: white;
                padding: 10px 24px;
                margin-top: 15px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            `;
            
            retryButton.onmouseover = () => {
                retryButton.style.transform = 'translateY(-2px)';
                retryButton.style.boxShadow = '0 6px 20px rgba(79, 172, 254, 0.4)';
            };
            
            retryButton.onmouseout = () => {
                retryButton.style.transform = 'translateY(0)';
                retryButton.style.boxShadow = '0 4px 15px rgba(79, 172, 254, 0.3)';
            };
            
            retryButton.onclick = async () => {
                retryButton.textContent = '正在重试...';
                retryButton.disabled = true;
                
                try {
                    await testConnection();
                } finally {
                    retryButton.textContent = '重试连接';
                    retryButton.disabled = false;
                }
            };
            
            loadingContainer.appendChild(retryButton);
        }
        
        async function checkSavedSession() {
            const loadingText = document.querySelector('.loading-text');
            const progressFill = document.querySelector('.progress-fill');
            const progressPercentage = document.querySelector('.progress-percentage');
            
            if (loadingText) {
                loadingText.textContent = '正在检查登录状态...';
            }
            
            updateProgress(70, progressFill, progressPercentage);
            
            const savedSession = localStorage.getItem('supabaseSession');
            
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    if (session.user) {
                        if (supabase) {
                            updateProgress(80, progressFill, progressPercentage);
                            
                            const { data: userData, error: userError } = await supabase
                                .from('profiles')
                                .select('*')
                                .eq('username', session.user.user_metadata.username)
                                .limit(1);
                            
                            if (userError || !userData || userData.length === 0) {
                                console.error('用户信息不存在于数据库');
                                localStorage.removeItem('supabaseSession');
                                const initLoadingContainer = document.getElementById('initLoadingContainer');
                                const authForms = document.getElementById('authForms');
                                if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                                if (authForms) authForms.style.display = 'block';
                                showAuthMessage('登录信息已过期，请重新登录', 'error');
                                return;
                            }
                        }
                        
                        updateProgress(90, progressFill, progressPercentage);
                        
                        currentUser = session.user;
                        if (loadingContainer) loadingContainer.style.display = 'none';
                        if (authContainer) authContainer.style.display = 'none';
                        if (chatContainer) chatContainer.style.display = 'none';
                        
                        updateUserInterface();
                        loadAppearanceSettingsFromCloud();
                        setTimeout(() => {
                            initializeChat();
                        }, 200);
                    }
                } catch (error) {
                    console.error('恢复会话失败:', error);
                    localStorage.removeItem('supabaseSession');
                    applyTheme('default');
                    const initLoadingContainer = document.getElementById('initLoadingContainer');
                    const authForms = document.getElementById('authForms');
                    if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                    if (authForms) authForms.style.display = 'block';
                }
            } else {
                applyTheme('default');
                const initLoadingContainer = document.getElementById('initLoadingContainer');
                const authContainer = document.getElementById('authContainer');
                const authForms = document.getElementById('authForms');
                if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                if (authContainer) authContainer.style.display = 'block';
                if (authForms) authForms.style.display = 'block';
            }
        }
        
        function updateProgress(percentage, progressFill, progressPercentage) {
            if (progressFill) {
                progressFill.style.transition = 'none';
                progressFill.style.width = '0';
                
                requestAnimationFrame(() => {
                    progressFill.style.transition = 'width 0.6s ease-in-out';
                    progressFill.style.width = `${percentage}%`;
                });
            }
            
            if (progressPercentage) {
                const currentValue = parseInt(progressPercentage.textContent) || 0;
                if (currentValue !== percentage) {
                    let startValue = currentValue;
                    const duration = 500; 
                    const startTime = performance.now();
                    
                    function animate(currentTime) {
                        const elapsed = currentTime - startTime;
                        if (elapsed < duration) {
                            const progress = elapsed / duration;
                            const easedProgress = 1 - Math.pow(1 - progress, 2);
                            const newValue = Math.floor(startValue + (percentage - startValue) * easedProgress);
                            progressPercentage.textContent = `${newValue}%`;
                            requestAnimationFrame(animate);
                        } else {
                            progressPercentage.textContent = `${percentage}%`;
                        }
                    }
                    
                    requestAnimationFrame(animate);
                }
            }
        }
        
        function switchAuthTab(tab) {
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'flex';
                registerForm.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'flex';
            }
            clearAuthMessage();
        }
        
        function clearAuthMessage() {
            authMessage.textContent = '';
            authMessage.className = '';
        }
        
function showAuthMessage(message, type) {
            authMessage.textContent = message;
            authMessage.className = `auth-message ${type}`;
        }
        
        function validateField(field, errorElementId, minLength = 0, maxLength = Infinity, pattern = null) {
            const rawValue = field && field.value ? field.value : '';
            const value = rawValue.trim();
            const errorElement = document.getElementById(errorElementId);
            let errorMessage = '';
            
            if (!value) {
                errorMessage = field && field.id && field.id.includes('username') ? '用户名不能为空' : 
                               field && field.id && field.id.includes('confirm') ? '请确认密码' : '密码不能为空';
            } 
            else if (value.length < minLength) {
                errorMessage = field && field.id && field.id.includes('username') ? 
                               `用户名至少需要${minLength}个字符` : 
                               `密码至少需要${minLength}位`;
            }
            else if (value.length > maxLength) {
                errorMessage = field && field.id && field.id.includes('username') ? 
                               `用户名不能超过${maxLength}个字符` : 
                               `密码不能超过${maxLength}个字符`;
            }
            else if (field && field.id && field.id.includes('username') && rawValue.includes(' ')) {
                errorMessage = '用户名不能包含空格';
            }
            else if (field && field.id && field.id.includes('confirm')) {
                const passwordField = document.getElementById('registerPassword');
                if (passwordField && passwordField.value) {
                    if (value !== passwordField.value.trim()) {
                        errorMessage = '两次输入的密码不一致';
                    }
                }
            }
            else if (pattern && !pattern.test(value)) {
                errorMessage = field && field.id && field.id.includes('username') ? 
                               '用户名只能包含字母、数字和下划线' : 
                               '密码格式不正确';
            }
            
            if (errorMessage) {
                if (errorElement && errorElement.classList) {
                    errorElement.textContent = errorMessage;
                    errorElement.classList.add('visible');
                }
                if (field && field.classList) {
                    field.classList.add('error');
                    setTimeout(() => {
                        if (field && field.classList) field.classList.remove('error');
                    }, 300);
                }
                return false;
            } else {
                if (errorElement && errorElement.classList) {
                    errorElement.textContent = '';
                    errorElement.classList.remove('visible');
                }
                return true;
            }
        }
        
        function setButtonLoading(button, isLoading) {
            const textElement = button.querySelector('.btn-text');
            const loaderElement = button.querySelector('.btn-loader');
            
            if (textElement && loaderElement) {
                if (isLoading) {
                    textElement.textContent = '处理中...';
                    loaderElement.classList.add('loading');
                } else {
                    textElement.textContent = button.id === 'loginBtn' ? '登录' : '注册';
                    loaderElement.classList.remove('loading');
                }
                button.disabled = isLoading;
            }
        }
        
        async function handleLogin() {
            if (!supabase) {
                showAuthMessage('Supabase连接失败', 'error');
                return;
            }
            
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();
            const loginBtn = document.getElementById('loginBtn');
        
            const isUsernameValid = validateField(loginUsername, 'loginUsernameError');
            const isPasswordValid = validateField(loginPassword, 'loginPasswordError');
            
            if (!isUsernameValid || !isPasswordValid) {
                return;
            }
            
            try {
                setButtonLoading(loginBtn, true);
                
                const { data: userData, error: userError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username);
                
                if (userError || !userData || userData.length === 0) {
                    showAuthMessage('用户名或密码错误', 'error');
                    return;
                }
                
                const user = userData[0];
                
                if (user.password !== password) {
                    showAuthMessage('用户名或密码错误', 'error');
                    return;
                }
                
                applyTheme('default');
                
                if (initLoadingContainer) {
                    initLoadingContainer.style.display = 'flex';
                    initLoadingContainer.style.opacity = '0';
                    initLoadingContainer.style.transition = 'opacity 0.6s ease-in';
                    initLoadingContainer.style.zIndex = '1001';
                }
                
                if (authContainer) {
                    authContainer.style.transition = 'opacity 0.4s ease-out';
                    authContainer.style.opacity = '0';
                }
              
                setTimeout(() => {
                    if (authContainer) authContainer.style.display = 'none';
                    if (initLoadingContainer) {
                        initLoadingContainer.style.transform = 'scale(0.95)';
                        initLoadingContainer.style.transition = 'opacity 0.5s ease-in, transform 0.5s ease-out';
                        setTimeout(() => {
                            initLoadingContainer.style.opacity = '1';
                            initLoadingContainer.style.transform = 'scale(1)';
                            initLoadingContainer.classList.add('loading-active');
                        }, 50);
                    }
                }, 400);
                
                const userObj = {
                    id: user.id,
                    user_metadata: {
                        username: username
                    }
                };
                
                const session = {
                    user: userObj,
                    access_token: 'demo_token_' + Date.now(),
                    refresh_token: 'demo_refresh_token_' + Date.now()
                };
                
                localStorage.setItem('supabaseSession', JSON.stringify(session));
                
                currentUser = userObj;
                updateUserInterface();
                
                loadAppearanceSettingsFromCloud();

                setTimeout(() => {
                    initializeChat();
                }, 200);
                
            } catch (error) {
                console.error('登录错误:', error);
                showAuthMessage('登录失败: ' + error.message, 'error');
            } finally {
                setButtonLoading(loginBtn, false);
            }
        }
        
        async function handleRegister() {
            if (!supabase) {
                showAuthMessage('Supabase连接失败', 'error');
                return;
            }
            
            const rawUsername = registerUsername.value;
            const username = rawUsername.trim();
            const password = registerPassword.value.trim();
            const confirm = confirmPassword.value.trim();
            const registerBtn = document.getElementById('registerBtn');
            
            const usernameError = document.getElementById('registerUsernameError');
            if (rawUsername.includes(' ')) {
                registerUsername.classList.add('error');
                usernameError.textContent = '用户名不能包含空格';
                usernameError.classList.add('visible');
                setTimeout(() => {
                    registerUsername.classList.remove('error');
                }, 300);
                return;
            }
            
            const isUsernameValid = validateField(registerUsername, 'registerUsernameError', 0, 15);
            const isPasswordValid = validateField(registerPassword, 'registerPasswordError', 6);
            const isConfirmValid = validateField(confirmPassword, 'confirmPasswordError');
            
            if (!isUsernameValid || !isPasswordValid || !isConfirmValid) {
                return;
            }
            
            try {
                setButtonLoading(registerBtn, true);
                const { data: existingUser, error: checkError } = await supabase
                    .from('profiles')
                    .select('id')
                    .eq('username', username);
                
                if (checkError) {
                    console.error('检查用户名错误:', checkError);
                    throw checkError;
                }
                
                if (existingUser && existingUser.length > 0) {
                    const usernameError = document.getElementById('registerUsernameError');
                    usernameError.textContent = '用户名已存在';
                    usernameError.classList.add('visible');
                    registerUsername.classList.add('error');
                    setTimeout(() => {
                        registerUsername.classList.remove('error');
                    }, 300);
                    return;
                }
                
                const friendCode = generateFriendCode();
                
                const newUser = {
                    id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    username: username,
                    password: password,
                    friend_code: friendCode,
                    created_at: new Date().toISOString()
                };
                
                console.log('准备插入用户:', newUser);
                
                const { data, error } = await supabase
                    .from('profiles')
                    .insert([newUser]);
                
                if (error) {
                    console.error('插入用户错误:', error);
                    throw error;
                }
                
                console.log('注册成功:', data);
                
                try {
                    await addOfficialFriend(newUser.id);
                } catch (friendError) {
                    console.error('添加官方好友失败:', friendError);
                }
                
                successModal.classList.add('show');
                
                showAuthMessage('注册成功! 请使用您的用户名和密码登录', 'success');
                
                registerUsername.value = '';
                registerPassword.value = '';
                confirmPassword.value = '';
                
                switchAuthTab('login');
                
            } catch (error) {
                console.error('注册错误详情:', error);
                let errorMessage = '注册失败';
                
                if (error.code === '23505') {
                    errorMessage = '用户名已存在';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                } else if (error.details) {
                    errorMessage += ': ' + error.details;
                }
                
                showAuthMessage(errorMessage, 'error');
            } finally {
                setButtonLoading(registerBtn, false);
            }
        }
        
        async function addOfficialFriend(userId) {
            if (!supabase) return;
            
            try {
                const insertData = [
                    { 
                        user_id: userId, 
                        friend_id: OFFICIAL_ACCOUNT_ID, 
                        status: 'accepted',
                        is_official: false
                    },
                    { 
                        user_id: OFFICIAL_ACCOUNT_ID, 
                        friend_id: userId, 
                        status: 'accepted',
                        is_official: true
                    }
                ];
                
                let { data, error } = await supabase
                    .from('friends')
                    .insert(insertData);
                
                if (error && error.code === '42703') {
                    console.log('is_official 列不存在，使用备用插入');
                    const fallbackData = insertData.map(item => {
                        const { is_official, ...rest } = item;
                        return rest;
                    });
                    
                    const fallbackResult = await supabase
                        .from('friends')
                        .insert(fallbackData);
                    
                    data = fallbackResult.data;
                    error = fallbackResult.error;
                }
                
                if (error) throw error;
                console.log('官方好友添加成功');
            } catch (error) {
                console.error('添加官方好友错误:', error);
                throw error;
            }
        }
        
        async function handleLogout() {
            try {
                localStorage.removeItem('supabaseSession');
                
                currentUser = null;
                currentFriend = null;
                
                const initLoadingContainer = document.getElementById('initLoadingContainer');
                const loadingContainer = document.getElementById('loadingContainer');
                const authContainer = document.getElementById('authContainer');
                const authForms = document.getElementById('authForms');
                const chatContainer = document.getElementById('chatContainer');
                
                if (initLoadingContainer) {
                    initLoadingContainer.style.display = 'none';
                }
                if (loadingContainer) {
                    loadingContainer.style.display = 'none';
                }
                if (authContainer) {
                    authContainer.style.display = 'block';
                    authContainer.style.opacity = '1'; 
                }
                if (authForms) {
                    authForms.style.display = 'block';
                }
                if (chatContainer) {
                    chatContainer.style.display = 'none';
                }
                
                showNoFriendSelected();
                
                unreadMessages.clear();
                notificationMessages.clear();
                updateNotificationBadge();
                updateNotificationDropdown();
                
                loginUsername.value = '';
                loginPassword.value = '';
                
                applyAppearanceSettings('default', 'normal');
                
            } catch (error) {
                console.error('退出登录错误:', error);
            }
        }
        
        function updateUserInterface() {
            if (currentUser) {
                const username = currentUser.user_metadata?.username || '用户';
                const initial = username.charAt(0).toUpperCase();
                
                loadUserAvatarFromDB();
                
                userName.textContent = username;
                
                authContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
            }
        }
        
        async function loadUserAvatarFromDB() {
            if (!currentUser || !supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('avatar_url')
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                if (data && data.length > 0 && data[0].avatar_url) {
                    updateUserAvatar(data[0].avatar_url);
                } else {
                    const username = currentUser.user_metadata?.username || '用户';
                    const initial = username.charAt(0).toUpperCase();
                    userAvatar.textContent = initial;
                    userAvatar.style.backgroundImage = '';
                }
            } catch (error) {
                console.error('加载用户头像错误:', error);
            }
        }
        
        function updateUserAvatar(avatarUrl) {
            if (avatarUrl) {
                userAvatar.style.backgroundImage = `url(${avatarUrl})`;
                userAvatar.textContent = '';
            } else {
                const username = currentUser.user_metadata?.username || '用户';
                const initial = username.charAt(0).toUpperCase();
                userAvatar.textContent = initial;
                userAvatar.style.backgroundImage = '';
            }
        }
        
        function initializeChat() {
            if (!supabase || !currentUser) return;
            
            const loadingText = document.querySelector('.loading-text');
            const progressFill = document.querySelector('.progress-fill');
            const progressPercentage = document.querySelector('.progress-percentage');
            
            if (loadingText) {
                loadingText.textContent = '正在准备聊天界面...';
            }
            
            updateProgress(95, progressFill, progressPercentage);
            
            loadAppearanceSettingsFromCloud();
            
            loadFriendCode();
            loadFriends();
            subscribeToFriends();
            subscribeToAllMessages();
            disableChatInput();
            updateNotificationBadge();
            updateNotificationDropdown();
            
            setTimeout(() => {
                if (loadingText) {
                    loadingText.textContent = '准备就绪！';
                }
                updateProgress(100, progressFill, progressPercentage);
                setTimeout(() => {
                    const initLoadingContainer = document.getElementById('initLoadingContainer');
                    const loadingContainer = document.getElementById('loadingContainer');
                    const chatContainer = document.getElementById('chatContainer');
                    const loadingSpinner = document.querySelector('.loading-spinner');
                    const spinnerRing = document.querySelector('.spinner-ring');
                    
                    if (loadingSpinner) {
                        loadingSpinner.style.animationPlayState = 'paused';
                    }
                    if (spinnerRing) {
                        spinnerRing.style.animationPlayState = 'paused';
                    }
                    
                    if (initLoadingContainer) {
                        initLoadingContainer.style.opacity = '0';
                        initLoadingContainer.style.transition = 'opacity 0.5s ease-out';
                    }
                    if (loadingContainer) {
                        loadingContainer.style.opacity = '0';
                        loadingContainer.style.transition = 'opacity 0.5s ease-out';
                    }
                    
                    setTimeout(() => {
                        if (initLoadingContainer) initLoadingContainer.style.display = 'none';
                        if (loadingContainer) loadingContainer.style.display = 'none';
                        if (chatContainer) {
                            chatContainer.style.display = 'flex'
                            chatContainer.style.opacity = '0';
                            chatContainer.style.transition = 'opacity 0.5s ease-in';
                            setTimeout(() => {
                                chatContainer.style.opacity = '1';
                            }, 10);
                        }
                    }, 500);
                }, 500);
            }, 300);
        }
        
        function disableChatInput() {
            if (messageInput) messageInput.disabled = true;
            if (sendBtn) sendBtn.disabled = true;
            if (emojiBtn) {
                emojiBtn.disabled = true;
                emojiBtn.style.color = '#999';
            }
            if (stickerBtn) {
                stickerBtn.disabled = true;
                stickerBtn.style.color = '#999';
            }
            
            const stickerInput = document.getElementById('stickerInput');
            if (stickerInput) {
                stickerInput.disabled = true;
                stickerInput.style.cursor = 'default';
            }
            
            const stickerSearchBtn = document.getElementById('stickerSearchBtn');
            if (stickerSearchBtn) {
                stickerSearchBtn.disabled = true;
                stickerSearchBtn.style.background = '#999';
                stickerSearchBtn.style.cursor = 'default';
            }
            
            if (messageInput) messageInput.placeholder = "请先选择好友...";
        }
        
        function enableChatInput() {
            
            if (messageInput) messageInput.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
            if (emojiBtn) {
                emojiBtn.disabled = false;
                emojiBtn.style.color = '';
            }
            if (stickerBtn) {
                stickerBtn.disabled = false;
                stickerBtn.style.color = '';
            }
            
            const stickerInput = document.getElementById('stickerInput');
            if (stickerInput) {
                stickerInput.disabled = false;
                stickerInput.style.cursor = '';
            }
            
            const stickerSearchBtn = document.getElementById('stickerSearchBtn');
            if (stickerSearchBtn) {
                stickerSearchBtn.disabled = false;
                stickerSearchBtn.style.background = '';
                stickerSearchBtn.style.cursor = '';
            }
            
            if (messageInput) {
                if (currentFriend && currentFriend.username) {
                    messageInput.placeholder = `发送消息给 ${currentFriend.username}...`;
                } else {
                    messageInput.placeholder = "请输入消息...";
                }
                messageInput.focus();
            }
        }
function showNoFriendSelected() {
            chatMessages.innerHTML = `
                <div class="no-friend-selected">
                    <div class="no-friend-icon">👤</div>
                    <div class="no-friend-text">请先选择好友开始聊天</div>
                    <div class="no-friend-hint">点击左侧好友列表选择一个好友，或添加新好友</div>
                </div>
            `;
        }
        
        function subscribeToAllMessages() {
            if (!supabase || !currentUser) return;
            
            const globalMessageSubscription = supabase
                .channel('global_messages')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'private_messages'
                    }, 
                    (payload) => {
                        if (payload.new && payload.new.sender_id === currentUser.id) {
                            return;
                        }
                        
                        if (payload.new && payload.new.receiver_id === currentUser.id) {
                            console.log('收到新消息（全局订阅）:', payload);
                            
                            if (processedMessageIds.has(payload.new.id)) {
                                console.log('消息已处理，跳过:', payload.new.id);
                                return;
                            }
                            
                            if (currentFriend && currentFriend.id === payload.new.sender_id) {
                                addPrivateMessageToChat(payload.new);
                                processedMessageIds.add(payload.new.id);
                                scrollToBottom();
                            } else {
                                const unreadCount = unreadMessages.get(payload.new.sender_id) || 0;
                                unreadMessages.set(payload.new.sender_id, unreadCount + 1);
                                
                                addNotificationMessage(payload.new);
                                
                                updateNotificationBadge();
                                
                                renderFriendsList();
                            }
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('全局消息订阅状态:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('成功订阅全局消息');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('全局消息订阅错误');
                    } else if (status === 'TIMED_OUT') {
                        console.error('全局消息订阅超时');
                    }
                });
        }
        
        async function loadFriendCode() {
            if (!supabase || !currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('friend_code')
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('查询好友码错误:', error);
                    throw error;
                }
                
                if (data && data.length > 0 && data[0].friend_code) {
                    friendCodeText.textContent = data[0].friend_code;
                } else {
                    const friendCode = generateFriendCode();
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ friend_code: friendCode })
                        .eq('id', currentUser.id);
                    
                    if (updateError) {
                        console.error('更新好友码错误:', updateError);
                        throw updateError;
                    }
                    
                    friendCodeText.textContent = friendCode;
                }
            } catch (error) {
                console.error('加载好友码错误:', error);
                friendCodeText.textContent = '加载失败';
            }
        }
        
        async function loadFriends() {
            if (!supabase || !currentUser) return;
            
            try {
                let query = supabase
                    .from('friends')
                    .select(`
                        friend_id,
                        is_official,
                        profiles:friend_id (
                            id, username, avatar_url
                        )
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('status', 'accepted');
                
                let { data, error } = await query;
                
                if (error && error.code === '42703') {
                    console.log('is_official 列不存在，使用备用查询');
                    const fallbackQuery = supabase
                        .from('friends')
                        .select(`
                            friend_id,
                            profiles:friend_id (
                                id, username, avatar_url
                            )
                        `)
                        .eq('user_id', currentUser.id)
                        .eq('status', 'accepted');
                    
                    const fallbackResult = await fallbackQuery;
                    data = fallbackResult.data;
                    error = fallbackResult.error;
                    
                    if (data) {
                        data = data.map(friend => ({
                            ...friend,
                            is_official: friend.friend_id === OFFICIAL_ACCOUNT_ID
                        }));
                    }
                }
                
                if (error) throw error;
                
                friends = data || [];
                
                friends.forEach(friend => {
                    if (!unreadMessages.has(friend.friend_id)) {
                        unreadMessages.set(friend.friend_id, 0);
                    }
                });
                
                renderFriendsList();
                
            } catch (error) {
                console.error('加载好友列表错误:', error);
            }
        }
        
        function renderFriendsList() {
        friendsList.innerHTML = '';
    
        if (friends.length === 0) {
        friendsList.innerHTML = '<div class="status" style="padding: 20px;">暂无好友，使用好友码添加好友</div>';
        return;
        }
    
        const officialFriends = [];
        const regularFriends = [];
    
        friends.forEach(friend => {
            const isOfficial = friend.friend_id === OFFICIAL_ACCOUNT_ID || 
                          (friend.profiles && friend.profiles.id === OFFICIAL_ACCOUNT_ID);
        
            if (isOfficial) {
                officialFriends.push(friend);
            } else {
                regularFriends.push(friend);
            }
            });
    
            officialFriends.forEach(friend => {
                const friendItem = createFriendItem(friend);
                friendsList.appendChild(friendItem);
            });
    
            regularFriends.forEach(friend => {
                const friendItem = createFriendItem(friend);
                friendsList.appendChild(friendItem);
            });
            }
        
        function createFriendItem(friend) {
            const isOfficial = friend.friend_id === OFFICIAL_ACCOUNT_ID || 
                      (friend.profiles && friend.profiles.id === OFFICIAL_ACCOUNT_ID);
    
            const friendItem = document.createElement('div');
            friendItem.className = 'friend-item';
            if (isOfficial) {
                friendItem.classList.add('official-friend');
            }
            if (currentFriend && currentFriend.id === friend.friend_id) {
                friendItem.classList.add('active');
            }
            
            const friendAvatar = document.createElement('div');
            friendAvatar.className = 'friend-avatar';

            const username = friend.profiles.username;
            const initial = username.charAt(0).toUpperCase();

            if (friend.profiles.avatar_url) {
                friendAvatar.style.backgroundImage = `url(${friend.profiles.avatar_url})`;
                friendAvatar.textContent = '';
            } else {
                friendAvatar.style.backgroundImage = '';
                if (isOfficial) {
                friendAvatar.textContent = '客服';
                friendAvatar.classList.add('official-avatar');
            } else {
                friendAvatar.textContent = initial;
                }
            }
            
            const unreadCount = unreadMessages.get(friend.friend_id) || 0;
            if (unreadCount > 0) {
                const unreadBadge = document.createElement('div');
                unreadBadge.className = 'unread-badge';
                unreadBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                friendAvatar.appendChild(unreadBadge);
            }
            
            const friendName = document.createElement('div');
            friendName.className = 'friend-name';
            friendName.textContent = friend.profiles.username;
            
            if (isOfficial) {
                const officialBadge = document.createElement('span');
                officialBadge.className = 'official-badge';
                officialBadge.textContent = '官方';
                officialBadge.title = '官方账号';
                friendName.appendChild(officialBadge);
            }
            
            if (unreadCount > 0) {
                const unreadCountElement = document.createElement('span');
                unreadCountElement.className = 'unread-count';
                unreadCountElement.textContent = unreadCount > 99 ? '99+' : unreadCount;
                friendName.appendChild(unreadCountElement);
            }
            
            const friendActions = document.createElement('div');
            friendActions.className = 'friend-actions';
    
            if (isOfficial) {
                friendActions.style.display = 'none';
            } else {
                const deleteBtn = document.createElement('button');
            deleteBtn.className = 'friend-action-btn delete-friend-btn';
            deleteBtn.title = '删除好友';
            deleteBtn.innerHTML = '🗑️';
            deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            confirmDeleteFriendAction(friend.profiles);
            });
        
            friendActions.appendChild(deleteBtn);
            }
            
            friendItem.appendChild(friendAvatar);
            friendItem.appendChild(friendName);
            friendItem.appendChild(friendActions);
            
            friendItem.addEventListener('click', () => {
                selectFriend(friend.profiles);
            });
            
            return friendItem;
        }
        
        function selectFriend(friend) {
            unreadMessages.set(friend.id, 0);
            notificationMessages.delete(friend.id);
            
            currentFriend = friend;
            renderFriendsList();
            
            updateNotificationBadge();
            
            enableChatInput();
            
            loadPrivateMessages();
            
            subscribeToPrivateMessages();
            
            if (window.innerWidth <= 768) {
                friendsSidebar.classList.add('hidden');
            }
        }
        
        function subscribeToFriends() {
            if (!supabase) return;
            
            if (friendsSubscription) {
                supabase.removeChannel(friendsSubscription);
            }
            
            friendsSubscription = supabase
                .channel('friends')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'friends' 
                    }, 
                    (payload) => {
                        loadFriends();
                    }
                )
                .subscribe();
        }
        
        async function loadPrivateMessages() {
            if (!supabase || !currentUser || !currentFriend) return;
            
            try {
                const { data, error } = await supabase
                    .from('private_messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentFriend.id}),and(sender_id.eq.${currentFriend.id},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                chatMessages.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(message => {
                        addPrivateMessageToChat(message);
                    });
                }
                
                scrollToBottom();
                
            } catch (error) {
                console.error('加载私聊消息错误:', error);
            }
        }
        
        function subscribeToPrivateMessages() {
            if (!supabase || !currentUser || !currentFriend) return;
            
            if (messageSubscription) {
                supabase.removeChannel(messageSubscription);
            }
            
            messageSubscription = supabase
                .channel('private_messages')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'private_messages'
                    }, 
                    (payload) => {
                        const isRelevantMessage = 
                            (payload.new && 
                            ((payload.new.sender_id === currentUser.id && payload.new.receiver_id === currentFriend.id) ||
                            (payload.new.sender_id === currentFriend.id && payload.new.receiver_id === currentUser.id)));
                        
                        if (!isRelevantMessage) return;
                        
                        console.log('收到私聊消息变更:', payload);
                        
                        if (processedMessageIds.has(payload.new.id)) {
                            console.log('消息已处理，跳过:', payload.new.id);
                            return;
                        }
                        
                        if (payload.eventType === 'INSERT') {
                            const tempMessageId = pendingMessages.get(payload.new.id);
                            if (tempMessageId) {
                                updateTempMessage(tempMessageId, payload.new);
                                pendingMessages.delete(payload.new.id);
                                processedMessageIds.add(payload.new.id);
                            } else {
                                addPrivateMessageToChat(payload.new);
                                processedMessageIds.add(payload.new.id);
                                
                                scrollToBottom();
                            }
                        } 
                        else if (payload.eventType === 'UPDATE') {
                            console.log('收到消息更新:', payload.new);
                            updateRecalledMessage(payload.new);
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('私聊消息订阅状态:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('成功订阅私聊消息');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('私聊消息订阅错误');
                    } else if (status === 'TIMED_OUT') {
                        console.error('私聊消息订阅超时');
                    }
                });
        }
        
        async function sendMessage() {
            if (isSendingMessage) return;
            
            if (!isConnected || !supabase || !currentUser || !currentFriend) return;
            
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            isSendingMessage = true;
            sendBtn.disabled = true;
            sendBtn.textContent = '发送中...';
            
            messageInput.value = '';
            
            const tempMessageId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const tempMessage = {
                id: tempMessageId,
                sender_id: currentUser.id,
                receiver_id: currentFriend.id,
                content: messageText,
                is_recalled: false,
                created_at: new Date().toISOString(),
                is_temp: true
            };
            
            addPrivateMessageToChat(tempMessage);
            scrollToBottom();
            
            const message = {
                sender_id: currentUser.id,
                receiver_id: currentFriend.id,
                content: messageText,
                is_recalled: false
            };
            
            try {
                const { data, error } = await supabase
                    .from('private_messages')
                    .insert([message])
                    .select();
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const dbMessage = data[0];
                    updateTempMessage(tempMessageId, dbMessage);
                    pendingMessages.set(dbMessage.id, tempMessageId);
                    processedMessageIds.add(dbMessage.id);
                }
                
                console.log('消息发送成功');
                
            } catch (error) {
                console.error('发送私聊消息错误:', error);
                
                markMessageAsFailed(tempMessageId);
                
                messageInput.value = messageText;
            } finally {
                isSendingMessage = false;
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
                
                messageInput.focus();
            }
        }
        
        function updateTempMessage(tempMessageId, dbMessage) {
            const tempMessageElement = document.querySelector(`.message[data-message-id="${tempMessageId}"]`);
            if (tempMessageElement) {
                tempMessageElement.dataset.messageId = dbMessage.id;
                
                tempMessageElement.classList.remove('pending');
                
                if (dbMessage.is_recalled) {
                    tempMessageElement.classList.add('recalled-message');
                    tempMessageElement.innerHTML = `
                        <div class="message-text" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">已撤回一条消息</div>
                        <div class="message-info">
                            <div class="message-time" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">${formatMessageTime(dbMessage.created_at)}</div>
                        </div>
                    `;
                } else {
                    const contentHtml = processMessageContent(dbMessage.content);
                    
                    tempMessageElement.innerHTML = `
                        <div class="message-text">${contentHtml}</div>
                        <div class="message-info">
                            <div class="message-time">${formatMessageTime(dbMessage.created_at)}</div>
                            
                        </div>
                    `;
                }
            }
        }
        
        function markMessageAsFailed(messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.classList.add('failed');
                
                const messageInfo = messageElement.querySelector('.message-info');
                if (messageInfo) {
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = '重试';
                    retryBtn.onclick = () => {
                        const messageText = messageElement.querySelector('.message-text').textContent;
                        messageInput.value = messageText;
                        messageElement.remove();
                        sendMessage();
                    };
                    messageInfo.appendChild(retryBtn);
                }
            }
        }
        
        async function recallMessage(messageId) {
            if (!supabase || !currentUser) return;
            
            try {
                updateRecalledMessageLocally(messageId);
                
                const { data, error } = await supabase
                    .from('private_messages')
                    .update({ 
                        is_recalled: true
                    })
                    .eq('id', messageId)
                    .eq('sender_id', currentUser.id);
                
                if (error) throw error;
                
                console.log('消息已撤回');
                
            } catch (error) {
                console.error('撤回消息错误:', error);
                
                restoreMessageLocally(messageId);
            }
        }
        
        function updateRecalledMessageLocally(messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.classList.add('recalled-message');
                messageElement.innerHTML = `
                    <div class="message-text">已撤回一条消息</div>
                    <div class="message-info">
                        <div class="message-time">${formatMessageTime(new Date().toISOString())}</div>
                    </div>
                `;
            }
        }
        
        function restoreMessageLocally(messageId) {
            loadPrivateMessages();
        }
        
        function updateRecalledMessage(message) {
            console.log('更新已撤回的消息:', message);
            const messageElement = document.querySelector(`.message[data-message-id="${message.id}"]`);
            if (messageElement) {
                messageElement.classList.add('recalled-message');
                messageElement.innerHTML = `
                    <div class="message-text" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">已撤回一条消息</div>
                    <div class="message-info">
                        <div class="message-time" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">${formatMessageTime(message.created_at)}</div>
                    </div>
                `;
            } else {
                console.log('消息元素不存在，重新加载消息');
                loadPrivateMessages();
            }
        }
        
        function formatMessageTime(timestamp) {
            const messageDate = new Date(timestamp);
            const dateStr = messageDate.toLocaleDateString();
            const timeStr = messageDate.toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            return `${dateStr} ${timeStr}`;
        }
        
        function processMessageContent(content) {
            const urlRegex = /(https?:\/\/[^\s]+\.(?:com|org|net|io|gov|edu|cn)(?:\/[^\s]*)?)/gi;
            const imgRegex = /(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:\?[^\s]*)?)/gi;
            
            const imgMatches = content.match(imgRegex);
            if (imgMatches && imgMatches.length === 1 && content.trim() === imgMatches[0]) {
                return `<img src="${content}" class="chat-image" onerror="this.style.display='none'" onclick="openStickerViewer(this.src)" style="cursor: pointer;" title="点击查看大图" />`;
            }
            
            let escapedText = escapeHtml(content);
            
            let result = escapedText;
            result = result.replace(imgRegex, '<img src="$1" class="chat-image" onerror="this.style.display=\'none\'" onclick="openStickerViewer(this.src)" style="cursor: pointer;" title="点击查看大图" />');
        
            result = result.replace(/(<img[^>]*>)|(https?:\/\/[^<\s]+\.(?:com|org|net|io|gov|edu|cn)(?:\/[^<\s]*)?)/gi, 
                function(match, p1, p2) {
                    if (p1) return p1; 
                    return `<a href="${p2}" target="_blank" rel="noopener noreferrer" style="color: #4a6ee0; text-decoration: underline;">${p2}</a>`;
                }
            );
            
            return result;
        }
        
        function viewImageInModal(imageUrl) {
            let imageModal = document.getElementById('imageModal');
            let modalImage = document.getElementById('modalImage');
            
            if (!imageModal) {
                imageModal = document.createElement('div');
                imageModal.id = 'imageModal';
                imageModal.style.position = 'fixed';
                imageModal.style.top = '0';
                imageModal.style.left = '0';
                imageModal.style.width = '100%';
                imageModal.style.height = '100%';
                imageModal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                imageModal.style.display = 'flex';
                imageModal.style.alignItems = 'center';
                imageModal.style.justifyContent = 'center';
                imageModal.style.zIndex = '2000';
                imageModal.style.cursor = 'default';
                imageModal.style.flexDirection = 'column';
                
                const zoomControls = document.createElement('div');
                zoomControls.style.position = 'absolute';
                zoomControls.style.top = '20px';
                zoomControls.style.right = '20px';
                zoomControls.style.display = 'flex';
                zoomControls.style.gap = '10px';
                zoomControls.style.zIndex = '2001';
                
                const zoomInButton = document.createElement('button');
                zoomInButton.id = 'zoomInButton';
                zoomInButton.textContent = '+';
                zoomInButton.style.width = 'calc(var(--btn-icon-size) * 2.5)';
                zoomInButton.style.height = 'calc(var(--btn-icon-size) * 2.5)';
                zoomInButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                zoomInButton.style.color = 'white';
                zoomInButton.style.border = 'none';
                zoomInButton.style.borderRadius = '50%';
                zoomInButton.style.fontSize = 'calc(var(--btn-icon-size) * 1.2)';
                zoomInButton.style.cursor = 'pointer';
                zoomInButton.style.display = 'flex';
                zoomInButton.style.alignItems = 'center';
                zoomInButton.style.justifyContent = 'center';
                zoomInButton.style.transition = 'background 0.3s, transform 0.2s, width 0.3s, height 0.3s';
                zoomInButton.style.userSelect = 'none';
                
                const zoomOutButton = document.createElement('button');
                zoomOutButton.id = 'zoomOutButton';
                zoomOutButton.textContent = '-';
                zoomOutButton.style.width = 'calc(var(--btn-icon-size) * 2.5)';
                zoomOutButton.style.height = 'calc(var(--btn-icon-size) * 2.5)';
                zoomOutButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                zoomOutButton.style.color = 'white';
                zoomOutButton.style.border = 'none';
                zoomOutButton.style.borderRadius = '50%';
                zoomOutButton.style.fontSize = 'calc(var(--btn-icon-size) * 1.4)';
                zoomOutButton.style.cursor = 'pointer';
                zoomOutButton.style.display = 'flex';
                zoomOutButton.style.alignItems = 'center';
                zoomOutButton.style.justifyContent = 'center';
                zoomOutButton.style.transition = 'background 0.3s, transform 0.2s, width 0.3s, height 0.3s';
                zoomOutButton.style.userSelect = 'none';
                
                const resetButton = document.createElement('button');
                resetButton.id = 'resetButton';
                resetButton.textContent = '⟲';
                resetButton.style.width = 'calc(var(--btn-icon-size) * 2.5)';
                resetButton.style.height = 'calc(var(--btn-icon-size) * 2.5)';
                resetButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                resetButton.style.color = 'white';
                resetButton.style.border = 'none';
                resetButton.style.borderRadius = '50%';
                resetButton.style.fontSize = 'calc(var(--btn-icon-size) * 1)';
                resetButton.style.cursor = 'pointer';
                resetButton.style.display = 'flex';
                resetButton.style.alignItems = 'center';
                resetButton.style.justifyContent = 'center';
                resetButton.style.transition = 'background 0.3s, transform 0.2s, width 0.3s, height 0.3s';
                resetButton.style.userSelect = 'none';
                
                zoomInButton.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                    this.style.transform = 'scale(1.05)';
                });
                zoomInButton.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    this.style.transform = 'scale(1)';
                });
                
                zoomOutButton.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                    this.style.transform = 'scale(1.05)';
                });
                zoomOutButton.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    this.style.transform = 'scale(1)';
                });
                
                resetButton.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                    this.style.transform = 'scale(1.05)';
                });
                resetButton.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    this.style.transform = 'scale(1)';
                });
                
                zoomControls.appendChild(zoomOutButton);
                zoomControls.appendChild(resetButton);
                zoomControls.appendChild(zoomInButton);
                
                modalImage = document.createElement('img');
                modalImage.id = 'modalImage';
                modalImage.style.maxWidth = '90%';
                modalImage.style.maxHeight = '80vh';
                modalImage.style.objectFit = 'contain';
                modalImage.style.transition = 'transform 0.3s ease';
                modalImage.style.cursor = 'grab';
                modalImage.style.transformOrigin = 'center center';
                
                modalImage.dataset.originalMaxWidth = '90%';
                modalImage.dataset.originalMaxHeight = '80vh';
                modalImage.dataset.currentScale = '1';
                
                const closeButton = document.createElement('div');
                closeButton.textContent = '点击空白处关闭';
                closeButton.style.color = 'white';
                closeButton.style.marginTop = '20px';
                closeButton.style.fontSize = '14px';
                closeButton.style.userSelect = 'none';
                
                imageModal.appendChild(zoomControls);
                imageModal.appendChild(modalImage);
                imageModal.appendChild(closeButton);
                document.body.appendChild(imageModal);
            
                let currentScale = 1;
                const scaleStep = 0.2;
                const minScale = 0.5;
                const maxScale = 3;
                zoomInButton.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    if (currentScale < maxScale) {
                        currentScale += scaleStep;
                        modalImage.style.transform = `scale(${currentScale})`;
                        modalImage.dataset.currentScale = currentScale;
                    }
                });
                
                zoomOutButton.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    if (currentScale > minScale) {
                        currentScale -= scaleStep;
                        modalImage.style.transform = `scale(${currentScale})`;
                        modalImage.dataset.currentScale = currentScale;
                    }
                });
                
                resetButton.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    currentScale = 1;
                    modalImage.style.transform = 'scale(1)';
                    modalImage.dataset.currentScale = currentScale;
                });
                
                imageModal.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    
                    if (e.deltaY < 0 && currentScale < maxScale) {
                        currentScale += scaleStep;
                    } else if (e.deltaY > 0 && currentScale > minScale) {
                        currentScale -= scaleStep;
                    }
                    
                    modalImage.style.transform = `scale(${currentScale})`;
                    modalImage.dataset.currentScale = currentScale;
                });
                
                let isDragging = false;
                let startX, startY;
                let translateX = 0, translateY = 0;
                
                modalImage.addEventListener('mousedown', function(e) {
                    if (currentScale > 1) { 
                        isDragging = true;
                        startX = e.clientX - translateX;
                        startY = e.clientY - translateY;
                        modalImage.style.cursor = 'grabbing';
                    }
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    
                    modalImage.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
                });
                
                document.addEventListener('mouseup', function() {
                    isDragging = false;
                    modalImage.style.cursor = 'grab';
                });
                
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal || e.target === closeButton) {
                        imageModal.style.display = 'none';
                        currentScale = 1;
                        translateX = 0;
                        translateY = 0;
                        modalImage.style.transform = 'scale(1)';
                        modalImage.dataset.currentScale = currentScale;
                    }
                });
                
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && imageModal.style.display === 'flex') {
                        imageModal.style.display = 'none';
                        currentScale = 1;
                        translateX = 0;
                        translateY = 0;
                        modalImage.style.transform = 'scale(1)';
                        modalImage.dataset.currentScale = currentScale;
                    }
                });
            }
            
            modalImage.src = imageUrl;
            imageModal.style.display = 'flex';
        }
        
        function addPrivateMessageToChat(message) {
            const existingMessage = document.querySelector(`.message[data-message-id="${message.id}"]`);
            if (existingMessage) return;
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.dataset.messageId = message.id;
            
            if (message.is_temp) {
                messageElement.classList.add('pending');
            }
            
            if (message.sender_id === currentUser.id) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }
            
            if (message.is_recalled) {
                messageElement.classList.add('recalled-message');
                messageElement.innerHTML = `
                    <div class="message-text">已撤回一条消息</div>
                    <div class="message-info">
                        <div class="message-time">${formatMessageTime(message.created_at)}</div>
                    </div>
                `;
            } else {
                const contentHtml = processMessageContent(message.content);
                
                messageElement.innerHTML = `
                    <div class="message-text">${contentHtml}</div>
                    <div class="message-info">
                        <div class="message-time" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">${formatMessageTime(message.created_at)}</div>
                    </div>
                `;
            }
            
            messageElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const messageId = this.dataset.messageId;
                const isSender = this.classList.contains('sent');
                const isRecalled = this.classList.contains('recalled-message');
                
                const menu = document.getElementById('customContextMenu');
                
                menu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.style.display = 'none';
                });
                
                if (isRecalled) {
                    const refreshItem = document.getElementById('refresh');
                    refreshItem.style.display = 'block';
                } else {
                    const copyItem = document.getElementById('copy');
                    let recallItem = document.getElementById('recall');
                    
                    copyItem.style.display = 'block';
                    copyItem.dataset.messageId = messageId;
                    copyItem.dataset.elementType = 'message';
                    
                    if (isSender) {
                    if (!recallItem) {
                        recallItem = document.createElement('div');
                        recallItem.id = 'recall';
                        recallItem.className = 'context-menu-item';
                        recallItem.textContent = '撤回消息';
                        recallItem.style.padding = '8px 16px';
                        recallItem.style.cursor = 'pointer';
                        recallItem.style.userSelect = 'none';
                        recallItem.style.transition = 'background 0.2s';
                        recallItem.style.fontSize = '0.9rem';
                        recallItem.style.color = 'var(--text-color, #333)';
                        recallItem.addEventListener('click', function() {
                            const messageId = this.dataset.messageId;
                            if (messageId) {
                                confirmRecallMessageAction(messageId);
                            }
                        });
                        
                        copyItem.parentNode.insertBefore(recallItem, copyItem.nextSibling);
                    } else {
                        recallItem.style.display = 'block';
                        recallItem.dataset.messageId = messageId;
                        recallItem.dataset.elementType = 'message';
                    }
                }
                
                let left = e.clientX;
                let top = e.clientY;
                
                if (left + menu.offsetWidth > window.innerWidth) {
                    left = window.innerWidth - menu.offsetWidth;
                }
                if (top + menu.offsetHeight > window.innerHeight) {
                    top = window.innerHeight - menu.offsetHeight;
                }
                if (top < 0) {
                    top = 0;
                }
                
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                menu.style.display = 'block';
            }});
            
            chatMessages.appendChild(messageElement);
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            if (statusDot && statusText) {
                if (connected) {
                    statusDot.classList.remove('offline');
                    statusText.textContent = '已连接到Supabase';
                } else {
                    statusDot.classList.add('offline');
                    statusText.textContent = '连接失败';
                }
            }
        }
        
        let currentCategory = "表情"; 
        let emojiCategories = {
            "表情": ["😀", "😃", "😄", "😁", "😆", "😅", "😂", "😊", "😇", "🙂", "🙃", "😉", "😌", "😍", "😘", "😗", "😙", "😚", "😋", "😛", "😝", "😜", "😎", "😏", "😒", "😞", "😔", "😟", "😕", "🙁", "☹️", "😣", "😖", "😫", "😩", "😢", "😭", "😤", "😠", "😡", "😳", "😱", "😨", "😰", "😥", "😓", "🤔", "😶", "😐", "😑", "😬", "🙄", "😯", "😦", "😧", "😮", "😲", "😴", "😪", "😵", 
                     "👋", "✋", "👌", "✌️", "🤞", "🤘", "🤙", "👈", "👉", "👆", "👇", "☝️", "👍", "👎", "✊", "👊", "👏", "🙌", "👐", "🤝", "🙏", 
                     "⌚", "📱", "💻", "⌨️", "🖥️", "🖨️", "🖱️", "💽", "💾", "💿", "📷", "🎥", "📞", "☎️", "📺", "🎙️", "⏰", "⌛", "⏳", 
                     "🐵", "🐒", "🐶", "🐱", "🦁", "🐯", "🐴", "🐮", "🐷", "🐏", "🐑", "🐘", "🐭", "🐰", "🐻", "🐼", "🐨", 
                     "🍏", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🍒", "🍑", "🍍", "🍅", "🍆", "🥒", "🌶️", "🌽", "🥕", "🥔", "🍞", "🧀", "🥚", "🍳", "🍗", "🍖", "🌭", "🍔", "🍟", "🍕", 
                     "🤐", "🤢", "🤮", "🤧", "😷", "🤒", "🤕", "🌟", "⭐", "✨", "💫", "🌙", "☀️", "🌈", "⚡", "🔥", "💧", "❄️", "💨", "🌊", "🏠", "🏡", "🏢", "🏣", "🏤", "🏥", "🏦", "🏨", "🏪", "🏫", "🏬", "🏭", "🏯", "🏰", "💒", "⛪", "🕌", "🕍", "🛕", "⛩️"],
            "颜文字": ["(๑•̀ㅂ•́)و✧", "(✧∇✧)", "(๑•̀ㅂ•́)و✧", "(≧∇≦)ﾉ", "(๑˃̵ᴗ˂̵)و", "(❁´▽`❁)", "(✧ω✧)", "(๑•̀ㅂ•́)و✧", "(≧∇≦)ﾉ", "(๑˃̵ᴗ˂̵)و", "(❁´▽`❁)", "(✧ω✧)", "(๑•̀ㅂ•́)و✧", "(≧∇≦)ﾉ", "(๑˃̵ᴗ˂̵)و", "(❁´▽`❁)", "(✧ω✧)", "(๑•̀ㅂ•́)و✧", "(≧∇≦)ﾉ", "(๑˃̵ᴗ˂̵)و", "(❁´▽`❁)", "(✧ω✧)", "(๑•̀ㅂ•́)و✧", "(≧∇≦)ﾉ", "(๑˃̵ᴗ˂̵)و", "(❁´▽`❁)", "(✧ω✧)", "(๑•̀ㅂ•́)و✧", "(≧∇≦)ﾉ", "(๑˃̵ᴗ˂̵)و"]
        };
        
        function addEmojiCategoryCSS() {
            if (!document.getElementById('emoji-category-styles')) {
                const styleElement = document.createElement('style');
                styleElement.id = 'emoji-category-styles';
                styleElement.textContent = `
                    .emoji-category-tabs {
                        display: flex;
                        align-items: center;
                        overflow-x: auto;
                        overflow-y: hidden;
                        padding: 5px 15px 5px;
                        background: var(--background-color);
                        border-bottom: 1px solid var(--border-color);
                        scrollbar-width: none;
                        -ms-overflow-style: none;
                        height: auto;
                    }
                    
                    .emoji-category-tabs::-webkit-scrollbar {
                        display: none;
                    }
                    
                    .emoji-content-container {
                        padding: 15px;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 10px;
                        max-height: 250px;
                        overflow-y: auto;
                    }
                    
                    /* 媒体查询：调整emoji容器间距 */
                    @media (max-width: 768px) {
                        .emoji-content-container {
                            gap: 8px;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .emoji-content-container {
                            gap: 6px;
                        }
                    }
                    
                    .emoji-item {
                        width: calc((100% - 50px) / 6); 
                        aspect-ratio: 1;
                        font-size: 1.5rem;
                        cursor: pointer;
                        border-radius: 12px;
                        transition: background 0.2s;
                        display: flex;
                        align-items: center;
                        background:var(--background-color);
                        color:var(--text-color);
                        justify-content: center;
                    }
                    
                    /* 媒体查询：为普通表情符号添加字体大小和布局适配 */
                    @media (max-width: 768px) {
                        .emoji-item {
                            font-size: 1.3rem;
                            width: calc((100% - 40px) / 6); 
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .emoji-item {
                            font-size: 1.1rem;
                            width: calc((100% - 30px) / 6); 
                        }
                    }
                    
                    .emoji-item.kaomoji {
                        width: calc((100% - 30px) / 3); 
                        aspect-ratio: 3.5;
                        font-size: 12px;
                        background: var(--background-color);
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        padding: 3px 8px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        color: var(--text-color);
                        line-height: 1.2;
                    }
                    
                    /* 媒体查询：在小屏幕设备上进一步调整颜文字大小 */
                    @media (max-width: 480px) {
                        .emoji-item.kaomoji {
                            font-size: 11px;
                            padding: 2px 6px;
                            aspect-ratio: 4;
                        }
                    }
                    
                    .emoji-item.kaomoji:hover {
                        background: var(--border-color);
                        border-color: var(--primary-color);
                    }
                    
                    .emoji-category-tab {
                        padding: 0px 12px;
                        margin-right: 8px;
                        background: var(--border-color);
                        border: none;
                        border-radius: 16px;
                        cursor: pointer;
                        font-size: clamp(0.8rem, 2vw, 0.9rem);
                        color: var(--primary-color);
                        white-space: nowrap;
                        transition: all 0.2s;
                        user-select: none;
                        -webkit-user-select: none;
                        -moz-user-select: none;
                        -ms-user-select: none;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        line-height: 1.2;
                        vertical-align: middle;
                        height: 20px;
                        min-height: 20px;
                    }
                    
                    .emoji-category-tab:hover {
                        background: rgba(255, 255, 255, 0.1);
                    }
                    
                    .emoji-category-tab.active {
                        background: var(--primary-color);
                        color: white;
                        padding: 0px 7px;
                        height: 20px;
                        min-height: 20px;
                    }
                    
                    @media (max-width: 768px) {
                        .emoji-category-tabs {
                            padding: 8px 12px;
                        }
                        
                        .emoji-category-tab {
                            padding: 5px 10px;
                            font-size: 0.85rem;
                            margin-right: 6px;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .emoji-category-tabs {
                            padding: 6px 10px;
                        }
                        
                        .emoji-category-tab {
                            padding: 4px 8px;
                            font-size: 0.8rem;
                            margin-right: 4px;
                        }
                    }
                `;
                document.head.appendChild(styleElement);
            }
        }
        
        function initializeEmojiPicker() {
            addEmojiCategoryCSS();
            emojiPicker.innerHTML = '';
            const categoryTabsContainer = document.createElement('div');
            categoryTabsContainer.className = 'emoji-category-tabs';
            emojiPicker.appendChild(categoryTabsContainer);
            
            const contentContainer = document.createElement('div');
            contentContainer.className = 'emoji-content-container';
            emojiPicker.appendChild(contentContainer);
            
            Object.keys(emojiCategories).forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.className = 'emoji-category-tab';
                tabButton.textContent = category;
                
                if (category === currentCategory) {
                    tabButton.classList.add('active');
                }
                
                tabButton.addEventListener('click', () => {
                    document.querySelectorAll('.emoji-category-tab').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    tabButton.classList.add('active');
                    
                    currentCategory = category;
                    renderEmojiCategory(contentContainer);
                    
                    contentContainer.scrollTop = 0;
                });
                
                categoryTabsContainer.appendChild(tabButton);
            });
            
            renderEmojiCategory(contentContainer);
        }
        
        function renderEmojiCategory(contentContainer) {
            contentContainer.innerHTML = '';
            
            const emojis = emojiCategories[currentCategory];
            
            const categoryElement = document.createElement('div');
            categoryElement.className = 'emoji-category';
            categoryElement.textContent = currentCategory;
            contentContainer.appendChild(categoryElement);
            
            emojis.forEach(emoji => {
                if (!emoji.trim()) return;
                
                const emojiElement = document.createElement('div');
                emojiElement.className = currentCategory === '颜文字' ? 'emoji-item kaomoji' : 'emoji-item';
                emojiElement.textContent = emoji;
                emojiElement.addEventListener('click', () => {
                    insertEmoji(emoji);
                    closeEmojiPicker();
                });
                contentContainer.appendChild(emojiElement);
            });
        }
        
        function toggleEmojiPicker() {
            if (!currentFriend) return;
            
            if (isEmojiPickerOpen) {
                closeEmojiPicker();
            } else {
                openEmojiPicker();
                closeStickerPicker();
            }
        }
        
        function openEmojiPicker() {
            emojiPicker.classList.add('show');
            isEmojiPickerOpen = true;
        }
        
        function closeEmojiPicker() {
            emojiPicker.classList.remove('show');
            isEmojiPickerOpen = false;
        }
        
        function toggleStickerPicker() {
            if (!currentFriend) return;
            
            if (isStickerPickerOpen) {
                closeStickerPicker();
            } else {
                openStickerPicker();
                closeEmojiPicker();
                displayDefaultStickers();
            }
        }
        
        function openStickerPicker() {
            stickerPicker.classList.add('show');
            isStickerPickerOpen = true;
        }
        
        function closeStickerPicker() {
            stickerPicker.classList.remove('show');
            isStickerPickerOpen = false;
        }
        
        async function searchStickers() {
            if (!currentFriend) return;
            
            const keyword = stickerInput.value.trim();
            
            if (!keyword) {
                displayDefaultStickers();
                return;
            }
            
            try {
                stickerResults.innerHTML = '<div class="sticker-loading">正在搜索表情包...</div>';
                
                currentStickerKeyword = keyword;
                
                loadedStickerUrls.clear();
                
                const apiUrl = `https://api.jkyai.top/API/wxbqss.php?count=100&msg=${encodeURIComponent(keyword)}`;
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.length > 0) {
                    displayStickers(data.data);
                } else {
                    stickerResults.innerHTML = '<div class="sticker-error">未找到相关表情包</div>';
                }
            } catch (error) {
                console.error('搜索表情包错误:', error);
                stickerResults.innerHTML = '<div class="sticker-error">搜索失败，请检查网络</div>';
            }
        }
        
        function displayStickers(stickerUrls) {
            if (!stickerUrls || stickerUrls.length === 0) {
                stickerResults.innerHTML = '<div class="sticker-error">未找到相关表情包</div>';
                return;
            }
            
            stickerResults.innerHTML = '';
            
            stickerUrls.forEach(url => {
                if (loadedStickerUrls.has(url)) return;
                
                loadedStickerUrls.add(url);
                const stickerItem = createStickerItem(url);
                stickerResults.appendChild(stickerItem);
            });
        }
        
        function createStickerItem(url) {
            const stickerItem = document.createElement('img');
            stickerItem.className = 'sticker-item';
            stickerItem.src = url;
            stickerItem.alt = '表情包';
            stickerItem.onerror = function() {
                this.style.display = 'none';
            };
            stickerItem.addEventListener('click', () => {
                insertSticker(url);
            });
            return stickerItem;
        }
        
        function openStickerViewer(imgUrl) {
            const avatarViewer = document.getElementById('avatarViewer');
            const avatarViewerImage = document.getElementById('avatarViewerImage');
            const imageContainer = document.querySelector('.avatar-viewer-image-container');
            
            avatarViewerImage.innerHTML = '';
            const img = document.createElement('img');
            img.src = imgUrl;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            avatarViewerImage.appendChild(img);
            
            avatarViewerImage.dataset.imageUrl = imgUrl;
            
            const screenWidth = window.innerWidth * 0.9;
            const screenHeight = window.innerHeight * 0.9;
            
            let containerWidth = img.width;
            let containerHeight = img.height;
            
            if (img.width > screenWidth) {
                const ratio = screenWidth / img.width;
                containerWidth = screenWidth;
                containerHeight = img.height * ratio;
            }
            
            if (containerHeight > screenHeight) {
                const ratio = screenHeight / containerHeight;
                containerHeight = screenHeight;
                containerWidth = containerWidth * ratio;
            }
            
            imageContainer.style.width = containerWidth + 'px';
            imageContainer.style.height = containerHeight + 'px';
            
            avatarViewerImage.style.width = containerWidth + 'px';
            avatarViewerImage.style.height = containerHeight + 'px';
            
            avatarViewer.style.display = 'flex';
            
            document.getElementById('avatarZoomInBtn').addEventListener('click', zoomInAvatar);
            document.getElementById('avatarZoomOutBtn').addEventListener('click', zoomOutAvatar);
            document.getElementById('avatarResetBtn').addEventListener('click', resetAvatarZoom);
            document.getElementById('avatarCloseBtn').addEventListener('click', closeAvatarViewer);
            document.getElementById('avatarViewerOverlay').addEventListener('click', closeAvatarViewer);
            
            avatarViewerImage.addEventListener('mousedown', startDrag, { passive: false });
            document.addEventListener('mousemove', drag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('mouseleave', endDrag); 
            document.body.style.overflow = 'hidden';
        }
        
        function displayDefaultStickers() {
            stickerResults.innerHTML = '<div class="sticker-prompt">🔍 输入关键词搜索表情包</div>';
        }
        
        function insertEmoji(emoji) {
            if (!currentFriend) return;
            
            const input = messageInput;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            const newText = text.substring(0, start) + emoji + text.substring(end);
            
            input.value = newText;
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);
        }
        
        function insertSticker(url) {
            if (!currentFriend) return;
            
            messageInput.value = url;
            sendMessage();
            closeStickerPicker();
        }
        
        function initializeLazyLoading() {
            const lazyImages = document.querySelectorAll('img[data-src]');
            
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        imageObserver.unobserve(img);
                    }
                });
            });
            
            lazyImages.forEach(img => imageObserver.observe(img));
        }
        
        function debounce(func, wait, immediate) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }
        
        let ticking = false;
        function optimizedScroll(callback) {
            if (!ticking) {
                requestAnimationFrame(() => {
                    callback();
                    ticking = false;
                });
                ticking = true;
            }
        }
        
        function preloadCriticalResources() {
        }
        
        function cleanupEventListeners() {
            window.addEventListener('beforeunload', () => {
                const elements = document.querySelectorAll('[data-event-listener]');
                elements.forEach(el => {
                    const events = JSON.parse(el.dataset.eventListener || '[]');
                    events.forEach(eventInfo => {
                        el.removeEventListener(eventInfo.type, eventInfo.handler);
                    });
                });
            });
        }
        
        function optimizeAnimations() {
            const animatedElements = document.querySelectorAll('.loading-animation, .progress-bar, .logo-animation');
            animatedElements.forEach(el => {
                el.style.willChange = 'transform, opacity';
            });
        }
        async function setupCaching() {
            try {
                if (window.location.protocol === 'file:') {
                    console.log('文件协议环境，跳过缓存设置');
                    return;
                }
                
                const cache = await caches.open('jokingchat-v1');
                const cacheUrls = [
                    './',
                    'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.5'
                ];
                
                if (window.location.protocol !== 'file:') {
                    cacheUrls.push('./auth-styles.css');
                }
                
                await cache.addAll(cacheUrls);
                console.log('资源已缓存');
            } catch (error) {
                console.warn('缓存设置失败（在文件协议中这是正常的）:', error);
            }
        }
        
        function handleNetworkChanges() {
            window.addEventListener('online', () => {
                console.log('网络已连接');
                if (supabase) {
                    initializeSupabase();
                }
            });
            
            window.addEventListener('offline', () => {
                console.log('网络已断开');
                updateConnectionStatus(false);
            });
        }
        
        function optimizeLoadingPerformance() {
            const lazyLoadResources = () => {
                const lazyImages = document.querySelectorAll('img[loading="lazy"]');
                lazyImages.forEach(img => {
                    if (img.getBoundingClientRect().top < window.innerHeight + 100) {
                        img.src = img.dataset.src || img.src;
                    }
                });
            };
            
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src || img.src;
                            observer.unobserve(img);
                        }
                    });
                });
                
                document.querySelectorAll('img[loading="lazy"]').forEach(img => {
                    observer.observe(img);
                });
            }
            window.addEventListener('scroll', debounce(lazyLoadResources, 100));
        }
        
        function optimizeInteractionResponsiveness() {
            const optimizedInputHandler = debounce((e) => {
                if (e.target === messageInput) {
                }
            }, 50);
            
            messageInput.addEventListener('input', optimizedInputHandler);
            
            document.querySelectorAll('button').forEach(btn => {
                btn.style.touchAction = 'manipulation';
            });
        }
        
        let currentZoom = 1;
        const ZOOM_STEP = 0.2;
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 3;
        
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let translateX = 0;
        let translateY = 0;
        
        function openAvatarViewer() {
            const avatarViewer = document.getElementById('avatarViewer');
            const avatarViewerImage = document.getElementById('avatarViewerImage');
            const userAvatar = document.getElementById('userAvatar');
            
            avatarViewerImage.textContent = userAvatar.textContent;
            
            avatarViewerImage.style.background = userAvatar.style.background;
            avatarViewerImage.style.backgroundImage = userAvatar.style.backgroundImage;
            avatarViewerImage.style.backgroundSize = 'contain';
            avatarViewerImage.style.backgroundPosition = 'center';
            avatarViewerImage.style.backgroundRepeat = 'no-repeat';
            
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            avatarViewerImage.classList.add('scaled');
            avatarViewerImage.style.setProperty('--current-zoom', currentZoom);
            avatarViewerImage.style.transform = `translate(-50%, -50%) scale(${currentZoom})`;
            
            const imageContainer = document.querySelector('.avatar-viewer-image-container');
            
            imageContainer.style.width = '';
            imageContainer.style.height = '';
            
            if (userAvatar.style.backgroundImage) {
                const imgUrl = userAvatar.style.backgroundImage.replace(/^url\(['"]?|['"]?\)$/g, '');
                const img = new Image();
                img.onload = function() {
                    const screenWidth = window.innerWidth * 0.9;
                    const screenHeight = window.innerHeight * 0.9;
                    
                    let containerWidth = img.width;
                    let containerHeight = img.height;
                    
                    if (img.width > screenWidth) {
                        const ratio = screenWidth / img.width;
                        containerWidth = screenWidth;
                        containerHeight = img.height * ratio;
                    }
                    
                    if (containerHeight > screenHeight) {
                        const ratio = screenHeight / containerHeight;
                        containerHeight = screenHeight;
                        containerWidth = containerWidth * ratio;
                    }
                    
                    imageContainer.style.width = containerWidth + 'px';
                    imageContainer.style.height = containerHeight + 'px';
                    
                    avatarViewerImage.style.width = containerWidth + 'px';
                    avatarViewerImage.style.height = containerHeight + 'px';
                };
                img.src = imgUrl;
            } else {
                imageContainer.style.width = '500px';
                imageContainer.style.height = '500px';
                avatarViewerImage.style.width = '500px';
                avatarViewerImage.style.height = '500px';
            }
            
            avatarViewer.style.display = 'flex';
            
            document.getElementById('avatarZoomInBtn').addEventListener('click', zoomInAvatar);
            document.getElementById('avatarZoomOutBtn').addEventListener('click', zoomOutAvatar);
            document.getElementById('avatarResetBtn').addEventListener('click', resetAvatarZoom);
            document.getElementById('avatarCloseBtn').addEventListener('click', closeAvatarViewer);
            document.getElementById('avatarViewerOverlay').addEventListener('click', closeAvatarViewer);
            
            avatarViewerImage.addEventListener('mousedown', startDrag, { passive: false });
            document.addEventListener('mousemove', drag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('mouseleave', endDrag); 
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeAvatarViewer() {
            const avatarViewer = document.getElementById('avatarViewer');
            avatarViewer.style.display = 'none';
            
            document.getElementById('avatarZoomInBtn').removeEventListener('click', zoomInAvatar);
            document.getElementById('avatarZoomOutBtn').removeEventListener('click', zoomOutAvatar);
            document.getElementById('avatarResetBtn').removeEventListener('click', resetAvatarZoom);
            document.getElementById('avatarCloseBtn').removeEventListener('click', closeAvatarViewer);
            document.getElementById('avatarViewerOverlay').removeEventListener('click', closeAvatarViewer);
            
            const avatarViewerImage = document.getElementById('avatarViewerImage');
            avatarViewerImage.removeEventListener('mousedown', startDrag);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('mouseleave', endDrag); 
            
            document.body.style.overflow = '';
            
            isDragging = false;
            translateX = 0;
            translateY = 0;
        }
        
        function zoomInAvatar() {
            if (currentZoom < MAX_ZOOM) {
                currentZoom += ZOOM_STEP;
                updateAvatarZoom();
            }
        }
        
        function zoomOutAvatar() {
            if (currentZoom > MIN_ZOOM) {
                currentZoom -= ZOOM_STEP;
                updateAvatarZoom();
            }
        }
        
        function resetAvatarZoom() {
            currentZoom = 1;
            updateAvatarZoom();
        }
        
        function updateAvatarZoom() {
            const avatarViewerImage = document.getElementById('avatarViewerImage');
            avatarViewerImage.style.setProperty('--current-zoom', currentZoom);
            
            translateX = 0;
            translateY = 0;
            avatarViewerImage.style.transform = `translate(-50%, -50%) scale(${currentZoom})`;
        }
        
        function startDrag(e) {
            if (currentZoom <= 1) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            document.body.style.cursor = 'grabbing';
        }
        
        function drag(e) {
            if (currentZoom <= 1) {
                if (isDragging) {
                    endDrag();
                }
                return;
            }
            
            if (!isDragging) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            
            const avatarViewerImage = document.getElementById('avatarViewerImage');
            avatarViewerImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
        }
        
        function endDrag() {
            isDragging = false;
            document.body.style.cursor = 'default';
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const avatarViewer = document.getElementById('avatarViewer');
                if (avatarViewer.style.display !== 'none') {
                    closeAvatarViewer();
                }
            }
        });
        
        function initializePerformanceOptimizations() {
            console.log('初始化性能优化功能...');
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    initializeLazyLoading();
                    optimizeAnimations();
                    optimizeInteractionResponsiveness();
                    handleNetworkChanges();
                    cleanupEventListeners();
                });
            } else {
                initializeLazyLoading();
                optimizeAnimations();
                optimizeInteractionResponsiveness();
                handleNetworkChanges();
                cleanupEventListeners();
            }
            
            setTimeout(() => {
                preloadCriticalResources();
                setupCaching();
                optimizeLoadingPerformance();
            }, 1000);
            
            console.log('性能优化功能初始化完成');
        }
        
        function setupPerformanceMonitoring() {
            if ('performance' in window) {
                window.addEventListener('load', () => {
                    try {
                        if ('getEntriesByType' in performance) {
                            const navigationEntries = performance.getEntriesByType('navigation');
                            if (navigationEntries && navigationEntries.length > 0) {
                                const loadTime = navigationEntries[0].loadEventEnd - navigationEntries[0].startTime;
                                console.log(`页面加载时间: ${Math.max(0, loadTime)}ms`);
                            } else {
                                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                                console.log(`页面加载时间: ${Math.max(0, loadTime)}ms`);
                            }
                        }
                    } catch (error) {
                        console.warn('计算页面加载时间时出错:', error);
                    }
                });

                try {
                    const observer = new PerformanceObserver((list) => {
                        list.getEntries().forEach((entry) => {
                            console.log(`首次内容绘制: ${entry.startTime}ms`);
                        });
                    });
                    
                    observer.observe({entryTypes: ['paint']});
                } catch (error) {
                    console.warn('设置性能观察器时出错:', error);
                }
            }
        }

        initializePerformanceOptimizations();
        setupPerformanceMonitoring();
        
        console.log('Chat应用性能优化已启用');
        
    </script>
</body>
</html>
